---
output:
  word_document:
    reference_docx: ../report_template.dotx
---


```{r setup, include=FALSE}

# =====================================================================================================
# FLYSHOOT CPUE analysis - North Sea and Channel
# 
# 11/01/2023 first coding
# 16/03/2023 full GLM modelling of top 15 species in the catch
# 21/04/2023 TO DO: convert totals to total per vessel
# 11/05/2023 Finalized the code to include the reworked Ecatch and Mcatch data 
#            and the combination of North Sea and Channel
# =====================================================================================================

knitr::opts_chunk$set(echo = FALSE,	message = FALSE,	warning = FALSE,	comment = "",	crop = TRUE )
knitr::opts_chunk$set(fig.width=10) 

options(dplyr.summarise.inform = FALSE)

# Reset lists
rm(list=ls())

recalculatemaps   <- FALSE           # recalculate catch maps (takes relatively long)
toprectanglesonly <- TRUE            # CPUE analysis for top rectangles (by species) only?

# Libraries
library(rmarkdown)                   # note: requires knitr 1.21

require(tidyverse, quietly=TRUE)     # combined package of dplyr, tidyr, ggplot, readr, purrr and tibble
require(lubridate, quietly=TRUE)     # data handling
require(reshape2, quietly=TRUE)      # reshaping data; e.g. cast
require(RColorBrewer)                # colour schemes
library(viridis)
library(pander)
library(patchwork)
library(gridExtra)

library(captioner)                   # for captions
tab_nums <- captioner::captioner(prefix = "Table " , levels=1, type=c("n"), infix=".")
fig_nums <- captioner::captioner(prefix = "Figure ", levels=1, type=c("n"), infix=".")

# Source all the utils
source("../../prf/R/my utils.r")
source("../../mptools/R/get_onedrive.r")
source("../R/FLYSHOOT utils.r")


spatialdir <- "C:/DATA/RDATA"

# spatial data files

load(file.path(spatialdir, "world_lr_sf.RData"))
load(file.path(spatialdir, "world_mr_sf.RData"))
load(file.path(spatialdir, "world_hr_sf.RData"))

load(file.path(spatialdir, "world_mr_df.RData"))
load(file.path(spatialdir, "fao_sf.RData"))
load(file.path(spatialdir, "rect_lr_sf.RData"))
icesrect <-
  rect_lr_sf %>% 
  sf::st_drop_geometry() %>% 
  rename(rect=ICESNAME) %>% 
  mutate(lat = (SOUTH + NORTH)/2) %>% 
  mutate(lon = (EAST + WEST)/2) %>% 
  dplyr::select(rect, lat, lon)


asfis <- 
  loadRData(file.path(spatialdir, "asfis.RData")) %>% 
  rename_all(tolower) %>% 
  mutate(species = tolower(species))

# ===============================================================================
#  Load and filter the trip data
# ===============================================================================

# set onedrive directory
onedrive <- get_onedrive(team="Martin Pastoors", site="FLYSHOOT - General")

# load datasets
haul   <- loadRData(file.path(onedrive, "rdata/haul.RData"))
kisten <- loadRData(file.path(onedrive, "rdata/kisten.RData")) 
elog   <- 
  loadRData(file.path(onedrive, "rdata/elog.RData")) %>% 
  mutate(species = toupper(species)) %>% 
  mutate(species = ifelse(species == "JAX","HOM",species)) %>% 
  mutate(species = ifelse(species == "SQU", "SQR", species)) %>% 
  filter(geartype %in% c("SSC","SDN")) %>% 
  mutate(species = tolower(species)) %>% 
  left_join(dplyr::select(asfis,
                          species, scientificname, englishname, dutchname),
            by = "species") %>% 
  mutate(species = toupper(species))  %>% 
  
  # remove 348 records without rectangle information
  drop_na(rect) %>% 
  
  sf::st_as_sf(coords = c("lon", "lat"), crs = 4326, remove = FALSE)  %>%  
  
  # get division from rectangle / lat-lon if available
  sf::st_join(filter(fao_sf, F_LEVEL=="DIVISION")) %>%
  sf::st_drop_geometry() %>% 
  rename(division = F_CODE) %>% 
  dplyr::select(-F_LEVEL, -FID, -OCEAN, -SUBOCEAN, -F_AREA, -F_SUBAREA, -F_DIVISION,
                -F_SUBDIVIS, -F_SUBUNIT, -F_STATUS) %>%
  ungroup() %>% 
  
  # handle missing divisions (coastline issues)
  mutate(division = ifelse(is.na(division) & !is.na(faozone), faozone, division))

# elog %>% filter(!is.na(lat.x)) %>% View()
# xlim <- range(elog$lon, na.rm=TRUE)
# ylim <- range(elog$lat, na.rm=TRUE)  
# elog %>% 
#   filter(is.na(division)) %>% 
#   group_by(vessel, year, source, rect, lat, lon) %>% 
#   summarise(weight = sum(weight, na.rm=TRUE)) %>% 
#   ggplot(aes(x=lon, y=lat)) +
#   theme_publication() +
#   coord_quickmap(xlim=xlim , ylim=ylim) +
#   geom_polygon(data=world_mr_df, aes(x=long, y=lat, group=group), fill = "grey75") +
#   geom_point(aes(colour=vessel, size=weight), alpha=0.5) +
#   facet_wrap(~year)

  
price  <- 
  readr::read_rds(file.path(onedrive, "rdata/prices.rds")) %>% 
  dplyr::select(year, species, avgprice) %>% 
  mutate(price_cat = cut(avgprice, breaks=c(0,0.5, 1,2,3,4,5,10,15,20), dig.lab=10 ))

regulated  <- 
  readr::read_rds(file.path(onedrive, "rdata/prices.rds")) %>% 
  ungroup() %>% 
  dplyr::distinct(species, regulated) 

# skimr::skim(price)

# sort(unique(elog$species))

yrs       <- 2012:2022
mnths     <- NA
vessels   <- NA

# divisions <- NA
# divisions <- c("27.7.d", "27.7.e")
# divisions <- c("27.4.b", "27.4.c")
divisions <- c("27.4.b", "27.4.c", "27.7.d", "27.7.e")

# Folder for storing figures  
if(!any(is.na(divisions))) {
  folder <- paste("CPUE", paste(divisions, collapse="-")) 
} else {
  folder <- "CPUE northsea-channel"
}

dir.create   (file.path(onedrive, "report",folder), showWarnings = FALSE)

dir.create   (file.path(onedrive, "report",folder, "figures"), showWarnings = FALSE)
figuresdir <- file.path(onedrive, "report",folder, "figures")

dir.create  (file.path(onedrive, "report",folder, "tables"), showWarnings = FALSE)
tablesdir <- file.path(onedrive, "report",folder, "tables")

dir.create   (file.path(onedrive, "report",folder, "data"), showWarnings = FALSE)
datadir    <- file.path(onedrive, "report",folder, "data")

# making the data selections
e <- 
  elog %>%
  ungroup() %>% 
  mutate(division =tolower(division)) %>% 
  {if(!is.na(all(vessels))) filter(., vessel %in% vessels) else . } %>% 
  {if(!is.na(all(yrs)))     filter(., year %in% yrs) else . } %>% 
  {if(!is.na(all(mnths)))   filter(., month %in% mnths) else .} %>% 
  {if(!any(is.na(divisions))) filter(., division %in% divisions) else .} %>% 
  
  left_join(regulated, by="species") %>% 
  mutate(regulated = case_when(
    is.na(regulated) & species %in% c("BSE","DGX","ANF","DGH","HER","PLE")             ~ "R",
    is.na(regulated) & species %in% c("BRB","SBX","SQS","WEX","WEG","SQU","SDV",
                                      "OCT","MUL","SCR","GAG","ANE","SQE","SQC","OCZ") ~ "NR",
    TRUE ~ regulated
  )) %>% 
  ungroup()

# e %>% distinct(species, regulated) %>% filter(is.na(regulated)) %>% View()
# e %>% 
#   filter(vessel=="SCH135", week==1:3, year==2019) %>%  
#   group_by(vessel, year, week, source) %>% 
#   summarise(n=n_distinct(source)) %>% 
#   filter(n > 1) %>%
#   View()
#   # left_join(e, by=c("vessel","year","week")) %>% 
#   group_by(vessel, year, week, source) %>% 
#   summarise(weight = sum(weight, na.rm=TRUE)) %>% 
#   pivot_wider(names_from = source, values_from = weight) %>% 
#   View()


# calculate the scaling of plots

xmin <- floor(2 * (min(e$lon, na.rm=TRUE)-0.5))/2;
xmax <- ceiling(2 * (max(e$lon, na.rm=TRUE)+0.5))/2;
ymin <- floor(2 * (min(e$lat, na.rm=TRUE)-0.5))/2;
ymax <- ceiling(2* (max(e$lat, na.rm=TRUE)+0.5))/2

n <- 15

effort <-
  e %>% 
  dplyr::group_by(vessel, year, week, source) %>% 
  dplyr::summarize(ndays = n_distinct(date)) %>% 
  
  dplyr::group_by(vessel, year) %>% 
  dplyr::summarize(ndays  = sum(ndays, na.rm=TRUE))  %>% 

  ungroup()

catch <-
  e %>% 
  dplyr::group_by(vessel, year, species, 
                  scientificname, englishname, dutchname, regulated) %>% 
  dplyr::summarize(weight = sum(weight, na.rm=TRUE)) %>% 
  dplyr::group_by(vessel, year) %>% 
  dplyr::mutate(perc = weight/sum(weight, na.rm=TRUE)) %>% 
  left_join(effort, by=c("vessel", "year")) %>% 
  mutate(catch_day = weight / ndays) %>% 
  ungroup()

effort_byweek <-
  e %>% 
  dplyr::group_by(vessel, year, quarter, month, week, division, rect, source) %>% 
  dplyr::summarize(effort  = n_distinct(date))  %>% 
  
  # temp fix!!
  mutate(effort = ifelse(source=="m-catch" & year < 2023, 4, effort)) %>% 
  dplyr::group_by(vessel, year, quarter, month, week, division, rect) %>% 
  dplyr::summarize(effort  = sum(effort, na.rm=TRUE))  %>% 
  ungroup()

effort_byweek2 <-
  e %>% 
  dplyr::group_by(vessel, year, week, source) %>% 
  dplyr::summarize(effort  = n_distinct(date))  %>% 
  
  # temp fix!!
  mutate(effort = ifelse(source=="m-catch" & year < 2023, NA, effort)) %>% 
  dplyr::group_by(vessel, year, week) %>% 
  dplyr::summarize(effort  = sum(effort, na.rm=TRUE))  %>% 

  ungroup()

revenue_byweek <-
  e %>% 
  left_join(price, by=c("year","species")) %>% 
  mutate(revenue = weight * avgprice) %>% 
  drop_na(revenue) %>% 
  group_by(vessel, year, week, species) %>% 
  summarise(revenue = sum(revenue, na.rm=TRUE)) %>% 
  ungroup()
    
target_byweek <-
  revenue_byweek %>% 
  group_by(vessel, year, week) %>% 
  arrange(desc(revenue)) %>% 
  slice_head(n=1) %>% 
  dplyr::select(-revenue) %>% 
  rename(target=species)

catch_byweek <-
  e %>% 
  dplyr::group_by(vessel, year, quarter, month, week, division, rect,  
                  species, scientificname, englishname, dutchname, regulated) %>% 
  dplyr::summarize(
    catch = sum(weight, na.rm=TRUE),
    # effort  = n_distinct(date)
  ) %>% 
  left_join(effort_byweek, by=c("vessel","year","quarter","month","week","division","rect")) %>% 
  left_join(icesrect, by="rect") %>% 
  left_join(price, by=c("year","species")) %>% 
  left_join(target_byweek, by=c("vessel", "year","week")) %>% 
  
  ungroup() 
  

# catch_byweek %>% distinct(species, regulated) %>% filter(is.na(regulated)) %>% View()

top_rectangles <-
  catch_byweek %>%
  group_by(species, rect) %>% 
  summarise(n=n()) %>% 
  group_by(species) %>% 
  arrange(species, desc(n)) %>% 
  filter(n >= 20,  row_number() <= 10)

# top <-
#   catch %>% 
#   dplyr::group_by(species, scientificname, englishname, dutchname) %>% 
#   dplyr::summarize(weight = sum(weight, na.rm=TRUE)) %>% 
#   dplyr::ungroup() %>% 
#   dplyr::mutate(englishspecies = paste(englishname, species)) %>% 
#   arrange(desc(weight)) %>% 
#   slice_head(n=n)

top      <- 
  readr::read_rds(file=file.path(onedrive,"rdata", "top.rds")) %>%  
  lowcase() %>% 
  dplyr::select(-value, -weight)

rest <-
  catch %>% 
  dplyr::group_by(species, scientificname, englishname, dutchname) %>% 
  dplyr::summarize(weight     = sum(weight, na.rm=TRUE)) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(englishspecies = paste(englishname, species)) %>% 
  arrange(desc(weight)) %>% 
  filter(species %notin% top$species)

all <- 
  bind_rows(top, rest, data.frame(englishspecies="Other")) %>% 
  mutate(englishspecies = factor(englishspecies, levels=.$englishspecies))

# top colours
colourCount             <- nrow(top)+1
getPalette              <- colorRampPalette(brewer.pal(12, "Paired"))
myTopColors             <- getPalette(colourCount)
names(myTopColors)      <- c(top$englishspecies, "Other")

# scales::show_col(myTopColors)

# target colours
t1 <- 
  target_byweek %>% 
  ungroup() %>% 
  distinct(target) %>% 
  left_join(bind_rows(top, rest), by=c("target"="species")) %>% 
  arrange(desc(weight)) %>% 
  left_join(as.data.frame(myTopColors) %>% rownames_to_column(var="englishspecies"), 
            by="englishspecies")

t2a <- t1 %>% filter(!is.na(myTopColors))
t2b <- t1 %>% filter(is.na(myTopColors))

colourCount             <- nrow(t2b)
getPalette              <- colorRampPalette(myTopColors[c(length(myTopColors)-1,length(myTopColors))])
myAddedColors           <- getPalette(colourCount)
names(myAddedColors)    <- c(t2b$englishspecies)

myTargetColors          <- c(myTopColors, myAddedColors)
# scales::show_col(myTargetColors)

# readr::write_rds(top, file=file.path(datadir, paste0("top_",folder,".rds")))
# writexl::write_xlsx(catch_byweek, path=file.path(onedrive, paste0("export",folder,".xlsx")))

```


# CPUE analysis of the Jaczon flyshoot fishery in the Channel and North Sea

M.A. Pastoors

Date: `r format(Sys.time(), '%d/%m/%Y')`

&nbsp;

&nbsp;

For: 

Jaczon BV

Eric van Linden en Anton Dekker

Vissershavenweg 35

2583 DK  Den Haag

&nbsp;

&nbsp;

```{r, echo=FALSE, out.width = "200px", fig.align="left", message=FALSE, warning=FALSE, cache=FALSE}

  knitr::include_graphics("../MPFF logo with text.png")

```
\newpage


Please cite as:

Pastoors, M.A. (2023) CPUE analysis of the Jaczon flyshoot fishery in the Channel and North Sea. MPFF report 2023/02, published 11/5/2023

\newpage

**Executive summary**

The objective of this work was to analyse the electronic logbook data of the Jaczon Flyshoot vessel for trends in spatial and temporal dynamics. The electronic logbook data for the years 2012-2022 has been compiled. The data contains information on catch and effort per vessel, rectangle, species and day. Average price information by vessel and year has been used to convert landings to revenue. The data was available for the vessels SCH65, SL9, SCH135, Z99 and years 2012-2022. For the years 2012-2016, data was only available for two vessels (SCH65 and SL9). From 2017 onwards, data became available for the SCH135 and the Z99 was added in 2022. The data coverage is not complete. The year 2012 is only covered for part of the year and the data for 2015-2017 is also incomplete for some vessels. 

For each year, the proportion of weeks targeting a certain species was calculated. The target species of a vessel-year-week combination was derived by determining the species with the highest revenue for each vessel-year-week combination. Then the number of vessel-year-week-target combinations were counted and expresses as percentages per year and species. European Squid (SQR), Surmullet (MUR) and mackerel (MAC) have been the main target species during the period considered, with Cuttlefish (CTC) increasing in importance from 2018 onwards. The number of Tub gurnard targeted weeks has declined over time.

The analytical approach to estimating catch rates (Catch per Unit of Effort CPUE) was initiated by transforming all the catch (=landing) data to the total landings per vessel, per species, per rectangle and per week. In addition we counted the number of fishing days per vessel, per rectangle and per week. Catch rate is then expressed as the catch divided by effort. Modelling was based on Generalized Linear Model (GLM) tools, whereby the predicted variable is the catch per week, effort was included as a log-link function and year as used as the main factor to describe the time trend. Then we explored other potential explanatory factors (vessel, latitude, longitude, rectangle, quarter and target species) by sequentially adding different factors. We explored the AIC criteria for the different factors for each of the species and selected those factors by species that had the lowest AIC. Then we repeated this process for the second and third explanatory factor. In all cases we evaluated whether the factor contributed significantly (<5%) to the model.

The standardized CPUE for the different species, taking into account the significant factors per species, differ substantially from the raw CPUE. For the  main target species in the overall flyshoot fishery, catch rates for European squid and Surmullet have decreased in the recent period whereas the catch rates for mackerel and Common cuttlefish have increased. For several species, we can observe a general decline in catch rates. Those species are mostly non-target species for the flyshoot fishery.

The observed vs. predicted catch rates are a diagnostic to assess how well the GLM model is fitting to the data. Ideally, one would expect the values to be close to the 1:1 line (blue dotted line). The explained deviance (blue text) describes the proportion of the deviance that is explained by the model. The four main target species (SQR, MUR, CTC, MAC) have explained deviances of 51, 39, 66 and 39% respectively. This indicates that the GLM models can provide some explanation of the variance in the data.

For several species, we observe some overprediction of catch rates at lower values, for example, for red mullet (surmullet MUR), mackerel and horse mackerel. It is not well understood what drivers lead to these patterns.

Overall, the patterns observed in CPUE for the species shown, **make it difficult to interpret the CPUE as indicator of abundance**, because the targeting behaviour and the quota limitations may affect the catch rates in different ways in different years.

However, the information from the logbooks does provide usable information on the spatial distribution of the fishery and the catches by species. For example, the spatial distribution of cuttlefish catches are quite distinct from most other species, thereby indicating that the CPUE for cuttlefish may a very different from other species. 

An important consideration for the overall analysis, is that the logbook information only contains data on the landed catch. This is in fact a severe limitation on the possibility to interpret the results as indicators of abundance because an unknown part of the catch may not have been landed. 

\newpage

# Introduction

The objective of this work is to analyse the electronic logbook data of the Jaczon Flyshoot vessels for trends in spatial and temporal dynamics for the different target species. The electronic logbook data contains total landings by day, by species and by ICES rectangle. For the current analysis, only the data for divisions 27.7.d and 27.7.e have been used. 

Electronic logbook data is a requirement from fisheries authorities to document the composition of the landings. While this information is officially reported to the respective government, the information is also kept on the fishing vessels and stored in the electronic logbook systems. During the period 2012 - 2022, electronic logbook data was initially stored in the OLRAC software, later into versions 2.0 and 3.3 of E-Catch and from 2018 onwards in the PEFA software and M-Catch software. The old data, prior to 2018, has been retrieved from backups held on the vessels and were converted into usable formats using dedicated R-codes (https://github.com/martinpastoors/flyshoot/R/read_olrac.r and https://github.com/martinpastoors/flyshoot/R/read_ecatch.r ). The data from 2018 onwards could be exported from the current electronic logbook systems and have been added to the internal database.  

Average price information per species was available from all landings of Jaczon flyshoot vessels during the years 2012-2022. We derived the top species for the flyshoot fishery (in the Channel and the North Sea) by calculating the value of the catch per species over the whole period from the multiplication of catch by year with the average price per year. We then selected the 15 species with the highest overall value.  

The approach to estimating catch rates (Catch per Unit of Effort, or CPUE) was initiated by transforming all the catch (=landing) data to the total landings per vessel, per species, per rectangle and per week. In addition we counted the number of fishing days per vessel, per rectangle and per week. Catch rate is then expressed as the catch divided by effort. 
Modelling was based on Generalized Linear Model (GLM) tools, whereby the predicted variable is the catch per week, effort was included as a log-link function and year as used as the main factor to describe the time trend. Then we explored other potential explanatory factors by sequentially adding different factors. We explored the AIC criteria for the different factors for each of the species and selected those factors by species that had the lowest AIC. Then we repeated this process for the second and third explanatory factor. In all cases we evaluated whether the factor had a statistically significant (<5%) contribution to the model. 

It is well known that modelling fisheries catch rates could provide biased estimates because it only refers to landings and because it does not address technological developments in the fishery. Unfortunately, total catch per species is currently not available, so the CPUE trends can only be based on landings per effort. Technological creep could in principle be included, but given the relatively short time-series and the lack of total catches, it was considered to be of minor importance to include efficiency creep. 

\newpage

# Material and methods

Electronic logbook data was available for the vessels `r paste(unique(e$vessel), collapse=", ")` and years  `r paste(c(min(yrs), max(yrs)), collapse="-")`. For the years 2012-2016, data was only available for two vessels (SCH65 and SL9), from 2017 onwards, data became available for the SCH135 and the Z99 was added in 2022. 

**Fishing effort by vessel**

The number of fishing days by vessel and year (top), and by vessel, year and quarter (bottom) demonstrates that the data coverage is not complete. The year 2012 is only covered from the middel of the year and the data for 2015-2017 is also incomplete for one vessel. From 2018 onwards, the effort data covers around 700-800 fishing days per year.  

```{r effort1, echo=FALSE, message=FALSE, warning=FALSE, comment=NA, fig.asp=1.0}

fig_nums(
  name    = "effort1", 
  level = 1, display = FALSE,
  caption = "Total number of fishing days per vessel and year (top) and by vessel, year and quarter (bottom)")


# by year
p1 <-
  effort %>% 
  ggplot(aes(x=year, y=ndays)) +
  theme_publication() +
  theme(plot.margin = margin(2,2,2,5, "mm")) +
  theme(legend.position = "none") +
  geom_bar(aes(fill=vessel), stat="identity") + 
  scale_fill_brewer(palette = "Paired") +
  ylab(NULL) +
  scale_x_continuous(breaks=seq(min(effort$year), max(effort$year),1))

# by quarter
p2 <-
  e %>% 
  group_by(vessel, year, quarter) %>% 
  summarize(ndays = n_distinct(paste(vessel, date))) %>% 

  ggplot(aes(x=quarter, y=ndays)) +
  theme_publication() +
  theme(plot.margin = margin(2,2,2,5, "mm")) +
  geom_bar(aes(fill=vessel), stat="identity") + 
  scale_fill_brewer(palette = "Paired") +
  scale_x_continuous(breaks=seq(1,12,1)) +
  ylab(NULL) +
  facet_grid(vessel~year)

# Combine the plots
gridExtra::grid.arrange(p1, p2, left = "Effort (days)", ncol=1, heights=c(10,20)) 

```

_`r fig_nums("effort1")`_

\newpage

**Number of fishing days per week**

To check the consistency of the effort data, we calculated the average number of fishing days per week from the different elog sources. Within the flyshoot fishery, there can be different patterns in the number of fishing days per week, depending on the number of crews per vessel and the preferences of the crews. Generally, the number of fishing days per week will be around 4, except when multiple crews are being used, which results in more fishing days per week. 

```{r effort0, echo=FALSE, message=FALSE, warning=FALSE, comment=NA, fig.asp=0.8}

fig_nums(
  name    = "effort0", 
  level = 1, display = FALSE,
  caption = "Average number of fishing days per week (from available elog source) by vessel and year. The size of the points reflect the number of weeks that data is available for.")

# by year
e %>% 
  dplyr::group_by(vessel, year, week, source) %>% 
  dplyr::summarize(ndays = n_distinct(date)) %>% 

  dplyr::group_by(vessel, year, source) %>%
  dplyr::summarise(
    ndays = mean(ndays, na.rm=TRUE),
    nweeks = n_distinct(week)
  ) %>% 
  mutate(source = factor(source, levels=c("olrac","ecatch","mcatch","pefa"))) %>% 
  
  ggplot(aes(x=as.character(year), y=ndays, group=source)) +
  theme_publication() +
  theme(plot.margin = margin(2,2,2,5, "mm")) +
  # theme(legend.position = "none") +
  
  # geom_bar(aes(fill=source), stat="identity", position=position_dodge2(preserve="single", width=0.9)) + 
  geom_point(aes(colour=source, size=nweeks)) +
  geom_path(aes(colour=source), linewidth=0.5) +
  scale_fill_brewer(palette = "Paired") +
  scale_y_continuous(limits=c(0,7), breaks=seq(0,7,1)) +
  labs(y="fishing days per week", x="", title="Number of fishing days per week", colour="source") +
  scale_colour_brewer(palette = "Paired") +
  # scale_x_continuous(breaks=yrs) +
  facet_grid(vessel~.)


```

_`r fig_nums("effort0")`_

\newpage

**Total landings by vessel and year**

From the electronic logbook data, landings by species and vessel can be derived. It should be noted that there is no data available on the total catches, because the logbooks only contain the landed catch. The landings per vessel, show the same gaps in coverage as shown for the effort data. Landings have generally been between 1500 and 2000 tonnes.  

```{r catch1, echo=FALSE, message=FALSE, warning=FALSE, comment=NA, fig.asp=1.2}

fig_nums(
  name    = "catch1", 
  level = 1, display = FALSE,
  caption = "Total landings (tonnes) per vessel and year (top) and by vessel, year and quarter (bottom)")

my_colors <- RColorBrewer::brewer.pal(12, "Paired")[5:8]

# by year
p1 <-
  catch_byweek %>% 
  group_by(vessel, year) %>% 
  summarise(catch = sum(catch, na.rm=TRUE)) %>% 
  mutate(catch = catch/1000) %>% 
  
  ggplot(aes(x=year, y=catch)) +
  theme_publication() +
  theme(legend.position = "none") +
  theme(plot.margin = margin(2,2,2,5, "mm")) +
  geom_bar(aes(fill=vessel), stat="identity") + 
  scale_fill_manual(values = my_colors) +
  ylab(NULL) +
  scale_x_continuous(breaks=seq(min(effort$year), max(effort$year),1))

# by quarter
p2 <-
  catch_byweek %>% 
  group_by(vessel, year, quarter) %>% 
  summarise(catch = sum(catch, na.rm=TRUE)) %>% 
  mutate(catch = catch/1000) %>% 

  ggplot(aes(x=quarter, y=catch)) +
  theme_publication() +
  theme(plot.margin = margin(2,2,2,5, "mm")) +
  # theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  geom_bar(aes(fill=vessel), stat="identity") + 
  scale_fill_manual(values = my_colors) +
  scale_x_continuous(breaks=seq(1,4,1)) +
  ylab(NULL) +
  facet_grid(vessel~year)

gridExtra::grid.arrange(p1, p2, left = "Landings (tonnes)", ncol=1, heights=c(10,20)) 

```

_`r fig_nums("catch1")`_

\newpage

**Total landings by species and year**

The top `r n` species in the overall flyshoot landings are shown in the figure below, together with a mixed grouping of species (OTHER). The proportions of the landings by species, show some clear patterns in targeting of certain species over certain years, for example the increase in proportions of squid, surmullet and cuttlefish over time. 
 
```{r catch3a, echo=FALSE, message=FALSE, warning=FALSE, comment=NA, fig.asp=0.6}

fig_nums(
  name    = "catch3a", 
  level = 1, display = FALSE,
  caption = paste0("Total landings per species and year (top ",n," species)"))

t <-
  catch_byweek %>% 
  mutate(englishspecies = paste(englishname, species)) %>% 
  mutate(englishspecies = ifelse(species %notin% top$species, "Other", englishspecies)) %>% 
  mutate(englishspecies = factor(englishspecies, 
                                  levels=c("Other", rev(top$englishspecies)))) %>% 
  group_by(englishspecies, year) %>% 
  summarise(catch = sum(catch, na.rm=TRUE)) %>% 
  mutate(catch = catch/1000) 
  
colourCount = n+1
getPalette = colorRampPalette(rev(brewer.pal(12, "Paired")))

p1 <-
  t %>% 
  # filter(regulated == "NR") %>% 
  ggplot(aes(x=year, y=catch)) +
  theme_publication() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  theme(plot.margin = margin(1,1,1,1, "mm")) +
  theme(plot.title = element_text(hjust = 0.0)) +
  geom_bar(aes(fill=englishspecies), stat="identity") + 
  
  scale_fill_manual(values = myTopColors) +
  # scale_fill_manual(values = getPalette(colourCount)) +
  guides(fill = guide_legend(order = 2)) +
  scale_x_continuous(breaks=seq(min(catch_byweek$year), max(catch_byweek$year),1)) +
  labs(y="Landings (tonnes)", title="Landings by species", x="",fill="") 

p2 <-
  t %>% 
  # filter(regulated == "NR") %>% 
  ggplot(aes(x=year, y=catch)) +
  theme_publication() +
  theme(legend.position = "right", legend.direction="vertical") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  theme(plot.margin = margin(1,1,1,1, "mm")) +
  theme(plot.title = element_text(hjust = 0.0)) +
  # geom_bar(aes(fill=englishspecies), stat="identity") + 
  geom_bar(aes(fill=englishspecies), stat="identity", position=position_fill()) + 
  
  scale_fill_manual(values = myTopColors) +
  # scale_fill_manual(values = getPalette(colourCount)) +
  guides(fill = guide_legend(order = 2)) +
  scale_x_continuous(breaks=seq(min(catch_byweek$year), max(catch_byweek$year),1)) +
  scale_y_continuous(labels=scales::percent) +
  labs(y="", title="Proportions of landings by species", x="",fill="") 

print( p1 +  p2   + plot_layout(widths = c(11, 11) ))

png(filename=file.path(figuresdir, "landings by species.png"),
     width=12.5, height=5.5, units="in", res=300, bg="transparent")
print( p1 +  p2   + 
         plot_layout(widths = c(11, 11) ) + 
         theme(plot.background = element_blank()) +
         theme(panel.background = element_blank())) 
invisible(dev.off())

```

_`r fig_nums("catch3a")`_

\newpage

**Proportion of the landings per species and quarter (top 15 species)**

There are large differences in the proportions of species per quarter due to different availability and targeting. 

```{r catch4, echo=FALSE, message=FALSE, warning=FALSE, comment=NA, fig.asp=0.6}

fig_nums(
  name    = "catch4", 
  level = 1, display = FALSE,
  caption = "Proportion of the catch per quarter and year (top 15 species)")

# colourCount = n+1
# getPalette = colorRampPalette(rev(brewer.pal(12, "Paired")))

t <-
  catch_byweek %>% 
  mutate(englishspecies = paste(englishname, species)) %>% 
  mutate(englishspecies = ifelse(species %notin% top$species, "Other", englishspecies)) %>% 
  mutate(englishspecies = factor(englishspecies, 
                                  levels=c("Other", rev(top$englishspecies)))) %>% 
  mutate(englishspecies = factor(englishspecies, 
                                  levels=c("Other", rev(top$englishspecies)))) %>% 
  group_by(englishspecies, year, quarter) %>% 
  summarise(catch = sum(catch, na.rm=TRUE)) %>% 
  mutate(catch = catch/1000) %>% 
  group_by(year, quarter) %>% 
  mutate(prop = catch/sum(catch)) %>% 
  ungroup()

t %>% 
  ggplot(aes(x=quarter, y=prop)) +
  theme_publication() +
  theme(plot.margin = margin(1,1,1,1, "mm")) +
  theme(legend.position = "right", legend.direction="vertical") +
  geom_bar(aes(fill=englishspecies), stat="identity") + 
  scale_fill_manual(values = myTopColors) +
  # scale_fill_manual(values = getPalette(colourCount)) +
  guides(fill = guide_legend(order = 2)) +
  scale_x_continuous(breaks=seq(1,4,1)) +
  ylab(NULL) +
  facet_wrap(~year, nrow=1)


```

_`r fig_nums("catch4")`_

\newpage

**Total revenue by species and year**

The total revenue by species and year was calculated from the landed catch multiplied by the average price per species and year. The value of the top `r n` species in the landings (and an OTHER category), are shown below, both in kEuro and in proportions. From 2016 onwards, over 75% of the value is generated from four species (SQR, MUR, MAC, CTC).
 
```{r catch3b, echo=FALSE, message=FALSE, warning=FALSE, comment=NA, fig.asp=0.6}

fig_nums(
  name    = "catch3b", 
  level = 1, display = FALSE,
  caption = paste0("Total revenue per species and year (top ",n," species)"))

t <-
  catch_byweek %>% 
  mutate(englishspecies = paste(englishname, species)) %>% 
  mutate(englishspecies = ifelse(species %notin% top$species, "Other", englishspecies)) %>% 
  mutate(englishspecies = factor(englishspecies, 
                                  levels=c("Other", rev(top$englishspecies)))) %>% 
  mutate(revenue = catch * avgprice) %>% 
  group_by(englishspecies, year) %>% 
  summarise(revenue = sum(revenue, na.rm=TRUE)) %>% 
  mutate(revenue = revenue/1000) 
  
# colourCount = n+1
# getPalette = colorRampPalette(rev(brewer.pal(12, "Paired")))

p1 <-
  t %>% 
  # filter(regulated == "NR") %>% 
  ggplot(aes(x=year, y=revenue)) +
  theme_publication() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  theme(plot.margin = margin(1,1,1,1, "mm")) +
  theme(plot.title = element_text(hjust = 0.0)) +
  geom_bar(aes(fill=englishspecies), stat="identity") + 
  
  scale_fill_manual(values = myTopColors) +
  # scale_fill_manual(values = getPalette(colourCount)) +
  guides(fill = guide_legend(order = 2)) +
  scale_x_continuous(breaks=seq(min(catch_byweek$year), max(catch_byweek$year),1)) +
  labs(y="Revenue (kEuro)", title="Revenue by species", x="",fill="") 

p2 <-
  t %>% 
  # filter(regulated == "NR") %>% 
  ggplot(aes(x=year, y=revenue)) +
  theme_publication() +
  theme(legend.position = "right", legend.direction="vertical") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  theme(plot.margin = margin(1,1,1,1, "mm")) +
  theme(plot.title = element_text(hjust = 0.0)) +
  # geom_bar(aes(fill=englishspecies), stat="identity") + 
  geom_bar(aes(fill=englishspecies), stat="identity", position=position_fill()) + 
  
  scale_fill_manual(values = myTopColors) +
  # scale_fill_manual(values = getPalette(colourCount)) +
  guides(fill = guide_legend(order = 2)) +
  scale_x_continuous(breaks=seq(min(catch_byweek$year), max(catch_byweek$year),1)) +
  scale_y_continuous(labels=scales::percent) +
  labs(y="", title="Proportions of revenue by species", x="",fill="") 

print( p1 +  p2   + plot_layout(widths = c(10, 11) ))

png(filename=file.path(figuresdir, "revenue by species.png"),
     width=12.5, height=5.5, units="in", res=300, bg="transparent")
print( p1 +  p2   + 
         plot_layout(widths = c(11, 11) ) + 
         theme(plot.background = element_blank()) +
         theme(panel.background = element_blank())) 
invisible(dev.off())

```

_`r fig_nums("catch3b")`_

\newpage

**Percentage of weeks targeting certain species**

For each year, the proportion of weeks targeting a certain species was calculated. The target species of a vessel-year-week combination was derived by determining the species with the highest revenue for each vessel-year-week combination. Then the number of vessel-year-week-target combinations were counted and expresses as percentages per year and species. European Squid (SQR), Surmullet (MUR) and mackerel (MAC) have been the main target species during the period considered, with Cuttlefish (CTC) increasing in importance from 2018 onwards. The number of Tub gurnard targeted weeks has declined over time. 


```{r catch5, echo=FALSE, message=FALSE, warning=FALSE, comment=NA, fig.asp=0.6}

fig_nums(
  name    = "catch5", 
  level = 1, display = FALSE,
  caption = "Number of weeks targeting certain species (highest value in the catch)")


t <-
  catch_byweek %>% 
  ungroup() %>% 
  distinct(vessel, year, week, target) %>%
  group_by(year, target) %>% 
  summarise(n=n()) %>% 
  group_by(year) %>%
  mutate(prop = n/sum(n, na.rm=TRUE)) %>% 
  left_join(bind_rows(top, rest), by=c("target"= "species")) %>% 
  drop_na(englishspecies) %>% 
  # mutate(englishspecies = factor(englishspecies, levels=levels(all$englishspecies)))
  mutate(englishspecies = factor(englishspecies, 
                                  levels=rev(all$englishspecies))) 

# colourCount = levels(t$englishspecies)
# getPalette = colorRampPalette(rev(brewer.pal(12, "Paired")))

pp <-
  t %>% 
  ggplot(aes(x=year, y=prop)) +
  theme_publication() +
  theme(plot.margin = margin(2,2,2,5, "mm")) +
  theme(legend.position = "right", legend.direction="vertical") +
  geom_bar(aes(fill=englishspecies), stat="identity") + 
  scale_fill_manual(values = myTargetColors) +
  guides(fill = guide_legend(order = 2)) +
  scale_x_continuous(breaks=seq(min(t$year),max(t$year),1)) +
  scale_y_continuous(labels=scales::percent) +
  labs(y="proportion of targeted weeks", x="", fill="Target species") 

print(pp)

png(filename=file.path(figuresdir, "proportion of targeted weeks.png"),
     width=12.5, height=5.5, units="in", res=300, bg="transparent")
print( pp   + 
         theme(plot.background = element_blank()) +
         theme(panel.background = element_blank())) 
invisible(dev.off())

```

_`r fig_nums("catch5")`_

\newpage

**Average price (Jaczon vessels) by species and year**

The average price per species and year was derived from the sales information by vessel. This demonstrates that there are large differences in price level between species (e.g. compare Seabass BSS with Atlantic horse mackerel HOM), but also that there can be quite different patterns over time (e.g. increasing price for European squid SQR) and decreasing price for Greater weever WEG). 

```{r prices, echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}

fig_nums(
  name    = "prices", 
  level = 1, display = FALSE,
  caption = "Mean prices of Jaczon vessels by species and year")

t <-
  price %>% 
  filter(species %in% top$species) %>%
  left_join(top, by="species") %>% 
  left_join(regulated, by="species") %>% 
  mutate(englishspecies = factor(paste(englishname, species), levels=top$englishspecies)) %>% 
  group_by(regulated, englishspecies, year) %>% 
  summarise(
    price = mean(avgprice, na.rm=TRUE)) %>% 
  ungroup() 

pp <-
  t %>% 
  # filter(regulated == "NR") %>% 
  
  ggplot() +
  theme_publication() +
  theme(plot.margin = margin(2,2,2,5, "mm")) +
  theme(plot.title = element_text(hjust = 0.0)) +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +

  geom_point(aes(x=year, y=price, colour=englishspecies)) +  
  geom_line(aes(x=year, y=price, colour=englishspecies)) +  
  scale_colour_manual(values = myTopColors) +
  # scale_fill_manual(values = getPalette(colourCount)) +
  guides(fill = guide_legend(order = 2)) +
  guides(fill=guide_legend(nrow = 1)) + 
  scale_x_continuous(breaks=seq(min(e$year), max(e$year),1)) +
  labs(x="",y="", title="Average price") +
  facet_wrap(~englishspecies, ncol=4)
  
print(pp)

png(filename=file.path(figuresdir, "prices by species.png"),
     width=12.5, height=5.5, units="in", res=300, bg="transparent")
print( pp   + 
         theme(plot.background = element_blank()) +
         theme(panel.background = element_blank())) 
invisible(dev.off())

```

_`r fig_nums("prices")`_

\newpage

**Average price (Jaczon vessels) against total landings by species (Jaczon vessels)**

To check whether there could be a relationship between landings and price, we plotted the total landings per species against the average price per species. Each dot in the graphs below indicate a specific year. For most  species, there appears to be a negative relationship between the amount of landings and the average price (e.g. Surmullet, gurnards and horse mackerel). European squid, cuttlefish and mackerel suggest no relationship between landings and price. 

```{r prices2, echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}

fig_nums(
  name    = "prices2", 
  level = 1, display = FALSE,
  caption = "Mean prices of Jaczon vessels against total landings")

catch_byweek %>% 
  filter(species %in% top$species) %>%   
  mutate(englishspecies = paste(englishname, species)) %>% 
  mutate(englishspecies = factor(englishspecies, levels=top$englishspecies)) %>% 
  group_by(englishspecies, species, year) %>% 
  summarise(catch = sum(catch,na.rm=TRUE)/1000) %>% 
  right_join(price, by=c("year","species")) %>% 
  drop_na(englishspecies) %>% 
  
  ggplot(aes(x=catch, y=avgprice)) +
  theme_publication() +
  theme(legend.position = "none") +
  theme(plot.margin = margin(2,2,2,5, "mm")) +
  geom_point(aes(colour=englishspecies)) +
  geom_smooth(aes(colour=englishspecies), se=FALSE, method="lm", linewidth=0.5) +
  scale_colour_manual(values = myTopColors) +
  expand_limits(x=0, y=0) +
  labs(x="catch (tonnes)") +
  facet_wrap(~englishspecies, scales="free", ncol=4)


```

_`r fig_nums("prices2")`_

\newpage

**Map of total landings by species and ICES rectangle, cumulative over years**

The landings by species and rectangle were summed over all vessels and years and categorized in different bins (square root transformed). The figure below demonstrates the spatial distribution of the landings by species. Squid, cuttlefish and mullet are mostly caught in the Channel, whereas most of the mackerel catches are taken in the North Sea. 

```{r catch6, echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}

fig_nums(
  name    = "catch6", 
  level = 1, display = FALSE,
  caption = "Landings by species, rectangle and year")

t <-
  catch_byweek %>% 
  filter(species %in% top$species) %>%
  mutate(englishspecies = factor(paste(englishname, species), levels=top$englishspecies)) %>% 
  drop_na(catch, lat, lon) %>% 
  group_by(regulated, englishspecies, rect, lat, lon, year) %>% 
  summarise(
    catch = sum(catch, na.rm=TRUE)/1000) %>% 
  ungroup() %>% 
  left_join(rect_lr_sf, by=c("rect"= "ICESNAME")) %>% 
  dplyr::select(-ID, -SOUTH, -NORTH, -WEST, -EAST) %>% 
  
  # mutate(catch_interval = cut(as.integer(catch), breaks=c(1 %o% 10^(0:12)), dig.lab=10 ) ) %>% 
  mutate(., catch_interval = cut(catch, scales::trans_breaks("sqrt", function(x) x ^ 2)(c(0, max(catch, na.rm=TRUE))), 
                               dig.lab=10 ) ) %>% 
  
  tidyr::complete(year, nesting(englishspecies)) %>% 
  sf::st_as_sf()

tmax <- 100*ceiling(max(t$catch, na.rm=TRUE)/100)

# t %>% ungroup() %>% distinct(englishspecies, regulated) %>% View()
# catch_byweek %>% ungroup() %>% distinct(species, regulated) %>% View()

ttt <-
  t %>% 
  sf::st_drop_geometry() %>% 
  group_by(englishspecies) %>% 
  summarise(catch = as.integer(sum(catch, na.rm=TRUE))) %>% 
  arrange(desc(catch)) 

bb <- sf::st_bbox(t)

# p1 <-
  t %>% 
  # filter(regulated == "NR") %>% 
  
  ggplot() +
  theme_publication() +
  theme(plot.margin = margin(1,1,1,1, "mm")) +
  theme(plot.title = element_text(hjust = 0.0)) +
  # theme(legend.position = "none") +
  
  geom_sf(data=world_mr_sf, 
          font = "Arial") +
  geom_sf(aes(fill=catch_interval), 
          font = "Arial") +
  geom_text(data=ttt, 
            aes(x=-Inf, y=Inf, label=paste(catch,"t")), 
            hjust=0, vjust=1) +
  coord_sf(xlim=c(bb$xmin,bb$xmax), ylim=c(bb$ymin, bb$ymax)) + 
  scale_fill_viridis(option = "plasma", direction = -1, discrete=TRUE) +
  guides(fill=guide_legend(nrow = 1)) + 
  labs(x="",y="", title="Landings by rectangle") +
  facet_wrap(~englishspecies, ncol=5)
  

```

_`r fig_nums("catch6")`_

\newpage

**Observed catch rate (landings / week)**

The observed catch rates (as average landings per day) were expressed by year and plotted as box-plot. Note that the extreme values, that are sometimes observed, have been removed with the Desctools::Winsorize function whereby all observations larger than the 95th percentile are set to the value at the 95th percentile. The four main target species of the flyshoot fishery show relatively stable trends. Catch rates for gurnards show a decreasing trend as do the catch rates for most of the bycatch species. 

```{r cpue1, echo=FALSE, message=FALSE, warning=FALSE, comment=NA, fig.asp=1.0}

fig_nums(
  name    = "cpue1", 
  level = 1, display = FALSE,
  caption = "CPUE (landings/day, kg) on log-scale. Outliers not shown on the figures. Red dot indicates medians. Blue line is the linear slope through the medians. The slope refers to the slope of the regression line. ")

# catch %>% 
t <-
  e %>% 
  filter(species %in% top$species) %>%
  mutate(englishspecies = paste(englishname, species)) %>% 
  mutate(englishspecies = factor(englishspecies, levels=top$englishspecies)) %>% 
  drop_na(weight) %>% 
  group_by(vessel, englishspecies, year, date) %>% 
  summarise(catch_day = sum(weight, na.rm=TRUE)) %>% 
  ungroup() 

# t %>% distinct(englishspecies, regulated) %>% View()

# remove outliers for display
t2 <-
  t %>% 
  group_by(englishspecies) %>% 
  mutate(catch_day =   DescTools::Winsorize(catch_day, probs=c(0, 0.9)))  
  # mutate(cutoff = quantile(catch_day, na.rm=TRUE, c(0.9))) %>% 
  # mutate(catch_day   = ifelse(catch_day > cutoff, NA, catch_day))

# t2 %>% group_by(test) %>% summarise(n=n())

# median
m <-
  t %>% 
  group_by(englishspecies, year) %>% 
  summarise(median = median(catch_day, na.rm=TRUE))

# slope
s <-
  m %>%
  group_by(englishspecies) %>%
  summarise(slope = scales::percent(lm(year ~ median)$coefficients[2], accuracy=1)) 

pp <-
  t2 %>%   
  # filter(regulated =="NR") %>% 
  
  ggplot(aes(x=year, y=catch_day, group=year)) +
  theme_publication() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  theme(plot.margin = margin(1,1,1,1, "mm")) +
  theme(plot.title = element_text(hjust = 0.0)) +
  
  stat_summary(fun.data = calc_boxplot_stat, geom="boxplot") +  
  geom_point(data=m, 
             aes(x=year, y=median), 
             colour="red", inherit.aes = FALSE) +
  geom_smooth(data=m, 
              aes(x=year, y=median), 
              method="lm", colour="blue", inherit.aes = FALSE, se=FALSE) +
  geom_text(data=s, 
            aes(x=-Inf, y=1, label=paste("slope:", slope)), 
            inherit.aes = FALSE, hjust="left", vjust="bottom", colour="blue") +
  
  expand_limits(y=0) +
  scale_x_continuous(breaks=seq(min(e$year), max(e$year),1)) +
  scale_y_log10() +
  labs(x="", y="landings/day (kg)", title="Average landings per day") +
  facet_wrap(~englishspecies, ncol=4)

print(pp)

png(filename=file.path(figuresdir, "average landings per day.png"),
     width=12.5, height=5.5, units="in", res=300, bg="transparent")
print( pp   + 
         facet_wrap(~englishspecies, ncol=5) +
         theme(plot.background = element_blank()) +
         theme(panel.background = element_blank())) 
invisible(dev.off())


```

_`r fig_nums("cpue1")`_

\newpage

**Average revenue rate (revenue / day) per vessel and quarter**

The average revenue rate (revenue per day) per vessel and quarter was calculated based on the value of the catch per day, summed over all species. Revenue rates are highest in the first and fourth quarters. Highest revenue rates are observed in 2016 and 2017 (but based on few observations) and in the fourth quarter of 2022.   

```{r obsrevenue, echo=FALSE, message=FALSE, warning=FALSE, comment=NA, fig.asp=1.0}

fig_nums(
  name    = "obsrevenue", 
  level = 1, display = FALSE,
  caption = "Average revenue per day by vessel and quarter. Red dot indicates medians.")

  
# revenue %>% 
t <-
  catch_byweek %>% 
  mutate(revenue = catch * avgprice) %>% 
  group_by(vessel, year, quarter, week) %>% 
  summarise(revenue = sum(revenue, na.rm=TRUE)) %>% 
  left_join(effort_byweek2, by=c("vessel", "year","week")) %>% 
  mutate(revenue_day = revenue / effort) %>% 
  ungroup() 

# t %>% distinct(englishspecies, regulated) %>% View()
# e %>% filter(vessel == "SCH135", year==2017, week==38) %>% mutate(date2=format(date, format="%a %m/%d/%Y")) %>% View()

# median
m <-
  t %>% 
  group_by(vessel, year, quarter) %>% 
  summarise(median = median(revenue_day, na.rm=TRUE))


pp <-
  t %>%   

  ggplot(aes(x=year, y=revenue_day, group=year)) +
  theme_publication() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  theme(plot.margin = margin(1,1,1,1, "mm")) +
  theme(plot.title = element_text(hjust = 0.0)) +
  
  stat_summary(fun.data = calc_boxplot_stat, geom="boxplot") +  
  geom_point(data=m, 
             aes(x=year, y=median), 
             colour="red", inherit.aes = FALSE) +
  expand_limits(y=0) +
  scale_x_continuous(breaks=seq(min(e$year), max(e$year),1)) +
  # scale_y_log10() +
  labs(x="", y="revenue/day (euro)", title="Average revenue per day") +
  facet_grid(vessel~quarter)
  
print(pp)

png(filename=file.path(figuresdir, "average revenue per day.png"),
     width=12.5, height=5.5, units="in", res=300, bg="transparent")
print( pp   + 
         plot_layout(widths = c(11, 11) ) + 
         theme(plot.background = element_blank()) +
         theme(panel.background = element_blank())) 
invisible(dev.off())


```

_`r fig_nums("obsrevenue")`_


\newpage

# Standardized CPUE

The CPUE calculation are based on `r ifelse(toprectanglesonly,"data for the top-10 rectangles per species ","all the available data"))`. 

Calculating a standardized catch rate (CPUE) by species, is carried out in a number of steps. First, only the year trend is calculated. Then, in a series of three steps, we determine the most significant factors for the different species. The factors considered are: vessel, latitude, longitude, rectangle, quarter and target species. The evaluation is carried out by assessing the AIC values for each factor. The factor with the lowest AIC is then taken forward in each of the steps. 



```{r zero_effect, echo=FALSE, fig.asp=0.7, fig.align="center", message=FALSE, warning=FALSE}

myvars       <- c("vessel", "lat", "lon","rect", "quarter", "target")
myefficiency <- 0
# winsorize    <- c(0.05, 0.95)

# create dataset to be used
t <-
  catch_byweek %>% 
  filter(species %in% top$species) %>% 
  mutate(species = factor(species, levels=top$species)) %>% 
  
  # focus on top rectangles by species only?
  {if(toprectanglesonly) {  
    filter(., paste(species, rect) %in% paste(top_rectangles$species, top_rectangles$rect))
  } else {.}} %>%  

  ungroup() %>% 
  # mutate(catch = DescTools::Winsorize(catch, probs=winsorize)) %>% 
  dplyr::mutate(efficiency  = myefficiency) %>%
  dplyr::mutate(ef = (1 + efficiency)^(year - min(year, na.rm=TRUE))) %>%  
  dplyr::mutate(year  = factor(year, levels=sort(unique(e$year)))) %>%
  dplyr::mutate(effort = ef * effort) %>% 
  dplyr::mutate(quarter = as.character(quarter)) %>% 
  dplyr::mutate(lat = as.character(lat)) %>% 
  dplyr::mutate(lon = as.character(lon)) 

# years
years <-
  t %>%
  ungroup() %>% 
  distinct(species, year) %>% 
  arrange(species, year)

# Get the unique variables for predictions
temp <-
  t %>%
  na.omit() %>% 
  tidyr::unite("newvar", c(myvars), sep="/") %>%
  group_by(species, efficiency, newvar) %>%
  summarise(
    n = n(), 
    catch = sum(catch, na.rm=TRUE),
    effort = sum(effort, na.rm=TRUE)
  )  %>% 
  group_by(species, efficiency) %>%
  arrange(-catch) %>% 
  group_by(species, efficiency) %>%
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  mutate(effort  = effort/n) %>% 
  dplyr::select(-n, -catch) %>%
  tidyr::separate(newvar, into=c(myvars), sep="/")  

# get the predictor dataset
newdat <-
  left_join(years, temp, by=c("species")) %>% 
  group_by(species, efficiency) %>% 
  nest()

# fit model
x <-
  t %>% 
  na.omit() %>% 
  filter(!is.na(species)) %>% 
  group_by(species, efficiency) %>% 
  nest() %>%  
  mutate(model = "catch ~ offset(log(effort)) + year") %>% 
  summarise(
    fit       = purrr::map(data, ~MASS::glm.nb(formula=formula(model), data = .x)),
    anova     = purrr::map(fit, stats::anova)
  ) %>% 
  
  # add the prediction data
  left_join(newdat, by=c("species","efficiency")) %>% 
  
  # do the prediction
  group_by(species, efficiency) %>% 
  rowwise() %>% 
  mutate(pred =  list(
                    data.frame(
                      fit = predict(fit, unnest(data),se.fit=T,type="link")[c(1)],
                      se  = predict(fit, unnest(data),se.fit=T,type="link")[c(2)]) %>% 
                      setNames(c("pred","se")) %>% 
                      as.tibble())) %>% 
  ungroup()

# generate predicted values data frame
pred0 <-
  x %>% 
  dplyr::select(species, efficiency, pred, data) %>% 
  unnest(c(pred, data))  %>% 
  mutate(
    est  = exp(pred),
    upr  = exp(pred + (1.96 * se)),
    lwr  = exp(pred - (1.96 * se))
  ) %>% 
  left_join(top) %>% 
  mutate(englishspecies = factor(englishspecies, levels=top$englishspecies)) %>% 
  left_join(regulated)

```

**Modelling the first linear effect next to the year trend**

*Catch ~ offset(log(effort)) + year + 1st linear effect*

```{r first_effect, echo=FALSE, fig.asp=0.7, fig.align="center", message=FALSE, warning=FALSE}

fig_nums(
  name    = "glm1", 
  level = 1, display = FALSE,
  caption = "GLM AIC criteria of the first linear effects")

# myvars       <- c("year", "vessel", "lat", "lon","rect", "quarter", "target")
# myefficiency <- 0
# winsorize    <- c(0.05, 0.95)

# create dataset to be used
t <-
  catch_byweek %>% 
  filter(species %in% top$species) %>% 
  mutate(species = factor(species, levels=top$species)) %>% 
  
  # focus on top rectangles by species only?
  {if(toprectanglesonly) {  
    filter(., paste(species, rect) %in% paste(top_rectangles$species, top_rectangles$rect))
  } else {.}} %>%  

  ungroup() %>% 
  # mutate(catch = DescTools::Winsorize(catch, probs=winsorize)) %>% 
  dplyr::mutate(efficiency  = myefficiency) %>%
  dplyr::mutate(ef = (1 + efficiency)^(year - min(year, na.rm=TRUE))) %>%  
  dplyr::mutate(year  = factor(year, levels=sort(unique(e$year)))) %>%
  dplyr::mutate(effort = ef * effort) %>% 
  dplyr::mutate(quarter = as.character(quarter)) %>% 
  dplyr::mutate(lat = as.character(lat)) %>% 
  dplyr::mutate(lon = as.character(lon)) 

# Get the unique variables for predictions
t_unique <-
  t %>%
  na.omit() %>% 
  tidyr::unite("newvar", c(myvars), sep="/") %>%
  group_by(species, efficiency, newvar) %>%
  summarise(
    n = n(), 
    catch = sum(catch, na.rm=TRUE),
    effort = sum(effort, na.rm=TRUE)
  )  %>% 
  group_by(species, efficiency) %>%
  arrange(-catch) %>% 
  group_by(species, efficiency) %>%
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  mutate(effort  = effort/n) %>% 
  dplyr::select(-n, -catch) %>%
  tidyr::separate(newvar, into=c(myvars), sep="/")  

#- Select the combination of all first linear effect next to the year and species effect
df <-
  data.frame(var = factor(myvars,
                          levels=myvars)) %>% 
  bind_cols(
    lapply(myvars,function(x) paste("catch ~ offset(log(effort)) + year + ",x)) %>%
    # lapply(myvars,function(x) paste("catch ~ offset(log(effort)) + ",x)) %>%
      do.call(rbind.data.frame, .) %>% 
      setNames("model")  
  )

# create dataset to assess contrasts
x0 <-
  t %>% 
  na.omit() %>% 
  filter(!is.na(species)) %>% 
  group_by(species, efficiency) %>% 
  nest() %>% 
  ungroup() %>%   
  cross_join(df)

# evaluate contrasts
contrasts <-
  x0 %>% 
  unnest(data) %>% 
  dplyr::select(one_of("species","efficiency", "var", myvars)) %>%
  distinct() %>% 
  dplyr::mutate(across(one_of("year", "quarter","month","week"), as.character)) %>%
  tidyr::pivot_longer(names_to = "variable", values_to = "data", myvars) %>%
  dplyr::filter(variable == var) %>% 
  group_by(species, efficiency, var) %>% 
  summarise(n = n_distinct(data)) %>% 
  filter(n > 1)

# only use data with sufficient contrasts
x <-
  x0 %>% 
  filter(paste(species, var) %in% paste(contrasts$species, contrasts$var)) %>% 
  group_by(species, efficiency, var, model ) %>% 
  summarise(
    fit       = purrr::map(data, ~MASS::glm.nb(formula=formula(model), data = .x)),
    anova     = purrr::map(fit, stats::anova)
  ) %>% 
  cbind(
    aic = do.call(rbind,lapply(.[["fit"]],stats::AIC))[,1]
  ) %>% 
  ungroup()

# do.call(rbind,lapply(x[["fit"]],stats::AIC))[,1]
selected <-
  x %>% 
  group_by(species, efficiency) %>% 
  
  # minimum of AIC per species
  filter(aic == min(aic)) %>% 
  
  # add the prediction data
  left_join(newdat, by=c("species","efficiency")) %>% 
  
  # do the prediction
  group_by(species, efficiency) %>% 
  rowwise() %>% 
  mutate(pred =  list(
                    data.frame(
                      fit = predict(fit, unnest(data),se.fit=T,type="link")[c(1)],
                      se  = predict(fit, unnest(data),se.fit=T,type="link")[c(2)]) %>% 
                      setNames(c("pred","se")) %>% 
                      as.tibble())) %>% 
  group_by(species, efficiency) 

# generate predicted values data frame
pred1 <-
  selected %>% 
  dplyr::select(species, efficiency, pred, data) %>% 
  unnest(c(pred, data))  %>% 
  mutate(
    est  = exp(pred),
    upr  = exp(pred + (1.96 * se)),
    lwr  = exp(pred - (1.96 * se))
  ) %>% 
  left_join(top) %>% 
  mutate(englishspecies = factor(englishspecies, levels=top$englishspecies)) %>% 
  left_join(regulated)


vars <-
  selected %>% 
  ungroup() %>% 
  dplyr::select(species, model) %>% 
  separate(model, into=c("var1","var2"), sep=" ~ ") %>% 
  mutate(var2=str_replace_all(var2, fixed(" "), "") )%>% 
  separate(var2,  into=c("v1","v2","v3"), sep= "\\+") %>% 
  pivot_longer(names_to = "temp", values_to = "var", "v1":"v3") %>% 
  ungroup() %>% 
  dplyr::select(-temp, -var1, -species)

anovas <-
  selected %>%
  dplyr::select(anova) %>%
  unnest(anova) %>% 
  setNames(c("species","efficiency", "df","dev","residdf","residdev","prchi")) %>% 
  bind_cols(., vars) %>% 
  filter(!(grepl("effort|year", var))) %>% 
  lowcase() %>% 
  filter(prchi < 0.05)

nextmodel1 <-
  anovas %>% 
  dplyr::select(species, efficiency) %>% 
  left_join(dplyr::select(selected,
                          species, efficiency, model),
            by=c("species", "efficiency"))


# plot 
x %>%
  ungroup() %>%
  dplyr::select(species, var, aic) %>% 
  left_join(top, by="species") %>%
  mutate(englishspecies = factor(englishspecies, levels=top$englishspecies)) %>%
  left_join(regulated, by="species") %>% 

  ggplot(aes(x=var, y=aic)) +
  theme_publication() +
  theme(plot.margin = margin(1,1,1,1, "mm")) +
  theme(plot.title = element_text(hjust = 0.0)) +

  geom_point(size=3) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(x="", y="AIC", title="AIC for first linear factor") +
  facet_wrap(~englishspecies, scales="free_y", ncol=5)


# rects <-
#   anovas %>% 
#   filter(var=="rect") %>% 
#   left_join(top, by="species") %>% 
#   dplyr::select(englishspecies) %>% 
#   ungroup() %>% 
#   summarise(englishspecies = paste(englishspecies, collapse=", ")) %>% 
#   as.character()

# quarters <-
#   anovas %>% 
#   filter(var=="quarter") %>% 
#   left_join(top, by="species") %>% 
#   dplyr::select(englishspecies) %>% 
#   ungroup() %>% 
#   summarise(englishspecies = paste(englishspecies, collapse=", ")) %>% 
#   as.character()

# targets <-
#   anovas %>% 
#   filter(var=="target") %>% 
#   left_join(top, by="species") %>% 
#   dplyr::select(englishspecies) %>% 
#   ungroup() %>% 
#   summarise(englishspecies = paste(englishspecies, collapse=", ")) %>% 
#   as.character()

effects <-
  anovas %>% 
  ungroup() %>% 
  dplyr::select(species, var) %>% 
  group_by(var) %>% 
  mutate(n = n()) %>% 
  arrange(desc(n), var) %>% 
  left_join(dplyr::select(top,
                          species, englishspecies), 
            by="species") %>% 
  group_by(var, n) %>% 
  summarise(species = paste(englishspecies, collapse="\n")) %>% 
  rename(effect=var) %>% 
  arrange(desc(n), effect) %>% 
  dplyr::select(-n)

```

_`r fig_nums("glm1")`_

The following species have the following first linear factor:

```{r message=FALSE, warning=FALSE, out.width="400px"}
ft <-
  effects %>% 
  flextable::flextable() %>%
  flextable::fontsize(size =12, part = "all") %>% 
  flextable::valign(valign = "top", part = "all") %>% 
  flextable::align(align="left", part="all") %>% 
  flextable::width(width=6) %>% 
  flextable::autofit()

  png(filename=file.path(tablesdir, "firsteffect.png"),
      width=6, height=3, units="in", res=300)
  plot(ft, fit = "fixed", just = "left")
  invisible(dev.off())

  knitr::include_graphics(file.path(tablesdir, "firsteffect.png"))
  
```

\newpage

**Modelling the second linear effect**

*Catch ~ offset(log(effort)) + year + 1st linear effect + 2nd linear effect*

```{r second_effect, echo=FALSE, fig.asp=0.7, fig.align="center", message=FALSE, warning=FALSE}

fig_nums(
  name    = "glm2", 
  level = 1, display = FALSE,
  caption = "GLM AIC criteria of the second linear effects")

# myvars       <- c("vessel", "lat", "lon","rect", "quarter")
# myefficiency <- 0


# set up model
df <-
  nextmodel1 %>% 
  mutate(myvars=paste(myvars, collapse="/")) %>% 
  tidyr::separate(myvars, into=c("v1","v2","v3","v4","v5","v6"), sep="/") %>% 
  tidyr::pivot_longer(names_to = "tmp", values_to = "var", v1:v6) %>% 
  rowwise() %>% 
  filter(!grepl(var, model)) %>% 
  ungroup() %>% 
  mutate(model = paste(model, var, sep = " + ")) %>% 
  dplyr::select(species, model, var)

# create dataset to assess contrasts
x0 <-
  t %>% 
  na.omit() %>% 
  filter(!is.na(species)) %>% 
  group_by(species, efficiency) %>% 
  nest() %>% 
  ungroup() %>%   
  left_join(df, by="species") 

# evaluate contrasts
contrasts <-
  x0 %>% 
  unnest(data) %>% 
  dplyr::select(one_of("species","efficiency", 
                       "var","vessel", "quarter","month","week","rect","lat","lon", "target")) %>% 
  distinct() %>% 
  dplyr::mutate(across(c("quarter","month","week"), as.character)) %>% 
  tidyr::pivot_longer(names_to = "variable", values_to = "data",
                      c("vessel","quarter","month","week","rect","lat","lon", "target")) %>% 
  dplyr::filter(variable == var) %>% 
  group_by(species, efficiency, var) %>% 
  summarise(n = n_distinct(data)) %>% 
  filter(n > 1)

# only use data with sufficient contrasts
x <-
  x0 %>% 
  filter(paste(species, var) %in% paste(contrasts$species, contrasts$var)) %>% 
  group_by(species, efficiency, var, model ) %>% 
  summarise(
    fit       = purrr::map(data, ~MASS::glm.nb(formula=formula(model), data = .x)),
    anova     = purrr::map(fit, stats::anova)
  ) %>% 
  cbind(
    aic = do.call(rbind,lapply(.[["fit"]],stats::AIC))[,1]
  ) %>% 
  ungroup()

# select lowest AICs
selected <-
  x %>% 
  group_by(species, efficiency) %>% 
  
  # minimum of AIC per species
  filter(aic == min(aic)) %>% 
  
  # add the prediction data
  left_join(newdat, by=c("species","efficiency")) %>% 
  
  # do the prediction
  group_by(species, efficiency) %>% 
  rowwise() %>% 
  mutate(pred =  list(
                    data.frame(
                      fit = predict(fit, unnest(data),se.fit=T,type="link")[c(1)],
                      se  = predict(fit, unnest(data),se.fit=T,type="link")[c(2)]) %>% 
                      setNames(c("pred","se")) %>% 
                      as.tibble())) %>% 
  group_by(species, efficiency) 

# generate predicted values data frame
pred2 <-
  selected %>% 
  dplyr::select(species, efficiency, pred, data) %>% 
  unnest(c(pred, data))  %>% 
  mutate(
    est  = exp(pred),
    upr  = exp(pred + (1.96 * se)),
    lwr  = exp(pred - (1.96 * se))
  ) %>% 
  left_join(top) %>% 
  mutate(englishspecies = factor(englishspecies, levels=top$englishspecies)) %>% 
  left_join(regulated)

  
vars <-
  selected %>% 
  ungroup() %>% 
  dplyr::select(species, model) %>% 
  separate(model, into=c("var1","var2"), sep=" ~ ") %>% 
  mutate(var2=str_replace_all(var2, fixed(" "), "") )%>% 
  separate(var2,  into=c("v1","v2","v3","v4"), sep= "\\+") %>% 
  pivot_longer(names_to = "temp", values_to = "var", "v1":"v4") %>% 
  ungroup() %>% 
  dplyr::select(-temp, -var1, -species)

anovas <-
  selected %>%
  dplyr::select(anova) %>%
  unnest(anova) %>% 
  setNames(c("species","efficiency", "df","dev","residdf","residdev","prchi")) %>% 
  bind_cols(., vars) %>% 
  group_by(species) %>% 
  filter(row_number() == 4) %>% 
  # filter(!(grepl("effort|year", var))) %>% 
  lowcase() %>% 
  filter(prchi < 0.05)

nextmodel2 <-
  anovas %>% 
  dplyr::select(species, efficiency) %>% 
  left_join(dplyr::select(selected,
                          species, efficiency, model),
            by=c("species","efficiency")) 

# plot
x %>%
  ungroup() %>%
  filter(efficiency==0) %>% 
  dplyr::select(species, var, aic) %>% 
  left_join(top, by="species") %>%
  mutate(englishspecies = factor(englishspecies, levels=top$englishspecies)) %>%
  left_join(regulated, by="species") %>% 

  ggplot(aes(x=var, y=aic)) +
  theme_publication() +
  theme(plot.margin = margin(1,1,1,1, "mm")) +
  theme(plot.title = element_text(hjust = 0.0)) +

  geom_point(size=3) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(x="", y="AIC", title="AIC for second linear factor") +
  facet_wrap(~englishspecies, scales="free_y", ncol=5)


rects <-
  anovas %>% 
  filter(var=="rect") %>% 
  left_join(top, by="species") %>% 
  dplyr::select(englishspecies) %>% 
  ungroup() %>% 
  summarise(englishspecies = paste(englishspecies, collapse=", ")) %>% 
  as.character()

quarters <-
  anovas %>% 
  filter(var=="quarter") %>% 
  left_join(top, by="species") %>% 
  dplyr::select(englishspecies) %>% 
  ungroup() %>% 
  summarise(englishspecies = paste(englishspecies, collapse=", ")) %>% 
  as.character()

vessels <-
  anovas %>% 
  filter(var=="vessel") %>% 
  left_join(top, by="species") %>% 
  dplyr::select(englishspecies) %>% 
  ungroup() %>% 
  summarise(englishspecies = paste(englishspecies, collapse=", ")) %>% 
  as.character()

targets <-
  anovas %>% 
  filter(var=="target") %>% 
  left_join(top, by="species") %>% 
  dplyr::select(englishspecies) %>% 
  ungroup() %>% 
  summarise(englishspecies = paste(englishspecies, collapse=", ")) %>% 
  as.character()

effects <-
  anovas %>% 
  ungroup() %>% 
  dplyr::select(species, var) %>% 
  group_by(var) %>% 
  mutate(n = n()) %>% 
  arrange(desc(n), var) %>% 
  left_join(dplyr::select(top,
                          species, englishspecies), 
            by="species") %>% 
  group_by(var, n) %>% 
  summarise(species = paste(englishspecies, collapse="\n")) %>% 
  rename(effect=var) %>% 
  arrange(desc(n), effect) %>% 
  dplyr::select(-n)

```

_`r fig_nums("glm2")`_

The following species have the following second linear factor:
```{r message=FALSE, warning=FALSE, out.width="400px"}
ft <-
  effects %>% 
  flextable::flextable() %>%
  flextable::fontsize(size =12, part = "all") %>% 
  flextable::valign(valign = "top", part = "all") %>% 
  flextable::align(align="left", part="all") %>% 
  flextable::width(width=6) %>% 
  flextable::autofit()

  png(filename=file.path(tablesdir, "secondeffect.png"),
      width=6, height=3, units="in", res=300)
  plot(ft, fit = "fixed", just = "left")
  invisible(dev.off())

  knitr::include_graphics(file.path(tablesdir, "secondeffect.png"))
  
```

\newpage

**Modelling the third linear effect **

*Catch ~ offset(log(effort)) + year + 1st linear effect + 2nd linear effect + 3rd linear effect*

```{r third_effect, echo=FALSE, fig.asp=0.7, fig.align="center", message=FALSE, warning=FALSE}

fig_nums(
  name    = "glm3", 
  level = 1, display = FALSE,
  caption = "GLM AIC criteria of the third linear effects")

# myvars       <- c("vessel", "lat", "lon","rect", "quarter")
# myefficiency <- 0


# set up model
df <-
  nextmodel2 %>% 
  mutate(myvars=paste(myvars, collapse="/")) %>% 
  tidyr::separate(myvars, into=c("v1","v2","v3","v4","v5","v6"), sep="/") %>% 
  tidyr::pivot_longer(names_to = "tmp", values_to = "var", v1:v6) %>% 
  rowwise() %>% 
  filter(!grepl(var, model)) %>% 
  ungroup() %>% 
  mutate(model = paste(model, var, sep = " + ")) %>% 
  dplyr::select(species, model, var)

x0 <-
  t %>% 
  na.omit() %>% 
  filter(!is.na(species)) %>% 
  group_by(species, efficiency) %>% 
  nest() %>% 
  ungroup() %>%   
  left_join(df, by="species") 

# evaluate contrasts
contrasts <-
  x0 %>% 
  unnest(data) %>% 
  dplyr::select(one_of("species","efficiency", 
                       "var","vessel", "quarter","month","week","rect","lat","lon", "target")) %>% 
  distinct() %>% 
  dplyr::mutate(across(c("quarter","month","week"), as.character)) %>% 
  tidyr::pivot_longer(names_to = "variable", values_to = "data",
                      c("vessel","quarter","month","week","rect","lat","lon", "target")) %>% 
  dplyr::filter(variable == var) %>% 
  group_by(species, efficiency, var) %>% 
  summarise(n = n_distinct(data)) %>% 
  filter(n > 1)

# only use data with sufficient contrasts
x <-
  x0 %>% 
  filter(paste(species, var) %in% paste(contrasts$species, contrasts$var)) %>% 
  group_by(species, efficiency, var, model ) %>% 
  summarise(
    fit       = purrr::map(data, ~MASS::glm.nb(formula=formula(model), data = .x)),
    anova     = purrr::map(fit, stats::anova)
  ) %>% 
  cbind(
    aic = do.call(rbind,lapply(.[["fit"]],stats::AIC))[,1]
  ) %>% 
  ungroup()

# select lowest AICs
selected <-
  x %>% 
  group_by(species, efficiency) %>% 
  
  # minimum of AIC per species
  filter(aic == min(aic)) %>% 
  
  # add the prediction data
  left_join(newdat, by=c("species","efficiency")) %>% 
  
  # do the prediction
  group_by(species, efficiency) %>% 
  rowwise() %>% 
  mutate(pred =  list(
                    data.frame(
                      fit = predict(fit, unnest(data),se.fit=T,type="link")[c(1)],
                      se  = predict(fit, unnest(data),se.fit=T,type="link")[c(2)]) %>% 
                      setNames(c("pred","se")) %>% 
                      as.tibble())) %>% 
  group_by(species, efficiency) 
 
# generate predicted values data frame
pred3 <-
  selected %>% 
  dplyr::select(species, efficiency, pred, data) %>% 
  unnest(c(pred, data))  %>% 
  mutate(
    est  = exp(pred),
    upr  = exp(pred + (1.96 * se)),
    lwr  = exp(pred - (1.96 * se))
  ) %>% 
  left_join(top) %>% 
  mutate(englishspecies = factor(englishspecies, levels=top$englishspecies)) %>% 
  left_join(regulated)
 
vars <-
  selected %>% 
  dplyr::select(species, model) %>% 
  separate(model, into=c("var1","var2"), sep=" ~ ") %>% 
  mutate(var2=str_replace_all(var2, fixed(" "), "") )%>% 
  separate(var2,  into=c("v1","v2","v3","v4","v5"), sep= "\\+") %>% 
  pivot_longer(names_to = "temp", values_to = "var", "v1":"v5") %>% 
  ungroup() %>% 
  dplyr::select(-temp, -var1, -species, -efficiency)

anovas <-
  selected %>%
  dplyr::select(anova) %>%
  unnest(anova) %>% 
  setNames(c("species","efficiency", "df","dev","residdf","residdev","prchi")) %>% 
  bind_cols(., vars) %>% 
  group_by(species) %>% 
  filter(row_number() == 5) %>% 
  # filter(!(grepl("effort|year", var))) %>% 
  lowcase() %>% 
  filter(prchi < 0.05)

finalmodel <-
  anovas %>% 
  dplyr::select(species, efficiency) %>% 
  left_join(dplyr::select(selected,
                          species, efficiency, model),
            by=c("species", "efficiency")) %>% 
  bind_rows(nextmodel2 %>% filter(species %notin% anovas$species)) %>% 
  bind_rows(nextmodel1 %>% filter(species %notin% anovas$species &
                                    species %notin% nextmodel2$species)) 


# plot
x %>%
  ungroup() %>%
  filter(efficiency==0) %>% 
  dplyr::select(species, var, aic) %>% 
  left_join(top, by="species") %>%
  mutate(englishspecies = factor(englishspecies, levels=top$englishspecies)) %>%
  left_join(regulated, by="species") %>% 

  ggplot(aes(x=var, y=aic)) +
  theme_publication() +
  theme(plot.margin = margin(1,1,1,1, "mm")) +
  theme(plot.title = element_text(hjust = 0.0)) +

  geom_point(size=3) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(x="", y="AIC", title="AIC for third linear factor") +
  facet_wrap(~englishspecies, scales="free_y", ncol=5)


rects <-
  anovas %>% 
  filter(var=="rect") %>% 
  left_join(top, by="species") %>% 
  dplyr::select(englishspecies) %>% 
  ungroup() %>% 
  summarise(englishspecies = paste(englishspecies, collapse=", ")) %>% 
  as.character()

quarters <-
  anovas %>% 
  filter(var=="quarter") %>% 
  left_join(top, by="species") %>% 
  dplyr::select(englishspecies) %>% 
  ungroup() %>% 
  summarise(englishspecies = paste(englishspecies, collapse=", ")) %>% 
  as.character()

vessels <-
  anovas %>% 
  filter(var=="vessel") %>% 
  left_join(top, by="species") %>% 
  dplyr::select(englishspecies) %>% 
  ungroup() %>% 
  summarise(englishspecies = paste(englishspecies, collapse=", ")) %>% 
  as.character()

targets <-
  anovas %>% 
  filter(var=="target") %>% 
  left_join(top, by="species") %>% 
  dplyr::select(englishspecies) %>% 
  ungroup() %>% 
  summarise(englishspecies = paste(englishspecies, collapse=", ")) %>% 
  as.character()

effects <-
  anovas %>% 
  ungroup() %>% 
  dplyr::select(species, var) %>% 
  group_by(var) %>% 
  mutate(n = n()) %>% 
  arrange(desc(n), var) %>% 
  left_join(dplyr::select(top,
                          species, englishspecies), 
            by="species") %>% 
  group_by(var, n) %>% 
  summarise(species = paste(englishspecies, collapse="\n")) %>% 
  rename(effect=var) %>% 
  arrange(desc(n), effect) %>% 
  dplyr::select(-n)

```

_`r fig_nums("glm3")`_

The following species have the following third linear factor:
```{r message=FALSE, warning=FALSE, out.width="400px"}
ft <-
  effects %>% 
  flextable::flextable() %>%
  flextable::fontsize(size =12, part = "all") %>% 
  flextable::valign(valign = "top", part = "all") %>% 
  flextable::align(align="left", part="all") %>% 
  flextable::width(width=6) %>% 
  flextable::autofit()

  png(filename=file.path(tablesdir, "thirdeffect.png"),
      width=6, height=3, units="in", res=300)
  plot(ft, fit = "fixed", just = "left")
  invisible(dev.off())

  knitr::include_graphics(file.path(tablesdir, "thirdeffect.png"))
  
```


```{r cpuemodel, echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}

# Function to calculate deviance table
GetDevianceTable=function(glm){
  tmp <- anova(glm,test="Chisq")
  tmp <- as.data.frame(tmp)
  tmp$PercDevExp <- 100*(tmp$Deviance/(max(tmp[,4])-min(tmp[,4])))
  row.names(tmp)[tmp$PercDevExp >= 5.0]
  DevTableProPos <- tmp
  DevTableProPos   
}

# fit final model
x <-
  t %>% 
  na.omit() %>% 
  # filter(!is.na(species)) %>% 
  group_by(species, efficiency) %>% 
  nest() %>% 
  left_join(finalmodel, by=c("species","efficiency")) %>% 
  
  drop_na(model) %>% 
  
  summarise(
    fit       = purrr::map(data, ~MASS::glm.nb(model, data = .x)),
    tidied    = purrr::map(fit, broom::tidy),
    augmented = purrr::map(fit, broom::augment),
    anova     = purrr::map(fit, stats::anova, test="Chisq"),
    anovaf    = purrr::map(fit, stats::anova, test="F"),
    summary   = purrr::map(fit, summary),
    devtable  = purrr::map(fit, GetDevianceTable),
    coeff     = purrr::map(fit, stats::coefficients),
    # resid     = purrr::map(fit, stats::residuals),
    aic       = purrr::map(fit, stats::AIC)
  ) %>% 
  # add the prediction data
  
  left_join(newdat, by=c("species","efficiency")) %>% 
  
  # do the prediction
  group_by(species, efficiency) %>% 
  rowwise() %>% 
  mutate(n        = length(anova[["Resid. Dev"]])) %>% 
  mutate(expl_dev = (anova[["Resid. Dev"]][1]-anova[["Resid. Dev"]][n])/anova[["Resid. Dev"]][1]) %>% 
  mutate(pchisq   = pchisq(fit$null.deviance-fit$deviance, fit$df.null-fit$df.residual, lower.tail=FALSE)) %>%  
  mutate(pred =  list(
                    data.frame(
                      fit = predict(fit, unnest(data),se.fit=T,type="link")[c(1)],
                      se  = predict(fit, unnest(data),se.fit=T,type="link")[c(2)]) %>% 
                      setNames(c("pred","se")) %>% 
                      as.tibble())) %>% 
  ungroup()

# generate predicted values
predfinal <-
  x %>% 
  dplyr::select(-fit, -augmented, -tidied, -anova, -coeff, -aic) %>% 
  unnest(c(pred, data))  %>% 
  mutate(
    est  = exp(pred),
    upr  = exp(pred + (1.96 * se)),
    lwr  = exp(pred - (1.96 * se))
  ) %>% 
  left_join(top) %>% 
  mutate(englishspecies = factor(englishspecies, levels=top$englishspecies)) %>% 
  left_join(regulated)

readr::write_rds(predfinal, file=file.path(datadir, paste0(folder,".rds")))

# generate obs and predicted dataset
obspred <-
  x %>% 
  dplyr::select(-fit, -data, -tidied, -anova, -coeff, -aic, -pred) %>% 
  unnest(c(augmented))  %>% 
  mutate(pred = exp(.fitted)) %>% 
  left_join(top) %>% 
  mutate(englishspecies = factor(englishspecies, levels=top$englishspecies)) %>% 
  left_join(regulated)



coeff <- data.frame(stringsAsFactors = FALSE)
for (i in 1:nrow(x)) {
  coeff <-
    bind_rows(
      coeff,
      x[i,"coeff"][["coeff"]][[1]] %>% 
        as.data.frame() %>% 
        setNames("data") %>% 
        rownames_to_column(var="tmp") %>% 
        mutate(
          species    = as.character(x[[i,"species"]]),
          efficiency = x[[i,"efficiency"]]
        ) %>% 
        
      
        # set variable
        mutate(
          var = case_when(
            grepl("rect", tmp)                            ~ "rect",
            grepl("quarter", tmp)&grepl("division", tmp)  ~ "quarter*division",
            grepl("quarter", tmp)                         ~ "quarter",
            grepl("division", tmp)                        ~ "division",
            grepl("vessel", tmp)                          ~ "vessel",
            grepl("year", tmp)                            ~ "year",
            grepl("lat", tmp)                             ~ "lat",
            grepl("lon", tmp)                             ~ "lon",
            grepl("target", tmp)                          ~ "target",
            grepl("price_cat", tmp)                       ~ "price_cat",
            grepl("intercept", tolower(tmp))              ~ "intercept",
            TRUE                                          ~ NA
          ) 
        ) %>% 
        
        mutate(
          value = case_when(
            grepl("rect", tmp)               ~ gsub("rect","",tmp),
            grepl("quarter", tmp)            ~ gsub("quarter","",tmp),
            grepl("division", tmp)           ~ gsub("division","",tmp),
            grepl("vessel", tmp)             ~ gsub("vessel","",tmp),
            grepl("year", tmp)               ~ gsub("year","",tmp),
            grepl("lat", tmp)                ~ gsub("lat","",tmp),
            grepl("lon", tmp)                ~ gsub("lon","",tmp),
            grepl("target", tmp)             ~ gsub("target","",tmp),
            grepl("price_cat", tmp)          ~ gsub("price_cat","",tmp),
            grepl("intercept", tolower(tmp)) ~ NA,
            TRUE                             ~ NA
          )
        ) %>% 
        left_join(top, by="species")
    )
}

# anova data.frame
anova <- data.frame(stringsAsFactors = FALSE)
for (i in 1:nrow(x)) {
  anova <-
    bind_rows(
      anova,
      data.frame(species    = as.character(paste(x[i, "species"][["species"]]))) %>% 
        mutate(efficiency = scales::percent(x[i, "efficiency"][["efficiency"]], accuracy=0.1)) %>% 
        bind_cols(as.data.frame(x[i, "anova"][["anova"]][[1]]) %>% 
                    rownames_to_column() %>% 
                    setNames(c("var","df","deviance", "resid_df", "resid_dev","pr_chi"))) %>% 
        left_join(top, by="species") %>% 
        group_by(species, efficiency) %>%
        mutate(expl_dev = (first(resid_dev) - resid_dev)/dplyr::first(resid_dev) )

    )
}

anovaf <- data.frame(stringsAsFactors = FALSE)
for (i in 1:nrow(x)) {
  anovaf <-
    bind_rows(
      anovaf,
      data.frame(species    = as.character(paste(x[i, "species"][["species"]]))) %>% 
        mutate(efficiency = scales::percent(x[i, "efficiency"][["efficiency"]], accuracy=0.1)) %>% 
        bind_cols(as.data.frame(x[i, "anovaf"][["anovaf"]][[1]]) %>% 
                    rownames_to_column() %>% 
                    setNames(c("var","df","deviance", "resid_df", "resid_dev","F", "pr(>F)"))) %>% 
        left_join(top, by="species") %>% 
        group_by(species, efficiency) %>%
        mutate(expl_dev = (first(resid_dev) - resid_dev)/dplyr::first(resid_dev) )
    )
}

# for (i in 1:nrow(x)) {
#   anova <-
#     bind_rows(
#       anova,
#       data.frame(species    = as.character(paste(x[i, "species"][["species"]]))) %>% 
#         mutate(efficiency = scales::percent(x[i, "efficiency"][["efficiency"]], accuracy=0.1)) %>% 
#         bind_cols(as.data.frame(x[i, "anova"][["anova"]][[1]]) %>% 
#                     rownames_to_column() %>% 
#                     setNames(c("var","df","deviance", "resid_df", "resid_dev","pr_chi"))) %>% 
#         left_join(top, by="species") 
# 
#     )
# }

# aic data.frame (no difference between efficiencies?)
aic <- data.frame(stringsAsFactors = FALSE)
for (i in 1:nrow(x)) {
  aic <-
    bind_rows(
      aic,
      data.frame(species    = as.character(paste(x[i, "species"][["species"]]))) %>% 
        mutate(efficiency = scales::percent(x[i, "efficiency"][["efficiency"]], accuracy=0.1)) %>% 
        mutate(aic        = as.integer(x[i, "aic"][["aic"]][[1]]))
    )
}

# significance
significance <-
  anova %>% 
  drop_na(pr_chi) %>% 
  dplyr::select(species, efficiency, var, pr_chi) %>% 
  mutate(signific = ifelse(pr_chi <= 0.05, TRUE, FALSE))

nonsignificant <-
  significance %>% 
  filter(signific==FALSE)


# residuals data.frame
i <- 1
resid <- data.frame(stringsAsFactors = FALSE)
for (i in 1:nrow(x)) {
  resid <-
    bind_rows(
      resid,
      data.frame(species    = as.character(paste(x[i, "species"][["species"]]))) %>% 
        mutate(efficiency = scales::percent(x[i, "efficiency"][["efficiency"]], accuracy=0.1)) %>% 
        bind_cols(x[i, "augmented"][["augmented"]] %>% 
                    as.data.frame() %>% 
                    dplyr::select(.fitted, .resid)
                  ) %>%  
        left_join(top, by="species")
    )
}


```

\newpage

**Final GLM Models for to flyshoot fishery**

The standardized CPUE for the different species, taking into account the significant factors per species, are shown in the figure below. If this figure is compared to `r fig_nums("cpue1", display="cite")`, it becomes clear that standardized CPUE may differ from raw CPUE. For the four main target species in the overall flyshoot fishery (i.e. the top row in the figure), catch rates for European squid and Surmullet have decreased in the recent period whereas the catch rates for mackerel and Common cuttlefish have increased.  

For several species, we can observe a general decline in catch rates. Those species are mostly non-target species for the flyshoot fishery. 

```{r timetrends, echo=FALSE, fig.asp=1.2, message=FALSE, warning=FALSE, comment=NA}

fig_nums(name    = "timetrends", level = 1, display = FALSE, 
         caption = " Standardized CPUE time trends (landings/day) by species, taking into account significant factors for the different species.")

pp <-
  bind_rows(
    pred0     %>% mutate(model="zero"),
    pred1     %>% mutate(model="first"),
    pred2     %>% mutate(model="second"),
    pred3     %>% mutate(model="third"),
    predfinal %>% mutate(model="final")
  ) %>%
  mutate(model = factor(model, levels=c("zero","first","second","third","final"))) %>%
  mutate(year = as.integer(as.character(year))) %>%
  # filter(regulated == "NR") %>%

  ggplot(aes(x=year, y=est, group=model)) +
  theme_publication() +
  theme(plot.margin = margin(1,1,1,1, "mm")) +
  theme(plot.title = element_text(hjust = 0.0)) +
  # theme(legend.position="none") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +

  geom_line(aes(colour=as.factor(model))) +
  geom_point(aes(colour=as.factor(model))) +
  geom_ribbon(aes(ymin=lwr, ymax=upr, fill=as.factor(model)), alpha=0.2) +

  expand_limits(y=0) +
  scale_x_continuous(breaks=seq(min(as.integer(ac(years$year))), max(as.integer(ac(years$year))),1)) +
  labs(x="", y="landings/day (kg)", title="CPUE", fill="model") +
  facet_wrap(~englishspecies, scales="free_y", ncol=5)

png(filename=file.path(figuresdir, "CPUE timetrends stepwise.png"),
     width=12.5, height=5.5, units="in", res=300, bg="transparent")
print( pp + 
         theme(plot.background = element_blank()) +
         theme(panel.background = element_blank())) 
invisible(dev.off())

jpeg(filename=file.path(figuresdir, "CPUE timetrends stepwise.jpg"),
     width=10, height=8, units="in", res=300)
print( pp) 
invisible(dev.off())
  
pp <-
  predfinal %>% 
  mutate(year = as.integer(as.character(year))) %>% 

  ggplot(aes(x=year, y=est, group=efficiency)) +
  theme_publication() +
  theme(plot.margin = margin(1,1,1,1, "mm")) +
  theme(plot.title = element_text(hjust = 0.0)) +
  theme(legend.position="none") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  
  geom_line(aes(colour=as.factor(efficiency))) +
  geom_point(aes(colour=as.factor(efficiency))) +
  geom_ribbon(aes(ymin=lwr, ymax=upr, fill=as.factor(efficiency)), alpha=0.2) +
  
  expand_limits(y=0) +
  scale_x_continuous(breaks=seq(min(as.integer(ac(years$year))), max(as.integer(ac(years$year))),1)) +
  labs(x="", y="landings/day (kg)", title="Standardized CPUE") +
  facet_wrap(~englishspecies, scales="free_y", ncol=4)

png(filename=file.path(figuresdir, "CPUE timetrends.png"),
     width=12.5, height=5.5, units="in", res=300, bg="transparent")
print( pp + 
         theme(plot.background = element_blank()) +
         theme(panel.background = element_blank())) 
invisible(dev.off())

jpeg(filename=file.path(figuresdir, "CPUE timetrends.jpg"),
     width=10, height=8, units="in", res=300)
print( pp) 
invisible(dev.off())

print(pp)

# ggridges plot
pp <-
  predfinal %>% 
  mutate(year = as.integer(as.character(year))) %>% 

  group_by(englishspecies) %>% 
  mutate(
    est = est/mean(est, na.rm=TRUE),
    upr = upr/mean(upr, na.rm=TRUE),
    lwr = lwr/mean(lwr, na.rm=TRUE)
  ) %>% 
  # View()
  ggplot(aes(x=year, y=(englishspecies), group=(englishspecies))) +
  theme_publication() +
  theme(plot.margin = margin(1,1,1,1, "mm")) +
  theme(plot.title = element_text(hjust = 0.0)) +
  theme(legend.position="none") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  
  ggridges::geom_ridgeline(aes(height=est), scale=0.5, fill="lightgray", alpha=0.5) + 
  
  scale_x_continuous(breaks=seq(min(as.integer(ac(years$year))), max(as.integer(ac(years$year))),1)) +
  labs(x="", y="", title="relative CPUE by species") 

png(filename=file.path(figuresdir, "CPUE timetrends ggridges.png"),
     width=12.5, height=5.5, units="in", res=300, bg="transparent")
print( pp + 
         theme(plot.background = element_blank()) +
         theme(panel.background = element_blank())) 
invisible(dev.off())

jpeg(filename=file.path(figuresdir, "CPUE timetrends ggridges.jpg"),
     width=8, height=8, units="in", res=300)
print( pp) 
invisible(dev.off())


```

_`r fig_nums("timetrends")`_

\newpage

**Observed vs. predicted catch rates**

The observed vs. predicted catch rates are a diagnostic to assess how well the GLM model is fitting to the data. Ideally, one would expect the values to be close to the 1:1 line (blue dotted line). The explained deviance (blue text) describes the proportion of the deviance that is explained by the model. The four main target species (SQR, MUR, CTC, MAC) have explained deviances of 51, 39, 66 and 39% respectively. This indicates that the GLM models can provide some explanation of the variance in the data. 

For most species, we observe some overprediction of catch rates at lower values, for example, for red mullet (surmullet MUR), mackerel and horse mackerel. It is not well understood what drivers lead to these patterns. 

Overall, the patterns observed in CPUE for the species shown, make it difficult to interpret the CPUE as indicator of abundance, because the targeting behaviour and the quota limitations may affect the catch rates in different ways in different years. 

```{r obspred, echo=FALSE, fig.asp=1.2, message=FALSE, warning=FALSE, comment=NA, results='hide'}

fig_nums(name    = "obspred", level = 1, display = FALSE, 
         caption = "Observed versus predicted catch rates (landings per day) for the different species. The blue dashed line indicates the perfect link between observed and predicted catch rates. The explained deviance is show as blue text." )

exd <-
  anova %>% 
  group_by(englishspecies) %>% 
  summarise(expl_dev= max(expl_dev, na.rm=TRUE)) %>% 
  mutate(englishspecies = factor(englishspecies, levels=top$englishspecies))

pp <-
  obspred %>% 
  rename(obs=catch) %>% 
  filter(efficiency==0) %>% 

  ggplot(aes(x=obs, y=pred, group=efficiency)) +
  theme_publication() +
  theme(plot.margin = margin(1,1,1,1, "mm")) +
  theme(plot.title = element_text(hjust = 0.0)) +
  theme(legend.position="none") +
  
  geom_point(aes(colour=as.factor(efficiency)), alpha=0.2) +
  geom_abline(slope=1, colour="blue", linetype="dashed") +
  geom_text(data=exd,
            aes(x=10, y=Inf, label=paste0("expl. dev: ", scales::percent(expl_dev, accuracy=1))),
            inherit.aes = FALSE, hjust=0,vjust=1, colour="blue") +
  scale_x_continuous(limits=c(10,10000), trans='log10') +
  scale_y_continuous(limits=c(10,10000), trans='log10') +
  labs(x="", y="Predicted landings/day (kg)", title="Observed vs. Predicted CPUE") +
  facet_wrap(~englishspecies, ncol=5)

png(filename=file.path(figuresdir, "CPUE obspred.png"),
     width=12.5, height=5.5, units="in", res=300, bg="transparent")
print( pp + 
         theme(plot.background = element_blank()) +
         theme(panel.background = element_blank())) 
invisible(dev.off())

jpeg(filename=file.path(figuresdir, "CPUE obspred.jpg"),
     width=10, height=8, units="in", res=300)
print( pp) 
invisible(dev.off())

print(pp)

```

_`r fig_nums("obspred")`_

\newpage

# Discussion

The objective of this work was to analyse the electronic logbook data of the Jaczon Flyshoot vessel for trends in spatial and temporal dynamics. The electronic logbook data for the years 2012-2022 has been compiled. The data contains information on catch and effort per vessel, rectangle, species and day. Average price information by vessel and year has been used to convert landings to revenue.  

An overview of the available data has been presented in the Material and Methods section. The data was available for the vessels SCH65, SL9, SCH135, Z99 and years 2012-2022. For the years 2012-2016, data was only available for two vessels (SCH65 and SL9), from 2017 onwards, data became available for the SCH135 and the Z99 was added in 2022.. The data coverage is not complete. The year 2012 is only covered for part of the year and the data for 2015-2017 is also incomplete for some vessels. 

For each year, the proportion of weeks targeting a certain species was calculated. The target species of a vessel-year-week combination was derived by determining the species with the highest revenue for each vessel-year-week combination. Then the number of vessel-year-week-target combinations were counted and expresses as percentages per year and species. European Squid (SQR), Surmullet (MUR) and mackerel (MAC) have been the main target species during the period considered, with Cuttlefish (CTC) increasing in importance from 2018 onwards. The number of Tub gurnard targeted weeks has declined over time. 

The analytical approach to estimating catch rates (Catch per Unit of Effort CPUE) was initiated by transforming all the catch (=landing) data to the total landings per vessel, per species, per rectangle and per week. In addition we counted the number of fishing days per vessel, per rectangle and per week. Catch rate is then expressed as the catch divided by effort.

Modelling was based on Generalized Linear Model (GLM) tools, whereby the predicted variable is the catch per week, effort was included as a log-link function and year as used as the main factor to describe the time trend. Then we explored other potential explanatory factors (vessel, latitude, longitude, rectangle, quarter and target species) by sequentially adding different factors. We explored the AIC criteria for the different factors for each of the species and selected those factors by species that had the lowest AIC. Then we repeated this process for the second and third explanatory factor. In all cases we evaluated whether the factor contributed significantly (<5%) to the model.

The standardized CPUE for the different species, taking into account the significant factors per species, are shown in `r fig_nums("timetrends", display="cite")`. If that figure is compared to `r fig_nums("cpue1", display="cite")` with the raw catch rates, it is clear that standardized CPUE may differ from raw CPUE. For the  main target species in the overall flyshoot fishery (i.e. the top row in the figure), catch rates for European squid and Surmullet have decreased in the recent period whereas the catch rates for mackerel and Common cuttlefish have increased. For several species, we can observe a general decline in catch rates. Those species are mostly non-target species for the flyshoot fishery.

The observed vs. predicted catch rates are a diagnostic to assess how well the GLM model is fitting to the data. Ideally, one would expect the values to be close to the 1:1 line (blue dotted line). The explained deviance (blue text) describes the proportion of the deviance that is explained by the model. The four main target species (SQR, MUR, CTC, MAC) have explained deviances of 51, 39, 66 and 39% respectively. This indicates that the GLM models can provide some explanation of the variance in the data.

For several species, we observe some overprediction of catch rates at lower values, for example, for red mullet (surmullet MUR), mackerel and horse mackerel. It is not well understood what drivers lead to these patterns.
Overall, the patterns observed in CPUE for the species shown, make it difficult to interpret the CPUE as indicator of abundance, because the targeting behaviour and the quota limitations may affect the catch rates in different ways in different years.

However, the information from the logbooks does provide usable information on the spatial distribution of the fishery and the catches by species. For example, in `r fig_nums("catch6", display="cite")`, we can see that the spatial distribution of cuttlefish catches are quite distinct from most other species, thereby indicating that the CPUE for cuttlefish may a very different from other species.  

An important consideration for the overall analysis, is that the logbook information only contains data on the landed catch. This is in fact a severe limitation on the possibility to interpret the results as indicators of abundance because an unknown part of the catch may not have been landed. 

In a future study, we will compare the trends in CPUE with the trends observed in the survey in the area. 




\newpage

**Annex: Detailed results by species (FLYSHOOT fishery CPUE analysis `r folder`)**

In the following sections, we are presenting detailed results by species. The presentation will consist of:

* a map of catch rates by rectangle and year
* the GLM estimated time trend in catch rate
* the estimated GLM coefficients
* the observed vs. predicted catch rates
* the ANOVA Analysis of Deviance table.  

We are presenting information on the top 8 species of the flyshoot fishery: 

```{r}
top %>% 
  slice_head(n=8) %>% 
  dplyr::select(-englishspecies) %>% 
  pander::pandoc.table(style="simple", split.tables=400, justify="left")

```


<!-- =============================================================================================== --> 

<!-- Prepare the detailed results --> 

```{r detailed, echo=FALSE, fig.asp=1.4, message=FALSE, warning=FALSE, comment=NA}

fig_nums(name    = "detailed", level = 1, display = FALSE, caption = "GLM, detailed")

# i <- 1; sp <- as.character(top$englishspecies[i])

# run by species
if(recalculatemaps == TRUE) {
  for (sp in top$englishspecies[1:8]) {

    # print(paste(i, sp))
    
    sp2 <- filter(top, englishspecies==sp) %>% dplyr::select(species) %>% as.character()
    reg <- filter(regulated, species==sp2) %>% dplyr::select(regulated) %>% as.character()
    
    # cpue map
    tmap <-
      catch_byweek %>% 
      mutate(englishspecies = paste(englishname, species)) %>% 
      filter(englishspecies == sp) %>%
      group_by(regulated, englishspecies, rect, lat, lon, year) %>% 
      summarise(
        catch = sum(catch, na.rm=TRUE),
        effort = sum(effort, na.rm=TRUE)
      ) %>% 
      ungroup() %>%
      mutate(
        cpue = catch/effort
      ) %>% 
      left_join(rect_lr_sf, by=c("rect"= "ICESNAME")) %>% 
      dplyr::select(-ID, -SOUTH, -NORTH, -WEST, -EAST) %>% 
      
      tidyr::complete(year, nesting(englishspecies), fill=list(cpue=0.1)) %>% 
      
      # mutate(catch_interval = cut(as.integer(catch), breaks=c(1 %o% 10^(0:12)), dig.lab=10 ) ) %>% 
      mutate(., cpue_interval = 
                     cut(cpue, 
                         scales::trans_breaks("sqrt", function(x) x ^ 2)(c(0, max(cpue, na.rm=TRUE))), 
                         dig.lab=10 ) ) %>% 
      sf::st_as_sf()
    
    # levels / breaks
    lvl <- sort(unique(tmap$cpue_interval))
  
    # bounding box
    bb <- sf::st_bbox(tmap)
    
    tt <-
      tmap %>%
      group_by(regulated, englishspecies, year) %>% 
      summarise(cpue = as.integer(mean(cpue, na.rm=TRUE))) %>% 
      sf::st_drop_geometry()
    
    p0 <- 
      tmap %>% 
      drop_na() %>% 
  
      ggplot() +
      theme_publication() +
      theme(plot.margin = margin(1,1,1,1, "mm")) +
      geom_sf(data=world_mr_sf, font = "Arial") +
      geom_sf(aes(fill=cpue_interval), font = "Arial", alpha=0.6) +
      geom_point(aes(size = cpue, geometry = geometry), stat = "sf_coordinates", shape=1, font = "Arial") + 
      geom_text(data=tt, 
                aes(x=-Inf, y=Inf, label=paste(cpue,"kg/day")), 
                hjust=0, vjust=1) +
      coord_sf(xlim=c(bb$xmin,bb$xmax), ylim=c(bb$ymin, bb$ymax)) + 
      scale_fill_viridis(option = "plasma", direction = -1, discrete=TRUE, breaks=lvl, limits=lvl) +
      guides(fill=guide_legend(nrow = 1), size = "none") + 
      labs(x="", y="", 
           title=paste0("Average catch/day (kg): ", 
                        sp, 
                        ", (",
                        ifelse(reg=="NR","Non-regulated", "Regulated"),")"), 
           fill="CPUE (kg/day)") +
      facet_wrap(~year, ncol=4)
      
    jpeg(filename=file.path(figuresdir, paste(sp, "cpuemap.jpg", sep="_")),
         width=10, height=10, units="in", res=300)
    print(p0)
    invisible(dev.off())
   
    # year trend
    p1 <-
      predfinal %>% 
      filter(englishspecies    == sp) %>% 
      # left_join(top, by="species") %>% 
      mutate(year = as.integer(as.character(year))) %>% 
      
      ggplot(aes(x=year, y=est, group=efficiency)) +
      theme_publication() +
      theme(plot.margin = margin(1,1,1,1, "mm")) +
      theme(legend.direction="vertical") +
      theme(legend.justification=c(1,1), legend.position=c(0.95 ,0.95)) +
      theme(strip.background = element_blank(), strip.text.x = element_blank()) +
      
      geom_line(aes(colour=as.factor(efficiency))) +
      geom_point(aes(colour=as.factor(efficiency))) +
      geom_ribbon(aes(ymin=lwr, ymax=upr, fill=as.factor(efficiency)), alpha=0.2) +
      expand_limits(y=0) +
      scale_x_continuous(breaks=seq(min(as.integer(ac(years$year))), max(as.integer(ac(years$year))),2)) +
      labs(fill="efficiency", colour="efficiency", y="catch/day", x="") 
    
    jpeg(filename=file.path(figuresdir, paste(sp, "cpuetrend.jpg", sep="_")),
         width=10, height=4, units="in", res=300)
    print(p1)
    invisible(dev.off())
    
    # factors/parameters
    p2 <-
      coeff %>% 
      filter(englishspecies    == sp) %>% 
      # filter(species    == as.character(x[i, "species"][["species"]])) %>% 
      filter(!is.na(value)) %>% 
      filter(var != "year") %>% 
      filter(efficiency==0) %>% 
      
      ggplot(aes(x=value, y=data, group=efficiency)) +
      theme_publication() +
      theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
      theme(legend.position = "none") +
      theme(plot.margin = margin(1,1,1,1, "mm")) +
      
      # geom_line(aes(colour=as.factor(efficiency))) +
      geom_point(aes(colour=as.factor(efficiency)), size=2) +
      labs(x="", y="coefficient")  +
      facet_grid(.~var, scales = "free_x", space = "free_x")
    
    jpeg(filename=file.path(figuresdir, paste(sp, "cpuecoefficients.jpg", sep="_")),
         width=10, height=3, units="in", res=300)
    print(p2)
    invisible(dev.off())
  
    # obs vs predicted
    p3 <-
      obspred %>% 
      # left_join(top, by="species") %>% 
      filter(englishspecies    == sp) %>% 
      rename(obs=catch) %>% 
      filter(efficiency==0) %>% 
      
      ggplot(aes(x=obs, y=pred, group=efficiency)) +
      theme_publication() +
      theme(plot.margin = margin(1,1,1,1, "mm")) +
      theme(legend.position = "none") +
      geom_point(aes(colour=as.factor(efficiency)), alpha=0.2) +
      geom_abline(slope=1, colour="blue", linetype="dashed") +
      scale_x_continuous(limits=c(10,10000), trans='log10') +
      scale_y_continuous(limits=c(10,10000), trans='log10') 
      # expand_limits(x=0,y=0) +
      # facet_wrap(~englishspecies)
  
    jpeg(filename=file.path(figuresdir, paste(sp, "cpueobspred.jpg", sep="_")),
         width=5, height=5, units="in", res=300)
    print(p3)
    invisible(dev.off())
    
    # print(p0 + p1 + p2   + plot_layout(ncol = 1, heights = unit(c(14, 8, 4), c('null'))))
    # print( p1 / (p2 | p3)   + plot_layout(heights = unit(c(10, 10), c('null'))))
    
    jpeg(filename=file.path(figuresdir, paste(sp, "cpuecomb.jpg", sep="_")),
         width=10, height=5, units="in", res=300)
    print( (p2 | p3)   + plot_layout(heights = unit(c(10, 10), c('null'))))
    dev.off()

    # anova
    fileConn<-file(file.path(tablesdir, paste(sp, "anova.txt", sep="_")))
    print(x[x$species==sp2, "anova"][["anova"]][[1]]) %>% 
      capture.output() %>%
      writeLines(., con=fileConn)
    invisible(close(fileConn))
    
  } # end of loop over species
} # end of recalculatemaps

```

\newpage

<!-- Squid (SQR) --> 

```{r echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}
i   <- 1
sp  <- top$englishspecies[i] 
sp2 <- filter(top, englishspecies==sp) %>% dplyr::select(species) %>% as.character()
sp3 <- paste(top$englishname[i], top$dutchname[i], top$species[i], sep=" / ")

```

**`r sp3`**

```{r echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}

fig_nums(
  name    = paste0(sp, "cpue"), level = 1, display = FALSE,
  caption = paste(sp, "CPUE by year and rectangle (kg/day) and standardized CPUE trend by year (kg/day)"))

knitr::include_graphics(path=file.path(figuresdir, paste(top$englishspecies[[i]], "cpuemap.jpg", sep="_")))
```

```{r echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}
knitr::include_graphics(path=file.path(figuresdir, paste(top$englishspecies[[i]], "cpuetrend.jpg", sep="_")))
```

_`r fig_nums(paste0(sp, "cpue"))`_

\newpage

```{r echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}
fig_nums(
  name    = paste0(sp, "comb"), level = 1, display = FALSE,
  caption = paste(sp, "GLM coefficients for rectangles (left) and observed vs. predicted CPUE values (kg/day)"))

knitr::include_graphics(path=file.path(figuresdir, paste(top$englishspecies[[i]], "cpuecomb.jpg", sep="_")))
```

_`r fig_nums(paste0(sp, "comb"))`_

```{r echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}
tab_nums(
  name    = paste0(sp, "anova"), level = 1, display = FALSE,
  caption = paste(sp, "Anova table of CPUE GLM by year and rectangle (kg/day) "))
    
  cat(readLines(file.path(tablesdir, paste(sp, "anova.txt", sep="_"))), sep = '\n')

```

_`r tab_nums(paste0(sp, "anova"))`_

<!-- =============================================================================================== --> 

\newpage

<!-- Surmullet (MUR) --> 

```{r echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}

i   <- 2
sp  <- top$englishspecies[i] 
sp2 <- filter(top, englishspecies==sp) %>% dplyr::select(species) %>% as.character()
sp3 <- paste(top$englishname[i], top$dutchname[i], top$species[i], sep=" / ")

```

**`r sp3`**

```{r echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}

fig_nums(
  name    = paste0(sp, "cpue"), level = 1, display = FALSE,
  caption = paste(sp, "CPUE by year and rectangle (kg/day) and standardized CPUE trend by year (kg/day)"))

knitr::include_graphics(path=file.path(figuresdir, paste(top$englishspecies[[i]], "cpuemap.jpg", sep="_")))
```

```{r echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}
knitr::include_graphics(path=file.path(figuresdir, paste(top$englishspecies[[i]], "cpuetrend.jpg", sep="_")))
```

_`r fig_nums(paste0(sp, "cpue"))`_

\newpage

```{r echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}
fig_nums(
  name    = paste0(sp, "comb"), level = 1, display = FALSE,
  caption = paste(sp, "GLM coefficients for rectangles (left) and observed vs. predicted CPUE values (kg/day)"))

knitr::include_graphics(path=file.path(figuresdir, paste(top$englishspecies[[i]], "cpuecomb.jpg", sep="_")))
```

_`r fig_nums(paste0(sp, "comb"))`_

```{r echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}
tab_nums(
  name    = paste0(sp, "anova"), level = 1, display = FALSE,
  caption = paste(sp, "Anova table of CPUE GLM by year and rectangle (kg/day) "))

  cat(readLines(file.path(tablesdir, paste(sp, "anova.txt", sep="_"))), sep = '\n')
```

_`r tab_nums(paste0(sp, "anova"))`_

<!-- =============================================================================================== --> 

\newpage

<!-- Cuttlefish (CTC) --> 

```{r echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}
i   <- 3
sp  <- top$englishspecies[i] 
sp2 <- filter(top, englishspecies==sp) %>% dplyr::select(species) %>% as.character()
sp3 <- paste(top$englishname[i], top$dutchname[i], top$species[i], sep=" / ")

```

**`r sp3`**

```{r echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}

fig_nums(
  name    = paste0(sp, "cpue"), level = 1, display = FALSE,
  caption = paste(sp, "CPUE by year and rectangle (kg/day) and standardized CPUE trend by year (kg/day)"))

knitr::include_graphics(path=file.path(figuresdir, paste(top$englishspecies[[i]], "cpuemap.jpg", sep="_")))
```

```{r echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}
knitr::include_graphics(path=file.path(figuresdir, paste(top$englishspecies[[i]], "cpuetrend.jpg", sep="_")))
```

_`r fig_nums(paste0(sp, "cpue"))`_

\newpage

```{r echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}
fig_nums(
  name    = paste0(sp, "comb"), level = 1, display = FALSE,
  caption = paste(sp, "GLM coefficients for rectangles (left) and observed vs. predicted CPUE values (kg/day)"))

knitr::include_graphics(path=file.path(figuresdir, paste(top$englishspecies[[i]], "cpuecomb.jpg", sep="_")))
```

_`r fig_nums(paste0(sp, "comb"))`_

```{r echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}
tab_nums(
  name    = paste0(sp, "anova"), level = 1, display = FALSE,
  caption = paste(sp, "Anova table of CPUE GLM by year and rectangle (kg/day) "))

  cat(readLines(file.path(tablesdir, paste(sp, "anova.txt", sep="_"))), sep = '\n')
```

_`r tab_nums(paste0(sp, "anova"))`_

<!-- =============================================================================================== --> 

\newpage

<!-- Mackerel (MAC) --> 

```{r echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}
i   <- 4
sp  <- top$englishspecies[i] 
sp2 <- filter(top, englishspecies==sp) %>% dplyr::select(species) %>% as.character()
sp3 <- paste(top$englishname[i], top$dutchname[i], top$species[i], sep=" / ")

```

**`r sp3`**

```{r echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}

fig_nums(
  name    = paste0(sp, "cpue"), level = 1, display = FALSE,
  caption = paste(sp, "CPUE by year and rectangle (kg/day) and standardized CPUE trend by year (kg/day)"))

knitr::include_graphics(path=file.path(figuresdir, paste(top$englishspecies[[i]], "cpuemap.jpg", sep="_")))
```

```{r echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}
knitr::include_graphics(path=file.path(figuresdir, paste(top$englishspecies[[i]], "cpuetrend.jpg", sep="_")))
```

_`r fig_nums(paste0(sp, "cpue"))`_

\newpage

```{r echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}
fig_nums(
  name    = paste0(sp, "comb"), level = 1, display = FALSE,
  caption = paste(sp, "GLM coefficients for rectangles (left) and observed vs. predicted CPUE values (kg/day)"))

knitr::include_graphics(path=file.path(figuresdir, paste(top$englishspecies[[i]], "cpuecomb.jpg", sep="_")))
```

_`r fig_nums(paste0(sp, "comb"))`_

```{r echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}
tab_nums(
  name    = paste0(sp, "anova"), level = 1, display = FALSE,
  caption = paste(sp, "Anova table of CPUE GLM by year and rectangle (kg/day) "))

  cat(readLines(file.path(tablesdir, paste(sp, "anova.txt", sep="_"))), sep = '\n')
```

_`r tab_nums(paste0(sp, "anova"))`_

<!-- =============================================================================================== --> 

\newpage

<!-- Tub gurnard (GUU) --> 

```{r echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}
i   <- 5
sp  <- top$englishspecies[i] 
sp2 <- filter(top, englishspecies==sp) %>% dplyr::select(species) %>% as.character()
sp3 <- paste(top$englishname[i], top$dutchname[i], top$species[i], sep=" / ")

```

**`r sp3`**

```{r echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}

fig_nums(
  name    = paste0(sp, "cpue"), level = 1, display = FALSE,
  caption = paste(sp, "CPUE by year and rectangle (kg/day) and standardized CPUE trend by year (kg/day)"))

knitr::include_graphics(path=file.path(figuresdir, paste(top$englishspecies[[i]], "cpuemap.jpg", sep="_")))
```

```{r echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}
knitr::include_graphics(path=file.path(figuresdir, paste(top$englishspecies[[i]], "cpuetrend.jpg", sep="_")))
```

_`r fig_nums(paste0(sp, "cpue"))`_

\newpage

```{r echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}
fig_nums(
  name    = paste0(sp, "comb"), level = 1, display = FALSE,
  caption = paste(sp, "GLM coefficients for rectangles (left) and observed vs. predicted CPUE values (kg/day)"))

knitr::include_graphics(path=file.path(figuresdir, paste(top$englishspecies[[i]], "cpuecomb.jpg", sep="_")))
```

_`r fig_nums(paste0(sp, "comb"))`_

```{r echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}
tab_nums(
  name    = paste0(sp, "anova"), level = 1, display = FALSE,
  caption = paste(sp, "Anova table of CPUE GLM by year and rectangle (kg/day) "))

  cat(readLines(file.path(tablesdir, paste(sp, "anova.txt", sep="_"))), sep = '\n')
```

_`r tab_nums(paste0(sp, "anova"))`_

<!-- =============================================================================================== --> 

\newpage

<!-- Whiting (WHG) --> 

```{r echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}
i   <- 6
sp  <- top$englishspecies[i] 
sp2 <- filter(top, englishspecies==sp) %>% dplyr::select(species) %>% as.character()
sp3 <- paste(top$englishname[i], top$dutchname[i], top$species[i], sep=" / ")

```

**`r sp3`**

```{r echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}

fig_nums(
  name    = paste0(sp, "cpue"), level = 1, display = FALSE,
  caption = paste(sp, "CPUE by year and rectangle (kg/day) and standardized CPUE trend by year (kg/day)"))

knitr::include_graphics(path=file.path(figuresdir, paste(top$englishspecies[[i]], "cpuemap.jpg", sep="_")))
```

```{r echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}
knitr::include_graphics(path=file.path(figuresdir, paste(top$englishspecies[[i]], "cpuetrend.jpg", sep="_")))
```

_`r fig_nums(paste0(sp, "cpue"))`_

\newpage

```{r echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}
fig_nums(
  name    = paste0(sp, "comb"), level = 1, display = FALSE,
  caption = paste(sp, "GLM coefficients for rectangles (left) and observed vs. predicted CPUE values (kg/day)"))

knitr::include_graphics(path=file.path(figuresdir, paste(top$englishspecies[[i]], "cpuecomb.jpg", sep="_")))
```

_`r fig_nums(paste0(sp, "comb"))`_

```{r echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}
tab_nums(
  name    = paste0(sp, "anova"), level = 1, display = FALSE,
  caption = paste(sp, "Anova table of CPUE GLM by year and rectangle (kg/day) "))

  cat(readLines(file.path(tablesdir, paste(sp, "anova.txt", sep="_"))), sep = '\n')
```

_`r tab_nums(paste0(sp, "anova"))`_

\newpage

<!-- Horse mackerel (HOM) --> 

```{r echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}
i   <- 7
sp  <- top$englishspecies[i] 
sp2 <- filter(top, englishspecies==sp) %>% dplyr::select(species) %>% as.character()
sp3 <- paste(top$englishname[i], top$dutchname[i], top$species[i], sep=" / ")

```

**`r sp3`**

```{r echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}

fig_nums(
  name    = paste0(sp, "cpue"), level = 1, display = FALSE,
  caption = paste(sp, "CPUE by year and rectangle (kg/day) and standardized CPUE trend by year (kg/day)"))

knitr::include_graphics(path=file.path(figuresdir, paste(top$englishspecies[[i]], "cpuemap.jpg", sep="_")))
```

```{r echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}
knitr::include_graphics(path=file.path(figuresdir, paste(top$englishspecies[[i]], "cpuetrend.jpg", sep="_")))
```

_`r fig_nums(paste0(sp, "cpue"))`_

\newpage

```{r echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}
fig_nums(
  name    = paste0(sp, "comb"), level = 1, display = FALSE,
  caption = paste(sp, "GLM coefficients for rectangles (left) and observed vs. predicted CPUE values (kg/day)"))

knitr::include_graphics(path=file.path(figuresdir, paste(top$englishspecies[[i]], "cpuecomb.jpg", sep="_")))
```

_`r fig_nums(paste0(sp, "comb"))`_

```{r echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}
tab_nums(
  name    = paste0(sp, "anova"), level = 1, display = FALSE,
  caption = paste(sp, "Anova table of CPUE GLM by year and rectangle (kg/day) "))

  cat(readLines(file.path(tablesdir, paste(sp, "anova.txt", sep="_"))), sep = '\n')
```

_`r tab_nums(paste0(sp, "anova"))`_


\newpage

<!-- Seabass (BSS) --> 

```{r echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}
i   <- 8
sp  <- top$englishspecies[i] 
sp2 <- filter(top, englishspecies==sp) %>% dplyr::select(species) %>% as.character()
sp3 <- paste(top$englishname[i], top$dutchname[i], top$species[i], sep=" / ")

```

**`r sp3`**

```{r echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}

fig_nums(
  name    = paste0(sp, "cpue"), level = 1, display = FALSE,
  caption = paste(sp, "CPUE by year and rectangle (kg/day) and standardized CPUE trend by year (kg/day)"))

knitr::include_graphics(path=file.path(figuresdir, paste(top$englishspecies[[i]], "cpuemap.jpg", sep="_")))
```

```{r echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}
knitr::include_graphics(path=file.path(figuresdir, paste(top$englishspecies[[i]], "cpuetrend.jpg", sep="_")))
```

_`r fig_nums(paste0(sp, "cpue"))`_

\newpage

```{r echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}
fig_nums(
  name    = paste0(sp, "comb"), level = 1, display = FALSE,
  caption = paste(sp, "GLM coefficients for rectangles (left) and observed vs. predicted CPUE values (kg/day)"))

knitr::include_graphics(path=file.path(figuresdir, paste(top$englishspecies[[i]], "cpuecomb.jpg", sep="_")))
```

_`r fig_nums(paste0(sp, "comb"))`_

```{r echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}
tab_nums(
  name    = paste0(sp, "anova"), level = 1, display = FALSE,
  caption = paste(sp, "Anova table of CPUE GLM by year and rectangle (kg/day) "))

  cat(readLines(file.path(tablesdir, paste(sp, "anova.txt", sep="_"))), sep = '\n')
```

_`r tab_nums(paste0(sp, "anova"))`_




