---
output:
  word_document:
    reference_docx: ../report_template.dotx
---


```{r setup, include=FALSE}

# =====================================================================================================
# FLYSHOOT CPUE analysis - Channel without modelling
# 
# 11/01/2023 first coding
# 16/03/2023 full GLM modelling of top 15 species in the catch
# 21/04/2023 TO DO: convert totals to total per vessel
# 09/05/2023 Finalized the code to include the reworked Ecatch and Mcatch data (previously problem with number of days)
# 05/12/2023 Removed modelling part
# =====================================================================================================

knitr::opts_chunk$set(echo = FALSE,	message = FALSE,	warning = FALSE,	comment = "",	crop = TRUE )
knitr::opts_chunk$set(fig.width=10) 

options(dplyr.summarise.inform = FALSE)

# Reset lists
rm(list=ls())

recalculatemaps   <- TRUE            # recalculate catch maps (takes relatively long)
toprectanglesonly <- TRUE            # CPUE analysis for top rectangles (by species) only?

# Libraries
library(rmarkdown)                   # note: requires knitr 1.21

require(tidyverse, quietly=TRUE)     # combined package of dplyr, tidyr, ggplot, readr, purrr and tibble
require(lubridate, quietly=TRUE)     # data handling
require(reshape2, quietly=TRUE)      # reshaping data; e.g. cast
require(RColorBrewer)                # colour schemes
library(viridis)
library(pander)
library(patchwork)
library(gridExtra)

library(captioner)                   # for captions
tab_nums <- captioner::captioner(prefix = "Table " , levels=1, type=c("n"), infix=".")
fig_nums <- captioner::captioner(prefix = "Figure ", levels=1, type=c("n"), infix=".")

# Source all the utils
source("../../prf/R/my utils.r")
source("../../mptools/R/get_onedrive.r")
source("../R/FLYSHOOT utils.r")


spatialdir <- "C:/DATA/RDATA"

# spatial data files

load(file.path(spatialdir, "world_lr_sf.RData"))
load(file.path(spatialdir, "world_mr_sf.RData"))
load(file.path(spatialdir, "world_hr_sf.RData"))

load(file.path(spatialdir, "world_mr_df.RData"))
load(file.path(spatialdir, "fao_sf.RData"))
load(file.path(spatialdir, "rect_lr_sf.RData"))
icesrect <-
  rect_lr_sf %>% 
  sf::st_drop_geometry() %>% 
  rename(rect=ICESNAME) %>% 
  mutate(lat = (SOUTH + NORTH)/2) %>% 
  mutate(lon = (EAST + WEST)/2) %>% 
  dplyr::select(rect, lat, lon)


asfis <- 
  loadRData(file.path(spatialdir, "asfis.RData")) %>% 
  rename_all(tolower) %>% 
  mutate(species = tolower(species))

# ===============================================================================
#  Load and filter the trip data
# ===============================================================================

# set onedrive directory
onedrive <- get_onedrive(team="Martin Pastoors", site="FLYSHOOT - General")

# load datasets
haul   <- 
  loadRData(file.path(onedrive, "rdata/haul.RData")) %>%   
  mutate(vessel = ifelse(vessel %in% c("SCH99","Z99"), "SCH99_Z99", vessel)) 

kisten <- 
  loadRData(file.path(onedrive, "rdata/kisten.RData")) %>%   
  mutate(vessel = ifelse(vessel %in% c("SCH99","Z99"), "SCH99_Z99", vessel)) 

elog   <- 
  loadRData(file.path(onedrive, "rdata/elog.RData")) %>% 
  mutate(species = toupper(species)) %>% 
  mutate(species = ifelse(species == "JAX","HOM",species)) %>% 
  mutate(species = ifelse(species == "SQU", "SQR", species)) %>% 
  filter(geartype %in% c("SSC","SDN")) %>% 
  mutate(species = tolower(species)) %>% 
  left_join(dplyr::select(asfis,
                          species, scientificname, englishname, dutchname),
            by = "species") %>% 
  mutate(species = toupper(species))  %>% 
  mutate(vessel = ifelse(vessel %in% c("SCH99","Z99"), "SCH99_Z99", vessel)) %>% 
  
  # remove 348 records without rectangle information
  drop_na(rect) %>% 
  
  sf::st_as_sf(coords = c("lon", "lat"), crs = 4326, remove = FALSE)  %>%  
  
  # get division from rectangle / lat-lon if available
  sf::st_join(filter(fao_sf, F_LEVEL=="DIVISION")) %>%
  sf::st_drop_geometry() %>% 
  rename(division = F_CODE) %>% 
  dplyr::select(-F_LEVEL, -FID, -OCEAN, -SUBOCEAN, -F_AREA, -F_SUBAREA, -F_DIVISION,
                -F_SUBDIVIS, -F_SUBUNIT, -F_STATUS) %>%
  ungroup() %>% 
  
  # handle missing divisions (coastline issues)
  mutate(division = ifelse(is.na(division) & !is.na(faozone), faozone, division))

# skimr::skim(elog)

# elog %>% filter(!is.na(lat.x)) %>% View()
# xlim <- range(elog$lon, na.rm=TRUE)
# ylim <- range(elog$lat, na.rm=TRUE)  
# elog %>% 
#   filter(is.na(division)) %>% 
#   group_by(vessel, year, source, rect, lat, lon) %>% 
#   summarise(weight = sum(weight, na.rm=TRUE)) %>% 
#   ggplot(aes(x=lon, y=lat)) +
#   theme_publication() +
#   coord_quickmap(xlim=xlim , ylim=ylim) +
#   geom_polygon(data=world_mr_df, aes(x=long, y=lat, group=group), fill = "grey75") +
#   geom_point(aes(colour=vessel, size=weight), alpha=0.5) +
#   facet_wrap(~year)

# datasets with price and regulated information derived from read_afslag.r
  
price  <- 
  readr::read_rds(file.path(onedrive, "rdata/prices.rds")) %>% 
  dplyr::select(year, species, avgprice) %>% 
  mutate(price_cat = cut(avgprice, breaks=c(0,0.5, 1,2,3,4,5,10,15,20), dig.lab=10 ))

regulated  <- 
  readr::read_rds(file.path(onedrive, "rdata/prices.rds")) %>% 
  ungroup() %>% 
  dplyr::distinct(species, regulated) 

# skimr::skim(price)

# sort(unique(elog$species))

yrs       <- 2013:2023
mnths     <- NA
vessels   <- NA

divisions <- NA
# divisions <- c("27.7.d", "27.7.e") # fix error in division 4.a
# divisions <- c("27.4.b", "27.4.c")



# Folder for storing figures  
if(!any(is.na(divisions))) {
  folder <- paste("CPUE", paste(divisions, collapse="-"), paste0(year(now()), month(now()), day(now()))) 
} else {
  folder <- paste("CPUE northsea-channel", paste0(year(now()), month(now()), day(now())))
}

dir.create   (file.path(onedrive, "report",folder), showWarnings = FALSE)

dir.create   (file.path(onedrive, "report",folder, "figures"), showWarnings = FALSE)
figuresdir <- file.path(onedrive, "report",folder, "figures")

dir.create  (file.path(onedrive, "report",folder, "tables"), showWarnings = FALSE)
tablesdir <- file.path(onedrive, "report",folder, "tables")

dir.create   (file.path(onedrive, "report",folder, "data"), showWarnings = FALSE)
datadir    <- file.path(onedrive, "report",folder, "data")

# making the data selections
e <- 
  elog %>%
  ungroup() %>% 
  mutate(division =tolower(division)) %>% 
  {if(!is.na(all(vessels))) filter(., vessel %in% vessels) else . } %>% 
  {if(!is.na(all(yrs)))     filter(., year %in% yrs) else . } %>% 
  {if(!is.na(all(mnths)))   filter(., month %in% mnths) else .} %>% 
  {if(!any(is.na(divisions))) filter(., division %in% divisions) else .} %>% 

  left_join(regulated, by="species") %>% 
  mutate(regulated = case_when(
    is.na(regulated) & species %in% c("BSE","DGX","ANF","DGH","HER","PLE")             ~ "R",
    is.na(regulated) & species %in% c("BRB","SBX","SQS","WEX","WEG","SQU","SDV",
                                      "OCT","MUL","SCR","GAG","ANE","SQE","SQC","OCZ") ~ "NR",
    TRUE ~ regulated
  )) %>% 
  ungroup()

# e %>% distinct(species, regulated) %>% filter(is.na(regulated)) %>% View()
# e %>% 
#   filter(vessel=="SCH135", week==1:3, year==2019) %>%  
#   group_by(vessel, year, week, source) %>% 
#   summarise(n=n_distinct(source)) %>% 
#   filter(n > 1) %>%
#   View()
#   # left_join(e, by=c("vessel","year","week")) %>% 
#   group_by(vessel, year, week, source) %>% 
#   summarise(weight = sum(weight, na.rm=TRUE)) %>% 
#   pivot_wider(names_from = source, values_from = weight) %>% 
#   View()


# calculate the scaling of plots

xmin <- floor(2 * (min(e$lon, na.rm=TRUE)-0.5))/2;
xmax <- ceiling(2 * (max(e$lon, na.rm=TRUE)+0.5))/2;
ymin <- floor(2 * (min(e$lat, na.rm=TRUE)-0.5))/2;
ymax <- ceiling(2* (max(e$lat, na.rm=TRUE)+0.5))/2

n <- 15

effort <-
  e %>% 
  dplyr::group_by(vessel, year, week, source) %>% 
  dplyr::summarize(ndays = n_distinct(date)) %>% 
  
  dplyr::group_by(vessel, year) %>% 
  dplyr::summarize(ndays  = sum(ndays, na.rm=TRUE))  %>% 

  ungroup()

catch <-
  e %>% 
  dplyr::group_by(vessel, year, species, 
                  scientificname, englishname, dutchname, regulated) %>% 
  dplyr::summarize(weight = sum(weight, na.rm=TRUE)) %>% 
  dplyr::group_by(vessel, year) %>% 
  dplyr::mutate(perc = weight/sum(weight, na.rm=TRUE)) %>% 
  left_join(effort, by=c("vessel", "year")) %>% 
  mutate(catch_day = weight / ndays) %>% 
  ungroup()

effort_byweek <-
  e %>% 
  dplyr::group_by(vessel, year, quarter, month, week, division, rect, source) %>% 
  dplyr::summarize(effort  = n_distinct(date))  %>% 
  
  # temp fix!!
  mutate(effort = ifelse(source=="m-catch" & year < 2023, 4, effort)) %>% 
  dplyr::group_by(vessel, year, quarter, month, week, division, rect) %>% 
  dplyr::summarize(effort  = sum(effort, na.rm=TRUE))  %>% 
  ungroup()

effort_byweek2 <-
  e %>% 
  dplyr::group_by(vessel, year, week, source) %>% 
  dplyr::summarize(effort  = n_distinct(date))  %>% 
  
  # temp fix!!
  mutate(effort = ifelse(source=="m-catch" & year < 2023, NA, effort)) %>% 
  dplyr::group_by(vessel, year, week) %>% 
  dplyr::summarize(effort  = sum(effort, na.rm=TRUE))  %>% 

  ungroup()

revenue_byweek <-
  e %>% 
  left_join(price, by=c("year","species")) %>% 
  mutate(revenue = weight * avgprice) %>% 
  drop_na(revenue) %>% 
  group_by(vessel, year, week, species) %>% 
  summarise(revenue = sum(revenue, na.rm=TRUE)) %>% 
  ungroup()
    
target_byweek <-
  revenue_byweek %>% 
  group_by(vessel, year, week) %>% 
  arrange(desc(revenue)) %>% 
  slice_head(n=1) %>% 
  dplyr::select(-revenue) %>% 
  rename(target=species)

catch_byweek <-
  e %>% 
  dplyr::group_by(vessel, year, quarter, month, week, division, rect,  
                  species, scientificname, englishname, dutchname, regulated) %>% 
  dplyr::summarize(
    catch = sum(weight, na.rm=TRUE),
    # effort  = n_distinct(date)
  ) %>% 
  left_join(effort_byweek, by=c("vessel","year","quarter","month","week","division","rect")) %>% 
  left_join(icesrect, by="rect") %>% 
  left_join(price, by=c("year","species")) %>% 
  left_join(target_byweek, by=c("vessel", "year","week")) %>% 
  
  ungroup() 
  

# catch_byweek %>% distinct(species, regulated) %>% filter(is.na(regulated)) %>% View()

top_rectangles <-
  catch_byweek %>%
  group_by(species, rect) %>% 
  summarise(n=n()) %>% 
  group_by(species) %>% 
  arrange(species, desc(n)) %>% 
  filter(n >= 20,  row_number() <= 10)

# top <-
#   catch %>% 
#   dplyr::group_by(species, scientificname, englishname, dutchname) %>% 
#   dplyr::summarize(weight = sum(weight, na.rm=TRUE)) %>% 
#   dplyr::ungroup() %>% 
#   dplyr::mutate(englishspecies = paste(englishname, species)) %>% 
#   arrange(desc(weight)) %>% 
#   slice_head(n=n)

top      <- 
  readr::read_rds(file=file.path(onedrive,"rdata", "top.rds")) %>%  
  lowcase() %>% 
  dplyr::select(-value, -weight)

rest <-
  catch %>% 
  dplyr::group_by(species, scientificname, englishname, dutchname) %>% 
  dplyr::summarize(weight     = sum(weight, na.rm=TRUE)) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(englishspecies = paste(englishname, species)) %>% 
  arrange(desc(weight)) %>% 
  filter(species %notin% top$species)

all <- 
  bind_rows(top, rest, data.frame(englishspecies="Other")) %>% 
  mutate(englishspecies = factor(englishspecies, levels=.$englishspecies))

# top colours
colourCount             <- nrow(top)+1
getPalette              <- colorRampPalette(brewer.pal(12, "Paired"))
myTopColors             <- getPalette(colourCount)
names(myTopColors)      <- c(top$englishspecies, "Other")

# scales::show_col(myTopColors)

# target colours
t1 <- 
  target_byweek %>% 
  ungroup() %>% 
  distinct(target) %>% 
  left_join(bind_rows(top, rest), by=c("target"="species")) %>% 
  arrange(desc(weight)) %>% 
  left_join(as.data.frame(myTopColors) %>% rownames_to_column(var="englishspecies"), 
            by="englishspecies")

t2a <- t1 %>% filter(!is.na(myTopColors))
t2b <- t1 %>% filter(is.na(myTopColors))

colourCount             <- nrow(t2b)
getPalette              <- colorRampPalette(myTopColors[c(length(myTopColors)-1,length(myTopColors))])
myAddedColors           <- getPalette(colourCount)
names(myAddedColors)    <- c(t2b$englishspecies)

myTargetColors          <- c(myTopColors, myAddedColors)
# scales::show_col(myTargetColors)


# year colours
t1                      <- target_byweek %>% ungroup() %>% distinct(year) %>% arrange(year) 
colourCount             <- nrow(t1)
getPalette              <- colorRampPalette(brewer.pal(9, "Greys"))
myYearColors            <- getPalette(colourCount)
myYearColors[colourCount] <- "red"
names(myYearColors)     <- c(t1$year)


# readr::write_rds(top, file=file.path(datadir, paste0("top_",folder,".rds")))
# writexl::write_xlsx(catch_byweek, path=file.path(onedrive, paste0("export",folder,".xlsx")))

```


# FLYSHOOT fishery CPUE analysis in `r paste(sort(unique(catch_byweek$division)), collapse=(", "))`

M.A. Pastoors

Date: `r format(Sys.time(), '%d/%m/%Y')`

&nbsp;

&nbsp;

For: 

Jaczon BV

Eric van Linden en Anton Dekker

Vissershavenweg 35

2583 DK  Den Haag

&nbsp;

&nbsp;

```{r, echo=FALSE, out.width = "200px", fig.align="left", message=FALSE, warning=FALSE, cache=FALSE}

  knitr::include_graphics("../MPFF logo with text.png")

```

\newpage

**Executive summary**

The objective of this work was to analyse the electronic logbook data of the Jaczon Flyshoot vessel for trends in spatial and temporal dynamics. The electronic logbook data for the years 2012-2022 has been compiled. The data contains information on catch and effort per vessel, rectangle, species and day. Average price information by vessel and year has been used to convert landings to revenue. The data was available for the vessels SCH65, SL9, SCH135, Z99 and years 2012-2022. For the years 2012-2016, data was only available for two vessels (SCH65 and SL9). From 2017 onwards, data became available for the SCH135 and the Z99 was added in 2022. The data coverage is not complete. The year 2012 is only covered for the second half of the year and the data for 2015-2017 is also incomplete for some vessels. 

For each year, the proportion of weeks targeting a certain species was calculated. The target species of a vessel-year-week combination was derived by determining the species with the highest revenue for each vessel-year-week combination. Then the number of vessel-year-week-target combinations were counted and expresses as percentages per year and species. Surmullet (MUR) and European Squid (SQR) have been the main target species during the period considered. The number of Tub gurnard targeted weeks has declined over time. Since 2018 the contribution of targeted trips on Common Cuttlefish (CTC) has strongly increased.


\newpage

# Introduction

The objective of this work is to analyse the electronic logbook data of the Jaczon Flyshoot vessels for trends in spatial and temporal dynamics for the different target species. The electronic logbook data contains total landings by day, by species and by ICES rectangle. For the current analysis, only the data for divisions 27.7.d and 27.7.e have been used. 

Electronic logbook data is a requirement from fisheries authorities to document the composition of the landings. While this information is officially reported to the respective government, the information is also kept on the fishing vessels and stored in the electronic logbook systems. During the period 2012 - 2022, electronic logbook data was initially stored in the OLRAC software, later into versions 2.0 and 3.3 of E-Catch and from 2018 onwards in the PEFA software and M-Catch software. The old data, prior to 2018, has been retrieved from backups held on the vessels and were converted into usable formats using dedicated R-codes (https://github.com/martinpastoors/flyshoot/R/read_olrac.r and https://github.com/martinpastoors/flyshoot/R/read_ecatch.r ). The data from 2018 onwards could be exported from the current electronic logbook systems and have been added to the internal database.  

Average price information per species was available from all landings of Jaczon flyshoot vessels during the years 2012-2022. We derived the top species for the flyshoot fishery (in the Channel and the North Sea) by calculating the value of the catch per species over the whole period from the multiplication of catch by year with the average price per year. We then selected the 15 species with the highest overall value.  

\newpage

# Material and methods

Electronic logbook data was available for the vessels `r paste(unique(e$vessel), collapse=", ")` and years  `r paste(c(min(yrs), max(yrs)), collapse="-")`. For the years 2012-2016, data was only available for two vessels (SCH65 and SL9), from 2017 onwards, data became available for the SCH135 and the Z99 was added in 2022. 

**Fishing effort by vessel**

The number of fishing days by vessel and year (top), and by vessel, year and quarter (bottom) demonstrates that the data coverage is not complete. The year 2012 is only covered for the second half of the year and the data for 2015-2017 is also incomplete for some vessels. From 2018 onwards, the effort data covers around 500 fishing days per year.  

```{r effort1, echo=FALSE, message=FALSE, warning=FALSE, comment=NA, fig.asp=1.0}

fig_nums(
  name    = "effort1", 
  level = 1, display = FALSE,
  caption = "Total number of fishing days per vessel and year (top) and by vessel, year and quarter (bottom)")


# by year
p1 <-
  effort %>% 
  ggplot(aes(x=year, y=ndays)) +
  theme_publication() +
  theme(plot.margin = margin(2,2,2,5, "mm")) +
  theme(legend.position = "none") +
  geom_bar(aes(fill=vessel), stat="identity") + 
  scale_fill_brewer(palette = "Paired") +
  ylab(NULL) +
  scale_x_continuous(breaks=seq(min(effort$year), max(effort$year),1))

# by quarter
p2 <-
  e %>% 
  group_by(vessel, year, quarter) %>% 
  summarize(ndays = n_distinct(paste(vessel, date))) %>% 

  ggplot(aes(x=quarter, y=ndays)) +
  theme_publication() +
  theme(plot.margin = margin(2,2,2,5, "mm")) +
  geom_bar(aes(fill=vessel), stat="identity") + 
  scale_fill_brewer(palette = "Paired") +
  scale_x_continuous(breaks=seq(1,12,1)) +
  ylab(NULL) +
  facet_grid(vessel~year)

# Combine the plots
gridExtra::grid.arrange(p1, p2, left = "Effort (days)", ncol=1, heights=c(10,20)) 

```

_`r fig_nums("effort1")`_

\newpage

**Total landings by vessel and year**

From the electronic logbook data, landings by species and vessel can be derived. It should be noted that there is no data available on the total catches, because the logbooks only contain the landed catch. The landings per vessel, show the same gaps in coverage as shown for the effort data. Landings from 2018 onwards, have been between 1000 and 1500 tonnes. 

```{r catch1, echo=FALSE, message=FALSE, warning=FALSE, comment=NA, fig.asp=1.2}

fig_nums(
  name    = "catch1", 
  level = 1, display = FALSE,
  caption = "Total landings (tonnes) per vessel and year (top) and by vessel, year and quarter (bottom)")

my_colors <- RColorBrewer::brewer.pal(12, "Paired")[5:8]

# by year
p1 <-
  catch_byweek %>% 
  group_by(vessel, year) %>% 
  summarise(catch = sum(catch, na.rm=TRUE)) %>% 
  mutate(catch = catch/1000) %>% 
  
  ggplot(aes(x=year, y=catch)) +
  theme_publication() +
  theme(legend.position = "none") +
  theme(plot.margin = margin(2,2,2,5, "mm")) +
  geom_bar(aes(fill=vessel), stat="identity") + 
  scale_fill_manual(values = my_colors) +
  ylab(NULL) +
  scale_x_continuous(breaks=seq(min(effort$year), max(effort$year),1))

# by quarter
p2 <-
  catch_byweek %>% 
  group_by(vessel, year, quarter) %>% 
  summarise(catch = sum(catch, na.rm=TRUE)) %>% 
  mutate(catch = catch/1000) %>% 

  ggplot(aes(x=quarter, y=catch)) +
  theme_publication() +
  theme(plot.margin = margin(2,2,2,5, "mm")) +
  # theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  geom_bar(aes(fill=vessel), stat="identity") + 
  scale_fill_manual(values = my_colors) +
  scale_x_continuous(breaks=seq(1,4,1)) +
  ylab(NULL) +
  facet_grid(vessel~year)

gridExtra::grid.arrange(p1, p2, left = "Landings (tonnes)", ncol=1, heights=c(10,20)) 

```

_`r fig_nums("catch1")`_

\newpage

**Total landings by species and year**

The top `r n` species in the overall flyshoot landings are shown in the figure below, together with a mixed grouping of species (OTHER). The proportions of the landings by species, show some clear patterns in targeting of certain species over certain years, for example the increase and decrease of European Squid (SQR) and the increased focus on Common cuttlefish (CTC) in the recent years. 
 
```{r catch3a, echo=FALSE, message=FALSE, warning=FALSE, comment=NA, fig.asp=0.6}

fig_nums(
  name    = "catch3a", 
  level = 1, display = FALSE,
  caption = paste0("Total landings per species and year (top ",n," species)"))

t <-
  catch_byweek %>% 
  mutate(englishspecies = paste(englishname, species)) %>% 
  mutate(englishspecies = ifelse(species %notin% top$species, "Other", englishspecies)) %>% 
  mutate(englishspecies = factor(englishspecies, 
                                  levels=c("Other", rev(top$englishspecies)))) %>% 
  group_by(englishspecies, year) %>% 
  summarise(catch = sum(catch, na.rm=TRUE)) %>% 
  mutate(catch = catch/1000) 
  
colourCount = n+1
getPalette = colorRampPalette(rev(brewer.pal(12, "Paired")))

p1 <-
  t %>% 
  # filter(regulated == "NR") %>% 
  ggplot(aes(x=year, y=catch)) +
  theme_publication() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  theme(plot.margin = margin(1,1,1,1, "mm")) +
  theme(plot.title = element_text(hjust = 0.0)) +
  geom_bar(aes(fill=englishspecies), stat="identity") + 
  
  scale_fill_manual(values = myTopColors) +
  # scale_fill_manual(values = getPalette(colourCount)) +
  guides(fill = guide_legend(order = 2)) +
  scale_x_continuous(breaks=seq(min(catch_byweek$year), max(catch_byweek$year),1)) +
  labs(y="Landings (tonnes)", title="Landings by species", x="",fill="") 

p2 <-
  t %>% 
  # filter(regulated == "NR") %>% 
  ggplot(aes(x=year, y=catch)) +
  theme_publication() +
  theme(legend.position = "right", legend.direction="vertical") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  theme(plot.margin = margin(1,1,1,1, "mm")) +
  theme(plot.title = element_text(hjust = 0.0)) +
  # geom_bar(aes(fill=englishspecies), stat="identity") + 
  geom_bar(aes(fill=englishspecies), stat="identity", position=position_fill()) + 
  
  scale_fill_manual(values = myTopColors) +
  # scale_fill_manual(values = getPalette(colourCount)) +
  guides(fill = guide_legend(order = 2)) +
  scale_x_continuous(breaks=seq(min(catch_byweek$year), max(catch_byweek$year),1)) +
  scale_y_continuous(labels=scales::percent) +
  labs(y="", title="Proportions of landings by species", x="",fill="") 

print( p1 +  p2   + plot_layout(widths = c(11, 11) ))

png(filename=file.path(figuresdir, "landings by species.png"),
     width=12.5, height=5.5, units="in", res=300, bg="transparent")
print( p1 +  p2   + 
         plot_layout(widths = c(11, 11) ) + 
         theme(plot.background = element_blank()) +
         theme(panel.background = element_blank())) 
invisible(dev.off())

```

_`r fig_nums("catch3a")`_

\newpage

**Proportion of the landings per species and quarter (top 15 species)**

There are large differences in the proportions of species per quarter due to different availability and targeting. 

```{r catch4, echo=FALSE, message=FALSE, warning=FALSE, comment=NA, fig.asp=0.6}

fig_nums(
  name    = "catch4", 
  level = 1, display = FALSE,
  caption = "Proportion of the catch per quarter and year (top 15 species)")

# colourCount = n+1
# getPalette = colorRampPalette(rev(brewer.pal(12, "Paired")))

t <-
  catch_byweek %>% 
  mutate(englishspecies = paste(englishname, species)) %>% 
  mutate(englishspecies = ifelse(species %notin% top$species, "Other", englishspecies)) %>% 
  mutate(englishspecies = factor(englishspecies, 
                                  levels=c("Other", rev(top$englishspecies)))) %>% 
  mutate(englishspecies = factor(englishspecies, 
                                  levels=c("Other", rev(top$englishspecies)))) %>% 
  group_by(englishspecies, year, quarter) %>% 
  summarise(catch = sum(catch, na.rm=TRUE)) %>% 
  mutate(catch = catch/1000) %>% 
  group_by(year, quarter) %>% 
  mutate(prop = catch/sum(catch)) %>% 
  ungroup()

t %>% 
  ggplot(aes(x=quarter, y=prop)) +
  theme_publication() +
  theme(plot.margin = margin(1,1,1,1, "mm")) +
  theme(legend.position = "right", legend.direction="vertical") +
  geom_bar(aes(fill=englishspecies), stat="identity") + 
  scale_fill_manual(values = myTopColors) +
  # scale_fill_manual(values = getPalette(colourCount)) +
  guides(fill = guide_legend(order = 2)) +
  scale_x_continuous(breaks=seq(1,4,1)) +
  ylab(NULL) +
  facet_wrap(~year, nrow=1)


```

_`r fig_nums("catch4")`_

\newpage

**Total revenue by species and year**

The total revenue by species and year was calculated from the landed catch multiplied by the average price per species and year. The value of the top `r n` species in the landings (and an OTHER category), are shown below, both in kEuro and in proportions. From 2018 onwards, 75% of the value is generated from three species (SQR, MUR, CTC). 
 
```{r catch3b, echo=FALSE, message=FALSE, warning=FALSE, comment=NA, fig.asp=0.6}

fig_nums(
  name    = "catch3b", 
  level = 1, display = FALSE,
  caption = paste0("Total revenue per species and year (top ",n," species)"))

t <-
  catch_byweek %>% 
  mutate(englishspecies = paste(englishname, species)) %>% 
  mutate(englishspecies = ifelse(species %notin% top$species, "Other", englishspecies)) %>% 
  mutate(englishspecies = factor(englishspecies, 
                                  levels=c("Other", rev(top$englishspecies)))) %>% 
  mutate(revenue = catch * avgprice) %>% 
  group_by(englishspecies, year) %>% 
  summarise(revenue = sum(revenue, na.rm=TRUE)) %>% 
  mutate(revenue = revenue/1000) 
  
# colourCount = n+1
# getPalette = colorRampPalette(rev(brewer.pal(12, "Paired")))

p1 <-
  t %>% 
  # filter(regulated == "NR") %>% 
  ggplot(aes(x=year, y=revenue)) +
  theme_publication() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  theme(plot.margin = margin(1,1,1,1, "mm")) +
  theme(plot.title = element_text(hjust = 0.0)) +
  geom_bar(aes(fill=englishspecies), stat="identity") + 
  
  scale_fill_manual(values = myTopColors) +
  # scale_fill_manual(values = getPalette(colourCount)) +
  guides(fill = guide_legend(order = 2)) +
  scale_x_continuous(breaks=seq(min(catch_byweek$year), max(catch_byweek$year),1)) +
  labs(y="Revenue (kEuro)", title="Revenue by species", x="",fill="") 

p2 <-
  t %>% 
  # filter(regulated == "NR") %>% 
  ggplot(aes(x=year, y=revenue)) +
  theme_publication() +
  theme(legend.position = "right", legend.direction="vertical") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  theme(plot.margin = margin(1,1,1,1, "mm")) +
  theme(plot.title = element_text(hjust = 0.0)) +
  # geom_bar(aes(fill=englishspecies), stat="identity") + 
  geom_bar(aes(fill=englishspecies), stat="identity", position=position_fill()) + 
  
  scale_fill_manual(values = myTopColors) +
  # scale_fill_manual(values = getPalette(colourCount)) +
  guides(fill = guide_legend(order = 2)) +
  scale_x_continuous(breaks=seq(min(catch_byweek$year), max(catch_byweek$year),1)) +
  scale_y_continuous(labels=scales::percent) +
  labs(y="", title="Proportions of revenue by species", x="",fill="") 

print( p1 +  p2   + plot_layout(widths = c(10, 11) ))

png(filename=file.path(figuresdir, "revenue by species.png"),
     width=12.5, height=5.5, units="in", res=300, bg="transparent")
print( p1 +  p2   + 
         plot_layout(widths = c(11, 11) ) + 
         theme(plot.background = element_blank()) +
         theme(panel.background = element_blank())) 
invisible(dev.off())

```

_`r fig_nums("catch3b")`_

\newpage

**Percentage of weeks targeting certain species**

For each year, the proportion of weeks targeting a certain species was calculated. The target species of a vessel-year-week combination was derived by determining the species with the highest revenue for each vessel-year-week combination. Then the number of vessel-year-week-target combinations were counted and expresses as percentages per year and species. Surmullet (MUR) and European Squid (SQR) have been the main target species during the period considered. The number of Tub gurnard targeted weeks has declined over time. Since 2018 the contribution of targeted trips on Common Cuttlefish (CTC) has strongly increased. 


```{r catch5, echo=FALSE, message=FALSE, warning=FALSE, comment=NA, fig.asp=0.6}

fig_nums(
  name    = "catch5", 
  level = 1, display = FALSE,
  caption = "Number of weeks targeting certain species (highest value in the catch)")


t <-
  catch_byweek %>% 
  ungroup() %>% 
  distinct(vessel, year, week, target) %>%
  group_by(year, target) %>% 
  summarise(n=n()) %>% 
  group_by(year) %>%
  mutate(prop = n/sum(n, na.rm=TRUE)) %>% 
  left_join(bind_rows(top, rest), by=c("target"= "species")) %>% 
  drop_na(englishspecies) %>% 
  # mutate(englishspecies = factor(englishspecies, levels=levels(all$englishspecies)))
  mutate(englishspecies = factor(englishspecies, 
                                  levels=rev(all$englishspecies))) 

# colourCount = levels(t$englishspecies)
# getPalette = colorRampPalette(rev(brewer.pal(12, "Paired")))

pp <-
  t %>% 
  ggplot(aes(x=year, y=prop)) +
  theme_publication() +
  theme(plot.margin = margin(2,2,2,5, "mm")) +
  theme(legend.position = "right", legend.direction="vertical") +
  geom_bar(aes(fill=englishspecies), stat="identity") + 
  scale_fill_manual(values = myTargetColors) +
  guides(fill = guide_legend(order = 2)) +
  scale_x_continuous(breaks=seq(min(t$year),max(t$year),1)) +
  scale_y_continuous(labels=scales::percent) +
  labs(y="proportion of targeted weeks", x="", fill="Target species") 

print(pp)

png(filename=file.path(figuresdir, "proportion of targeted weeks.png"),
     width=12.5, height=5.5, units="in", res=300, bg="transparent")
print( pp   + 
         theme(plot.background = element_blank()) +
         theme(panel.background = element_blank())) 
invisible(dev.off())

```

_`r fig_nums("catch5")`_

\newpage

**Average price (Jaczon vessels) by species and year**

The average price per species and year was derived from the sales information by vessel. This demonstrates that there are large differences in price level between species (e.g. compare Seabass BSS with Atlantic horse mackerel HOM), but also that there can be quite different patterns over time (e.g. increasing price for European squid SQR) and decreasing price for Greater weever WEG). 

```{r prices, echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}

fig_nums(
  name    = "prices", 
  level = 1, display = FALSE,
  caption = "Mean prices of Jaczon vessels by species and year")

t <-
  price %>% 
  filter(species %in% top$species) %>%
  left_join(top, by="species") %>% 
  left_join(regulated, by="species") %>% 
  mutate(englishspecies = factor(paste(englishname, species), levels=top$englishspecies)) %>% 
  group_by(regulated, englishspecies, year) %>% 
  summarise(
    price = mean(avgprice, na.rm=TRUE)) %>% 
  ungroup() 

pp <-
  t %>% 
  # filter(regulated == "NR") %>% 
  
  ggplot() +
  theme_publication() +
  theme(plot.margin = margin(2,2,2,5, "mm")) +
  theme(plot.title = element_text(hjust = 0.0)) +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +

  geom_point(aes(x=year, y=price, colour=englishspecies)) +  
  geom_line(aes(x=year, y=price, colour=englishspecies)) +  
  scale_colour_manual(values = myTopColors) +
  # scale_fill_manual(values = getPalette(colourCount)) +
  guides(fill = guide_legend(order = 2)) +
  guides(fill=guide_legend(nrow = 1)) + 
  scale_x_continuous(breaks=seq(min(e$year), max(e$year),1)) +
  labs(x="",y="", title="Average price") +
  facet_wrap(~englishspecies, ncol=4)
  
print(pp)

png(filename=file.path(figuresdir, "prices by species.png"),
     width=12.5, height=5.5, units="in", res=300, bg="transparent")
print( pp   + 
         theme(plot.background = element_blank()) +
         theme(panel.background = element_blank())) 
invisible(dev.off())

```

_`r fig_nums("prices")`_

\newpage

**Average price (Jaczon vessels) against total landings by species (Jaczon vessels)**

To check whether there could be a relationship between landings and price, we plotted the total landings per species against the average price per species. Each dot in the graphs below indicate a specific year. For some species, there appears to be a negative relationship between the amount of landings and the average price (e.g. Surmullet, gurnards and black seabream). European squid and Common cuttlefish suggest a slightly positive relationship between landings and price. 

```{r prices2, echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}

fig_nums(
  name    = "prices2", 
  level = 1, display = FALSE,
  caption = "Mean prices of Jaczon vessels against total landings")

catch_byweek %>% 
  filter(species %in% top$species) %>%   
  mutate(englishspecies = paste(englishname, species)) %>% 
  mutate(englishspecies = factor(englishspecies, levels=top$englishspecies)) %>% 
  group_by(englishspecies, species, year) %>% 
  summarise(catch = sum(catch,na.rm=TRUE)/1000) %>% 
  right_join(price, by=c("year","species")) %>% 
  drop_na(englishspecies) %>% 
  
  ggplot(aes(x=catch, y=avgprice)) +
  theme_publication() +
  theme(legend.position = "none") +
  theme(plot.margin = margin(2,2,2,5, "mm")) +
  geom_point(aes(colour=englishspecies)) +
  geom_smooth(aes(colour=englishspecies), se=FALSE, method="lm", linewidth=0.5) +
  scale_colour_manual(values = myTopColors) +
  expand_limits(x=0, y=0) +
  labs(x="catch (tonnes)") +
  facet_wrap(~englishspecies, scales="free", ncol=4)


```

_`r fig_nums("prices2")`_

\newpage

**Map of total landings by species and ICES rectangle, cumulative over years**

The landings by species and rectangle were summed over all vessels and years and categorized in different bins (square root transformed). The figure below demonstrates the spatial distribution of the landings by species. 

```{r catch6, echo=FALSE, fig.asp=0.8, message=FALSE, warning=FALSE, comment=NA}

fig_nums(
  name    = "catch6", 
  level = 1, display = FALSE,
  caption = "Landings by species, rectangle and year")

t <-
  catch_byweek %>% 
  filter(species %in% top$species) %>%
  mutate(englishspecies = factor(paste(englishname, species), levels=top$englishspecies)) %>% 
  drop_na(catch, lat, lon) %>% 
  group_by(regulated, englishspecies, rect, lat, lon, year) %>% 
  summarise(
    catch = sum(catch, na.rm=TRUE)/1000) %>% 
  ungroup() %>% 
  left_join(rect_lr_sf, by=c("rect"= "ICESNAME")) %>% 
  dplyr::select(-ID, -SOUTH, -NORTH, -WEST, -EAST) %>% 
  
  # mutate(catch_interval = cut(as.integer(catch), breaks=c(1 %o% 10^(0:12)), dig.lab=10 ) ) %>% 
  mutate(., catch_interval = cut(catch, scales::trans_breaks("sqrt", function(x) x ^ 2)(c(0, max(catch, na.rm=TRUE))), 
                               dig.lab=10 ) ) %>% 
  
  tidyr::complete(year, nesting(englishspecies)) %>% 
  sf::st_as_sf()

tmax <- 100*ceiling(max(t$catch, na.rm=TRUE)/100)

# t %>% ungroup() %>% distinct(englishspecies, regulated) %>% View()
# catch_byweek %>% ungroup() %>% distinct(species, regulated) %>% View()

ttt <-
  t %>% 
  sf::st_drop_geometry() %>% 
  group_by(englishspecies) %>% 
  summarise(catch = as.integer(sum(catch, na.rm=TRUE))) %>% 
  arrange(desc(catch)) 

bb <- sf::st_bbox(t)

# p1 <-
  t %>% 
  # filter(regulated == "NR") %>% 
  
  ggplot() +
  theme_publication() +
  theme(plot.margin = margin(1,1,1,1, "mm")) +
  theme(plot.title = element_text(hjust = 0.0)) +
  # theme(legend.position = "none") +
  
  geom_sf(data=world_mr_sf, 
          font = "Arial") +
  geom_sf(aes(fill=catch_interval), 
          font = "Arial") +
  geom_text(data=ttt, 
            aes(x=-Inf, y=Inf, label=paste(catch,"t")), 
            hjust=0, vjust=1) +
  coord_sf(xlim=c(bb$xmin,bb$xmax), ylim=c(bb$ymin, bb$ymax)) + 
  scale_fill_viridis(option = "plasma", direction = -1, discrete=TRUE) +
  guides(fill=guide_legend(nrow = 1)) + 
  labs(x="",y="", title="Landings by rectangle") +
  facet_wrap(~englishspecies, ncol=4)
  

```

_`r fig_nums("catch6")`_

\newpage

**Observed catch rate (landings / week)**

The observed catch rates (as average landings per day) were expressed by year and plotted as box-plot. Note that the extreme values that are sometimes observed, have been removed with the Desctools::Winsorize function whereby all observations larger than the 95th percentile are set to the value at the 95th percentile. The four main target species of the flyshoot fishery, show a stable or slightly increasing trend. Catch rates for gurnards show a decreasing trend as do the catch rates for most of the bycatch species. 

```{r cpue1, echo=FALSE, message=FALSE, warning=FALSE, comment=NA, fig.asp=1.0}

fig_nums(
  name    = "cpue1", 
  level = 1, display = FALSE,
  caption = "CPUE (landings/day, kg) on log-scale. Outliers not shown on the figures. Red dot indicates medians. Blue line is the linear slope through the medians. The slope refers to the slope of the regression line. ")

# catch %>% 
t <-
  e %>% 
  filter(species %in% top$species) %>%
  mutate(englishspecies = paste(englishname, species)) %>% 
  mutate(englishspecies = factor(englishspecies, levels=top$englishspecies)) %>% 
  drop_na(weight) %>% 
  group_by(vessel, englishspecies, year, date) %>% 
  summarise(catch_day = sum(weight, na.rm=TRUE)) %>% 
  ungroup() 

# t %>% distinct(englishspecies, regulated) %>% View()

# remove outliers for display
t2 <-
  t %>% 
  group_by(englishspecies) %>% 
  mutate(catch_day =   DescTools::Winsorize(catch_day, probs=c(0, 0.9)))  
  # mutate(cutoff = quantile(catch_day, na.rm=TRUE, c(0.9))) %>% 
  # mutate(catch_day   = ifelse(catch_day > cutoff, NA, catch_day))

# t2 %>% group_by(test) %>% summarise(n=n())

# median
m <-
  t %>% 
  group_by(englishspecies, year) %>% 
  summarise(median = median(catch_day, na.rm=TRUE))

# slope
s <-
  m %>%
  group_by(englishspecies) %>%
  summarise(slope = scales::percent(lm(year ~ median)$coefficients[2], accuracy=1)) 

pp <-
  t2 %>%   
  # filter(regulated =="NR") %>% 
  
  ggplot(aes(x=year, y=catch_day, group=year)) +
  theme_publication() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  theme(plot.margin = margin(1,1,1,1, "mm")) +
  theme(plot.title = element_text(hjust = 0.0)) +
  
  stat_summary(fun.data = calc_boxplot_stat, geom="boxplot") +  
  geom_point(data=m, 
             aes(x=year, y=median), 
             colour="red", inherit.aes = FALSE) +
  geom_smooth(data=m, 
              aes(x=year, y=median), 
              method="lm", colour="blue", inherit.aes = FALSE, se=FALSE) +
  geom_text(data=s, 
            aes(x=-Inf, y=1, label=paste("slope:", slope)), 
            inherit.aes = FALSE, hjust="left", vjust="bottom", colour="blue") +
  
  expand_limits(y=0) +
  scale_x_continuous(breaks=seq(min(e$year), max(e$year),1)) +
  scale_y_log10() +
  labs(x="", y="landings/day (kg)", title="Average landings per day") +
  facet_wrap(~englishspecies, ncol=4)

print(pp)

png(filename=file.path(figuresdir, "average landings per day.png"),
     width=12.5, height=5.5, units="in", res=300, bg="transparent")
print( pp   + 
         facet_wrap(~englishspecies, ncol=5) +
         theme(plot.background = element_blank()) +
         theme(panel.background = element_blank())) 
invisible(dev.off())


```

_`r fig_nums("cpue1")`_

\newpage

**Average revenue rate (revenue / day) per vessel and quarter**

The average revenue rate (revenue per day) per vessel and quarter was calculated based on the value of the catch per day, summed over all species. Revenue rates are highest in the first and fourth quarters. Highest revenue rates are observed in 2016 and 2017 (but based on few observations) and in the fourth quarter of 2022.   

```{r obsrevenue, echo=FALSE, message=FALSE, warning=FALSE, comment=NA, fig.asp=1.0}

fig_nums(
  name    = "obsrevenue", 
  level = 1, display = FALSE,
  caption = "Average revenue per day by vessel and quarter. Red dot indicates medians.")

  
# revenue %>% 
t <-
  catch_byweek %>% 
  mutate(revenue = catch * avgprice) %>% 
  group_by(vessel, year, quarter, week) %>% 
  summarise(revenue = sum(revenue, na.rm=TRUE)) %>% 
  left_join(effort_byweek2, by=c("vessel", "year","week")) %>% 
  mutate(revenue_day = revenue / effort) %>% 
  ungroup() 

# t %>% distinct(englishspecies, regulated) %>% View()
# e %>% filter(vessel == "SCH135", year==2017, week==38) %>% mutate(date2=format(date, format="%a %m/%d/%Y")) %>% View()

# median
m <-
  t %>% 
  group_by(vessel, year, quarter) %>% 
  summarise(median = median(revenue_day, na.rm=TRUE))


pp <-
  t %>%   

  ggplot(aes(x=year, y=revenue_day, group=year)) +
  theme_publication() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  theme(plot.margin = margin(1,1,1,1, "mm")) +
  theme(plot.title = element_text(hjust = 0.0)) +
  
  stat_summary(fun.data = calc_boxplot_stat, geom="boxplot") +  
  geom_point(data=m, 
             aes(x=year, y=median), 
             colour="red", inherit.aes = FALSE) +
  expand_limits(y=0) +
  scale_x_continuous(breaks=seq(min(e$year), max(e$year),1)) +
  # scale_y_log10() +
  labs(x="", y="revenue/day (euro)", title="Average revenue per day") +
  facet_grid(vessel~quarter)
  
print(pp)

png(filename=file.path(figuresdir, "average revenue per day.png"),
     width=12.5, height=5.5, units="in", res=300, bg="transparent")
print( pp   + 
         plot_layout(widths = c(11, 11) ) + 
         theme(plot.background = element_blank()) +
         theme(panel.background = element_blank())) 
invisible(dev.off())


```

_`r fig_nums("obsrevenue")`_

\newpage

\newpage

Cumulatieve anvoer per soort, per jaar en per week. Rode lijn is het lopende jaar. 

```{r echo=FALSE, message=FALSE, warning=FALSE, comment=NA, fig.asp=1.0}

ee <- 
  e %>%
  filter(species %in% top$species) %>% 
  group_by(species, year, week) %>% 
  summarise(landingweight = sum(weight, na.rm=TRUE)) %>% 
  group_by(species, year) %>% 
  mutate(cumweight = cumsum(landingweight)) %>% 
  mutate(year = as.character(year)) %>% 
  mutate(species = factor(species, levels=top$species))

nyrs <- length(yrs)
c(seq(1,nyrs-1,1)/20, 1.0)

# plot total catch and landings
ee %>% 
  ggplot() +
  theme_publication() +
  # theme(legend.position = "none") +
  geom_line(aes(x=week, y=cumweight, colour=year, linewidth=year)) +
  scale_linewidth_manual("year", values = c(seq(1,nyrs-1,1)/20, 1.0), guide = "none") +
  scale_colour_manual(values=myYearColors) +
  guides(colour = guide_legend(nrow = 1)) +
  facet_wrap(~species, scales="free_y")
  # facet_grid(rows=vars(year), cols=vars(species), scales="free_y")



```



\newpage

# Discussion

The objective of this work was to analyse the electronic logbook data of the Jaczon Flyshoot vessel for trends in spatial and temporal dynamics. The electronic logbook data for the years 2012-2022 has been compiled. The data contains information on catch and effort per vessel, rectangle, species and day. Average price information by vessel and year has been used to convert landings to revenue.  

An overview of the available data has been presented in the Material and Methods section. The data was available for the vessels SCH65, SL9, SCH135, Z99 and years 2012-2022. For the years 2012-2016, data was only available for two vessels (SCH65 and SL9). From 2017 onwards, data became available for the SCH135 and the Z99 was added in 2022. The data coverage is not complete. The year 2012 is only covered for the second half of the year and the data for 2015-2017 is also incomplete for some vessels. 

For each year, the proportion of weeks targeting a certain species was calculated. The target species of a vessel-year-week combination was derived by determining the species with the highest revenue for each vessel-year-week combination. Then the number of vessel-year-week-target combinations were counted and expresses as percentages per year and species. Surmullet (MUR) and European Squid (SQR) have been the main target species during the period considered. The number of Tub gurnard targeted weeks has declined over time. Since 2018 the contribution of targeted trips on Common Cuttlefish (CTC) has strongly increased.



