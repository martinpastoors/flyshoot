---
output:
  word_document:
    reference_docx: ../report_template.dotx
---


```{r setup, include=FALSE}

# =====================================================================================================
# FLYSHOOT CPUE analysis - North Sea and Channel without modelling
# 
# 11/01/2023 first coding
# 16/03/2023 full GLM modelling of top 15 species in the catch
# 21/04/2023 TO DO: convert totals to total per vessel
# 09/05/2023 Finalized the code to include the reworked Ecatch and Mcatch data (previously problem with number of days)
# 05/12/2023 Removed modelling part
# 06/12/2023 Added total removal part
# =====================================================================================================

knitr::opts_chunk$set(echo = FALSE,	message = FALSE,	warning = FALSE,	comment = "",	crop = TRUE )
knitr::opts_chunk$set(fig.width=10) 

options(dplyr.summarise.inform = FALSE)

# Reset lists
rm(list=ls())

recalculatemaps   <- TRUE            # recalculate catch maps (takes relatively long)
toprectanglesonly <- TRUE            # CPUE analysis for top rectangles (by species) only?

# Libraries
library(rmarkdown)                   # note: requires knitr 1.21

require(tidyverse, quietly=TRUE)     # combined package of dplyr, tidyr, ggplot, readr, purrr and tibble
require(lubridate, quietly=TRUE)     # data handling
require(reshape2, quietly=TRUE)      # reshaping data; e.g. cast
require(RColorBrewer)                # colour schemes
library(viridis)
library(pander)
library(patchwork)
library(gridExtra)
library(ggrepel)

library(captioner)                   # for captions
tab_nums <- captioner::captioner(prefix = "Table " , levels=1, type=c("n"), infix=".")
fig_nums <- captioner::captioner(prefix = "Figure ", levels=1, type=c("n"), infix=".")

# Source all the utils
# source("../../prf/R/my utils.r")
# source("../../mptools/R/get_onedrive.r")
source("../R/FLYSHOOT utils.r")


spatialdir <- "C:/DATA/RDATA"

# spatial data files

load(file.path(spatialdir, "world_lr_sf.RData"))
load(file.path(spatialdir, "world_mr_sf.RData"))
load(file.path(spatialdir, "world_hr_sf.RData"))

load(file.path(spatialdir, "world_mr_df.RData"))
load(file.path(spatialdir, "fao_sf.RData"))
load(file.path(spatialdir, "rect_lr_sf.RData"))
icesrect <-
  rect_lr_sf %>% 
  sf::st_drop_geometry() %>% 
  rename(rect=ICESNAME) %>% 
  mutate(lat = (SOUTH + NORTH)/2) %>% 
  mutate(lon = (EAST + WEST)/2) %>% 
  dplyr::select(rect, lat, lon)


asfis <- 
  loadRData(file.path(spatialdir, "asfis.RData")) %>% 
  rename_all(tolower) %>% 
  mutate(species = tolower(species))

# ===============================================================================
#  Load and filter the trip data
# ===============================================================================

# set onedrive directory
onedrive <- get_onedrive(team="Martin Pastoors", site="FLYSHOOT - General")

# load datasets
haul   <- 
  loadRData(file.path(onedrive, "rdata/haul.RData")) %>%   
  mutate(vessel = ifelse(vessel %in% c("SCH99","Z99"), "SCH99_Z99", vessel)) 

kisten <- 
  loadRData(file.path(onedrive, "rdata/kisten.RData")) %>%   
  mutate(vessel = ifelse(vessel %in% c("SCH99","Z99"), "SCH99_Z99", vessel)) 

elog   <- 
  loadRData(file.path(onedrive, "rdata/elog.RData")) %>% 
  mutate(species = toupper(species)) %>% 
  mutate(species = ifelse(species == "JAX","HOM",species)) %>% 
  mutate(species = ifelse(species == "SQU", "SQR", species)) %>% 
  filter(geartype %in% c("SSC","SDN")) %>% 
  mutate(species = tolower(species)) %>% 
  left_join(dplyr::select(asfis,
                          species, scientificname, englishname, dutchname),
            by = "species") %>% 
  mutate(species = toupper(species))  %>% 
  mutate(vessel = ifelse(vessel %in% c("SCH99","Z99"), "SCH99_Z99", vessel)) %>% 
  
  # remove 348 records without rectangle information
  drop_na(rect) %>% 
  
  sf::st_as_sf(coords = c("lon", "lat"), crs = 4326, remove = FALSE)  %>%  
  
  # get division from rectangle / lat-lon if available
  sf::st_join(filter(fao_sf, F_LEVEL=="DIVISION")) %>%
  sf::st_drop_geometry() %>% 
  rename(division = F_CODE) %>% 
  dplyr::select(-F_LEVEL, -FID, -OCEAN, -SUBOCEAN, -F_AREA, -F_SUBAREA, -F_DIVISION,
                -F_SUBDIVIS, -F_SUBUNIT, -F_STATUS) %>%
  ungroup() %>% 
  
  # handle missing divisions (coastline issues)
  mutate(division = ifelse(is.na(division) & !is.na(faozone), faozone, division))

# skimr::skim(elog)

# datasets with price and regulated information derived from read_afslag.r
# source("../R/read_afslag.r")
price  <- 
  readr::read_rds(file.path(onedrive, "rdata/prices.rds")) %>% 
  dplyr::select(year, species, avgprice) %>% 
  mutate(price_cat = cut(avgprice, breaks=c(0,0.5, 1,2,3,4,5,10,15,20), dig.lab=10 ))

regulated  <- 
  readr::read_rds(file.path(onedrive, "rdata/prices.rds")) %>% 
  ungroup() %>% 
  dplyr::distinct(species, regulated) 

# skimr::skim(price)

yrs       <- 2014:2024
mnths     <- NA
# vessels   <- "SL9"
# vessels   <- "SCH65"
# vessels   <- "SCH135"
vessels   <- c("SCH99_Z99")

# divisions <- NA
# divisions <- c("27.7.d", "27.7.e") # fix error in division 4.a
# divisions <- c("27.4.b", "27.4.c")
divisions <- c("27.4.b", "27.4.c", "27.7.d","27.7.e")

myareas <- ifelse(!any(is.na(divisions)), 
                  paste(divisions, collapse=", "),
                  paste(sort(unique(elog$division)), collapse=", ")
                  )


# making the data selections
e <- 
  elog %>%
  ungroup() %>% 
  mutate(division =tolower(division)) %>% 
  {if(!any(is.na(vessels))) filter(., vessel %in% vessels) else . } %>% 
  {if(!any(is.na(yrs)))     filter(., year %in% yrs) else . } %>% 
  {if(!any(is.na(mnths)))   filter(., month %in% mnths) else .} %>% 
  {if(!any(is.na(divisions))) filter(., division %in% divisions) else .} %>% 

  mutate(englishname = ifelse(englishname=="European pilchard(=Sardine)", "European pilchard", englishname)) %>% 
  
  left_join(regulated, by="species") %>% 
  mutate(regulated = case_when(
    is.na(regulated) & species %in% c("BSE","DGX","ANF","DGH","HER","PLE")             ~ "R",
    is.na(regulated) & species %in% c("BRB","SBX","SQS","WEX","WEG","SQU","SDV",
                                      "OCT","MUL","SCR","GAG","ANE","SQE","SQC","OCZ") ~ "NR",
    TRUE ~ regulated
  )) %>% 
  ungroup()

h <- 
  haul %>%
  ungroup() %>% 
  mutate(division =tolower(division)) %>% 
  {if(!any(is.na(vessels))) filter(., vessel %in% vessels) else . } %>% 
  {if(!any(is.na(yrs)))     filter(., year %in% yrs) else . } %>% 
  {if(!any(is.na(mnths)))   filter(., month %in% mnths) else .} %>% 
  {if(!any(is.na(divisions))) filter(., division %in% divisions) else .} %>% 
  ungroup()

# Folder for storing figures  
folder <- paste("FLYSHOOT", 
                paste(vessels, collapse="_"),
                paste(
                  min(e$year, na.rm=TRUE),
                  max(e$year, na.rm=TRUE),
                  sep="-"),
                paste0(year(now()), 
                       stringr::str_pad(month(now()), width=2, pad="0"), 
                       stringr::str_pad(  day(now()), width=2, pad="0") ))

dir.create   (file.path(onedrive, "report",folder), showWarnings = FALSE)

dir.create   (file.path(onedrive, "report",folder, "figures"), showWarnings = FALSE)
figuresdir <- file.path(onedrive, "report",folder, "figures")

dir.create  (file.path(onedrive, "report",folder, "tables"), showWarnings = FALSE)
tablesdir <- file.path(onedrive, "report",folder, "tables")

dir.create   (file.path(onedrive, "report",folder, "data"), showWarnings = FALSE)
datadir    <- file.path(onedrive, "report",folder, "data")


# calculate the scaling of plots

xmin <- floor(2 * (min(e$lon, na.rm=TRUE)-0.5))/2;
xmax <- ceiling(2 * (max(e$lon, na.rm=TRUE)+0.5))/2;
ymin <- floor(2 * (min(e$lat, na.rm=TRUE)-0.5))/2;
ymax <- ceiling(2* (max(e$lat, na.rm=TRUE)+0.5))/2

n <- 15

effort <-
  e %>% 
  dplyr::group_by(vessel, year, week, source) %>% 
  dplyr::summarize(ndays = n_distinct(date)) %>% 
  
  dplyr::group_by(vessel, year) %>% 
  dplyr::summarize(ndays  = sum(ndays, na.rm=TRUE))  %>% 

  ungroup()

catch <-
  e %>% 
  dplyr::group_by(vessel, year, species, 
                  scientificname, englishname, dutchname, regulated) %>% 
  dplyr::summarize(weight = sum(weight, na.rm=TRUE)) %>% 
  dplyr::group_by(vessel, year) %>% 
  dplyr::mutate(perc = weight/sum(weight, na.rm=TRUE)) %>% 
  left_join(effort, by=c("vessel", "year")) %>% 
  mutate(catch_day = weight / ndays) %>% 
  ungroup()

revenue <-
  e %>% 
  left_join(price, by=c("year","species")) %>% 
  mutate(revenue = weight * avgprice) %>% 
  drop_na(revenue) %>% 
  group_by(vessel, year) %>% 
  summarise(revenue = sum(revenue, na.rm=TRUE)) %>% 
  ungroup()

effort_byweek <-
  e %>% 
  dplyr::group_by(vessel, year, quarter, month, week, division, rect, source) %>% 
  dplyr::summarize(effort  = n_distinct(date))  %>% 
  
  # temp fix!!
  mutate(effort = ifelse(source=="m-catch" & year < 2023, 4, effort)) %>% 
  dplyr::group_by(vessel, year, quarter, month, week, division, rect) %>% 
  dplyr::summarize(effort  = sum(effort, na.rm=TRUE))  %>% 
  left_join(icesrect, by="rect") %>% 
  ungroup()

effort_byweek2 <-
  e %>% 
  dplyr::group_by(vessel, year, week, source) %>% 
  dplyr::summarize(effort  = n_distinct(date))  %>% 
  
  # temp fix!!
  mutate(effort = ifelse(source=="m-catch" & year < 2023, NA, effort)) %>% 
  dplyr::group_by(vessel, year, week) %>% 
  dplyr::summarize(effort  = sum(effort, na.rm=TRUE))  %>% 

  ungroup()

revenue_byweek <-
  e %>% 
  left_join(price, by=c("year","species")) %>% 
  mutate(revenue = weight * avgprice) %>% 
  drop_na(revenue) %>% 
  group_by(vessel, year, quarter, week, rect, division, species, scientificname, englishname, dutchname, regulated) %>% 
  summarise(revenue = sum(revenue, na.rm=TRUE)) %>% 
  left_join(icesrect, by="rect") %>% 
  ungroup()
    
target_byweek <-
  revenue_byweek %>% 
  group_by(vessel, year, week, species) %>%
  summarise(revenue = sum(revenue, na.rm=TRUE)) %>% 
  group_by(vessel, year, week) %>% 
  arrange(desc(revenue)) %>% 
  slice_head(n=1) %>% 
  dplyr::select(-revenue) %>% 
  rename(target=species)

catch_byweek <-
  e %>% 
  dplyr::group_by(vessel, year, quarter, month, week, division, rect,  
                  species, scientificname, englishname, dutchname, regulated) %>% 
  dplyr::summarize(
    catch = sum(weight, na.rm=TRUE),
    # effort  = n_distinct(date)
  ) %>% 
  left_join(dplyr::select(effort_byweek,
                          -lat, -lon), 
            by=c("vessel","year","quarter","month","week","division","rect")) %>% 
  left_join(icesrect, by="rect") %>% 
  left_join(price, by=c("year","species")) %>% 
  left_join(target_byweek, by=c("vessel", "year","week")) %>% 
  
  ungroup() 
  

# catch_byweek %>% distinct(species, regulated) %>% filter(is.na(regulated)) %>% View()

top_rectangles <-
  catch_byweek %>%
  group_by(species, rect) %>% 
  summarise(n=n()) %>% 
  group_by(species) %>% 
  arrange(species, desc(n)) %>% 
  filter(n >= 20,  row_number() <= 10)

# top <-
#   catch %>% 
#   dplyr::group_by(species, scientificname, englishname, dutchname) %>% 
#   dplyr::summarize(weight = sum(weight, na.rm=TRUE)) %>% 
#   dplyr::ungroup() %>% 
#   dplyr::mutate(englishspecies = paste(englishname, species)) %>% 
#   arrange(desc(weight)) %>% 
#   slice_head(n=n)

# get top species from "FLYSHOOT top species.R"
# source("../R/FLYSHOOT top species.r")
top      <- 
  readr::read_rds(file=file.path(onedrive,"rdata", "top.rds")) %>%  
  lowcase() %>% 
  dplyr::select(-value, -weight)

rest <-
  catch %>% 
  dplyr::group_by(species, scientificname, englishname, dutchname) %>% 
  dplyr::summarize(weight     = sum(weight, na.rm=TRUE)) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(englishspecies = paste(englishname, species)) %>% 
  arrange(desc(weight)) %>% 
  filter(species %notin% top$species)

all <- 
  bind_rows(top, rest, data.frame(englishspecies="Other")) %>% 
  mutate(englishspecies = factor(englishspecies, levels=.$englishspecies))

# top colours
colourCount             <- nrow(top)+1
getPalette              <- colorRampPalette(brewer.pal(12, "Paired"))
myTopColors             <- getPalette(colourCount)
names(myTopColors)      <- c(top$englishspecies, "Other")

# scales::show_col(myTopColors)

# target colours
t1 <- 
  target_byweek %>% 
  ungroup() %>% 
  distinct(target) %>% 
  left_join(bind_rows(top, rest), by=c("target"="species")) %>% 
  arrange(desc(weight)) %>% 
  left_join(as.data.frame(myTopColors) %>% rownames_to_column(var="englishspecies"), 
            by="englishspecies")

t2a <- t1 %>% filter(!is.na(myTopColors))
t2b <- t1 %>% filter(is.na(myTopColors))

colourCount             <- nrow(t2b)
getPalette              <- colorRampPalette(myTopColors[c(length(myTopColors)-1,length(myTopColors))])
myAddedColors           <- getPalette(colourCount)
names(myAddedColors)    <- c(t2b$englishspecies)

myTargetColors          <- c(myTopColors, myAddedColors)
# scales::show_col(myTargetColors)


# year colours
t1                      <- target_byweek %>% ungroup() %>% distinct(year) %>% arrange(year) 
colourCount             <- nrow(t1)
getPalette              <- colorRampPalette(brewer.pal(9, "Greys")[3:9])
myYearColors            <- getPalette(colourCount)
myYearColors[colourCount] <- "red"
names(myYearColors)     <- c(t1$year)


# readr::write_rds(top, file=file.path(datadir, paste0("top_",folder,".rds")))
# writexl::write_xlsx(catch_byweek, path=file.path(onedrive, paste0("export",folder,".xlsx")))

```


# FLYSHOOT fishery analysis for `r vessels`: `r min(e$year, na.rm=TRUE)`-`r max(e$year, na.rm=TRUE)`

Analysis based on electronic logbook data

&nbsp;

M.A. Pastoors

Date: `r format(Sys.time(), '%d/%m/%Y')`

&nbsp;

&nbsp;

&nbsp;

&nbsp;

```{r, echo=FALSE, out.width = "100px", fig.align="left", message=FALSE, warning=FALSE, cache=FALSE}

  knitr::include_graphics("../MPFF logo with text.png")

```

\newpage

**Introduction**

The objective of this work is to analyse the electronic logbook data of the `r vessels` for trends in spatial and temporal dynamics for the different target species. The electronic logbook data contains total landings by day, by species and by ICES rectangle. For the current analysis, data for divisions `r paste(sort(unique(catch_byweek$division)), collapse=(", "))` and years  `r paste(c(min(yrs), max(yrs)), collapse="-")` have been used. 

Electronic logbook data is a requirement from fisheries authorities to document the composition of the landings. While this information is officially reported to the respective government, the information is also kept on the fishing vessels and stored in the electronic logbook systems. Electronic logbook data was initially stored in the OLRAC software, later into versions 2.0 and 3.3 of E-Catch and from 2018 onwards in the PEFA and M-Catch software. The old data, prior to 2018, has been retrieved from backups held on the vessels and were converted into usable formats using dedicated R-codes (https://github.com/martinpastoors/flyshoot/R/read_olrac.r and https://github.com/martinpastoors/flyshoot/R/read_ecatch.r ). The data from 2018 onwards could be exported from the current electronic logbook systems and have been added to the internal database.  

Average price information per species was available from all landings of Jaczon flyshoot vessels during the years `r yrs[1]`-`r yrs[length(yrs)]`. We derived the top species for the flyshoot fishery (in the Channel and the North Sea) by calculating the value of the catch per species over the whole period from the multiplication of catch by year with the average price per year (from the participating flyshoot vessels). We then selected the 15 species with the highest overall value.  

**Fishing effort (days) by division and year**

Fishing effort (days) by division and expressed as the percentage by division for each year. 

```{r effort1, echo=FALSE, fig.asp=1.1, message=FALSE, warning=FALSE, comment=NA}

effort_byweek %>% 
  drop_na(effort, lat, lon) %>% 
  group_by(year, division) %>% 
  summarise(effort = sum(effort, na.rm=TRUE))  %>% 
  reshape2::dcast(division ~ year, sum, value.var = "effort", margins=TRUE) %>% 
  pander::pandoc.table(
    style = "simple",
    split.tables=400, 
    justify = "right",
    missing=".",
    round=c(0))

effort_byweek %>% 
  drop_na(effort, lat, lon) %>% 
  group_by(year, division) %>% 
  summarise(effort = sum(effort, na.rm=TRUE))  %>% 
  group_by(year) %>% 
  mutate(perc = effort/sum(effort) ) %>% 
  mutate(perc = paste0(round(100*perc, digits=0),"%") ) %>% 
  dplyr::select(-effort) %>% 
  tidyr::pivot_wider(names_from = year, values_from = perc) %>% 
  pander::pandoc.table(
    style = "simple",
    split.tables=400, 
    justify = "right",
    missing=".",
    round=c(0))

```


```{r effort2, echo=FALSE, fig.asp=1.1, message=FALSE, warning=FALSE, comment=NA}

fig_nums(
  name    = "effort2", 
  level = 1, display = FALSE,
  caption = "Effort (days) by ICES rectangle and year")

t <-
  effort_byweek %>% 
  drop_na(effort, lat, lon) %>% 
  group_by(rect, lat, lon, year) %>% 
  summarise(effort = sum(effort, na.rm=TRUE)) %>% 
  
  left_join(rect_lr_sf, by=c("rect"= "ICESNAME")) %>% 
  dplyr::select(-ID, -SOUTH, -NORTH, -WEST, -EAST) %>%
  
  ungroup() %>% 
  
  # mutate(catch_interval = cut(as.integer(catch), breaks=c(1 %o% 10^(0:12)), dig.lab=10 ) ) %>% 
  mutate(., effort_interval = cut(effort, scales::trans_breaks("sqrt", function(x) x ^ 2)(c(0, max(effort, na.rm=TRUE))), 
                               dig.lab=10 ) ) %>% 
  
  sf::st_as_sf()

tmax <- 100*ceiling(max(t$effort, na.rm=TRUE)/100)

ttt <-
  t %>% 
  sf::st_drop_geometry() %>% 
  group_by(year) %>% 
  summarise(effort = as.integer(sum(effort, na.rm=TRUE))) %>% 
  arrange(desc(effort)) 

bb <- sf::st_bbox(t)

# p1 <-
  t %>% 
  # filter(regulated == "NR") %>% 
  
  ggplot() +
  theme_publication() +
  theme(plot.margin = margin(1,1,1,1, "mm")) +
  theme(plot.title = element_text(hjust = 0.0)) +
  # theme(legend.position = "none") +
  
  geom_sf(data=world_mr_sf, 
          font = "Arial") +
  geom_sf(aes(fill=effort_interval), 
          font = "Arial") +
  geom_text(data=ttt, 
            aes(x=Inf, y=Inf, label=paste(effort,"days")), 
            hjust=1, vjust=1) +
  coord_sf(xlim=c(bb$xmin,bb$xmax), ylim=c(bb$ymin, bb$ymax)) + 
  scale_fill_viridis(option = "plasma", direction = -1, discrete=TRUE) +
  guides(fill=guide_legend(nrow = 1)) + 
  labs(x="",y="", title="Effort (days) by rectangle") +
  facet_wrap(~year, ncol=4)
  

```

_`r fig_nums("effort2")`_

\newpage

**Total landings by division and year**

Total landings (tons) by division and expressed as the percentage by division for each year. 

```{r catch1, echo=FALSE, fig.asp=1.1, message=FALSE, warning=FALSE, comment=NA}

catch_byweek %>% 
  drop_na(effort, lat, lon) %>% 
  group_by(year, division) %>% 
  summarise(catch = sum(catch, na.rm=TRUE))  %>% 
  mutate(catch = catch/1000) %>% 
  reshape2::dcast(division ~ year, sum, value.var = "catch", margins=TRUE) %>% 
  pander::pandoc.table(
    style = "simple",
    split.tables=400, 
    justify = "right",
    missing=".",
    round=c(0))

catch_byweek %>% 
  drop_na(effort, lat, lon) %>% 
  group_by(year, division) %>% 
  summarise(catch = sum(catch, na.rm=TRUE))  %>% 
  group_by(year) %>% 
  mutate(perc = catch/sum(catch) ) %>% 
  mutate(perc = paste0(round(100*perc, digits=0),"%") ) %>% 
  dplyr::select(-catch) %>% 
  tidyr::pivot_wider(names_from = year, values_from = perc) %>% 
  pander::pandoc.table(
    style = "simple",
    split.tables=400, 
    justify = "right",
    missing=".",
    round=c(0))

```


The landings by species and rectangle were summed over all vessels and years and categorized in different bins (square root transformed). The figure below demonstrates the spatial distribution of the landings by species. 

```{r catch2, echo=FALSE, fig.asp=1.1, message=FALSE, warning=FALSE, comment=NA}

fig_nums(
  name    = "catch2", 
  level = 1, display = FALSE,
  caption = "Landings by ICES rectangle and year")

t <-
  catch_byweek %>% 
  drop_na(catch, lat, lon) %>% 
  group_by(rect, lat, lon, year) %>% 
  summarise(
    catch = sum(catch, na.rm=TRUE)/1000) %>% 
  ungroup() %>% 
  left_join(rect_lr_sf, by=c("rect"= "ICESNAME")) %>% 
  dplyr::select(-ID, -SOUTH, -NORTH, -WEST, -EAST) %>% 
  
  # mutate(catch_interval = cut(as.integer(catch), breaks=c(1 %o% 10^(0:12)), dig.lab=10 ) ) %>% 
  mutate(., catch_interval = cut(catch, scales::trans_breaks("sqrt", function(x) x ^ 2)(c(0, max(catch, na.rm=TRUE))), 
                               dig.lab=10 ) ) %>% 
  
  sf::st_as_sf()

tmax <- 100*ceiling(max(t$catch, na.rm=TRUE)/100)

# t %>% ungroup() %>% distinct(englishspecies, regulated) %>% View()
# catch_byweek %>% ungroup() %>% distinct(species, regulated) %>% View()

ttt <-
  t %>% 
  sf::st_drop_geometry() %>% 
  group_by(year) %>% 
  summarise(catch = as.integer(sum(catch, na.rm=TRUE))) %>% 
  arrange(desc(catch)) 

bb <- sf::st_bbox(t)

# p1 <-
  t %>% 
  # filter(regulated == "NR") %>% 
  
  ggplot() +
  theme_publication() +
  theme(plot.margin = margin(1,1,1,1, "mm")) +
  theme(plot.title = element_text(hjust = 0.0)) +
  # theme(legend.position = "none") +
  
  geom_sf(data=world_mr_sf, 
          font = "Arial") +
  geom_sf(aes(fill=catch_interval), 
          font = "Arial") +
  geom_text(data=ttt, 
            aes(x=Inf, y=Inf, label=paste(catch,"t")), 
            hjust=1, vjust=1) +
  coord_sf(xlim=c(bb$xmin,bb$xmax), ylim=c(bb$ymin, bb$ymax)) + 
  scale_fill_viridis(option = "plasma", direction = -1, discrete=TRUE) +
  guides(fill=guide_legend(nrow = 1)) + 
  labs(x="",y="", title="Landings by rectangle (ton)") +
  facet_wrap(~year, ncol=4)
  

```

_`r fig_nums("catch2")`_


\newpage

**Total landings by species and year**

The top `r n` species in the overall flyshoot landings are shown in the figure below, together with a mixed grouping of species (OTHER). The proportions of the landings by species, show some clear patterns in targeting of certain species over certain years, for example the increase and decrease of European Squid (SQR) and the increased focus on Common cuttlefish (CTC) in the recent years. 
 
```{r catchbyspecies1, echo=FALSE, message=FALSE, warning=FALSE, comment=NA, fig.asp=0.6}

fig_nums(
  name    = "catchbyspecies1", 
  level = 1, display = FALSE,
  caption = paste0("Total landings per species and year (top ",n," species)"))

t <-
  catch_byweek %>% 
  mutate(englishspecies = paste(englishname, species)) %>% 
  mutate(englishspecies = ifelse(species %notin% top$species, "Other", englishspecies)) %>% 
  mutate(englishspecies = factor(englishspecies, 
                                  levels=c("Other", rev(top$englishspecies)))) %>% 
  group_by(englishspecies, year) %>% 
  summarise(catch = sum(catch, na.rm=TRUE)) %>% 
  mutate(catch = catch/1000) 
  
colourCount = n+1
getPalette = colorRampPalette(rev(brewer.pal(12, "Paired")))

p1 <-
  t %>% 
  # filter(regulated == "NR") %>% 
  ggplot(aes(x=year, y=catch)) +
  theme_publication() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  theme(plot.margin = margin(1,1,1,1, "mm")) +
  theme(plot.title = element_text(hjust = 0.0)) +
  geom_bar(aes(fill=englishspecies), stat="identity") + 
  
  scale_fill_manual(values = myTopColors) +
  # scale_fill_manual(values = getPalette(colourCount)) +
  guides(fill = guide_legend(order = 2)) +
  scale_x_continuous(breaks=seq(min(catch_byweek$year), max(catch_byweek$year),1)) +
  labs(y="Landings (tonnes)", title="Landings by species", x="",fill="") 

p2 <-
  t %>% 
  # filter(regulated == "NR") %>% 
  ggplot(aes(x=year, y=catch)) +
  theme_publication() +
  theme(legend.position = "right", legend.direction="vertical") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  theme(plot.margin = margin(1,1,1,1, "mm")) +
  theme(plot.title = element_text(hjust = 0.0)) +
  # geom_bar(aes(fill=englishspecies), stat="identity") + 
  geom_bar(aes(fill=englishspecies), stat="identity", position=position_fill()) + 
  
  scale_fill_manual(values = myTopColors) +
  # scale_fill_manual(values = getPalette(colourCount)) +
  guides(fill = guide_legend(order = 2)) +
  scale_x_continuous(breaks=seq(min(catch_byweek$year), max(catch_byweek$year),1)) +
  scale_y_continuous(labels=scales::percent) +
  labs(y="", title="Proportions of landings by species", x="",fill="") 

print( p1 +  p2   + plot_layout(widths = c(11, 11) ))

png(filename=file.path(figuresdir, "landings by species.png"),
     width=12.5, height=5.5, units="in", res=300, bg="transparent")
print( p1 +  p2   + 
         plot_layout(widths = c(11, 11) ) + 
         theme(plot.background = element_blank()) +
         theme(panel.background = element_blank())) 
invisible(dev.off())

```

_`r fig_nums("catchbyspecies1")`_

\newpage

**Cumulative landings (ton) by species, year and week**

```{r catchbyspecies2, echo=FALSE, message=FALSE, warning=FALSE, comment=NA, fig.asp=1.0}

fig_nums(
  name    = "catchbyspecies2", 
  level = 1, display = FALSE,
  caption = paste0("Cumulative landings per species, year and week (top ",n," species)"))

ee <- 
  e %>%
  filter(species %in% top$species) %>% 
  group_by(species, year, week) %>% 
  summarise(landingweight = sum(weight, na.rm=TRUE)) %>% 
  group_by(species, year) %>% 
  mutate(cumweight = cumsum(landingweight)) %>% 
  mutate(year = as.character(year)) %>% 
  mutate(species = factor(species, levels=top$species))

nyrs <- length(unique(ee$year))

# plot total catch and landings
ee %>% 
  # filter(year == 2022) %>% 
  
  ggplot() +
  theme_publication() +
  # theme(legend.position = "none") +
  geom_line(aes(x=week, y=cumweight, colour=year, linewidth=year)) +
  scale_linewidth_manual("year", values = c(rep(0.5,nyrs-1), 1.0), guide = "none") +
  # scale_linewidth_manual("year", values = c(seq(1,nyrs-1,1)/10, 1.0), guide = "none") +
  scale_colour_manual(values=myYearColors) +
  guides(colour = guide_legend(nrow = 1)) +
  facet_wrap(~species, scales="free_y")
  # facet_grid(rows=vars(year), cols=vars(species), scales="free_y")



```

_`r fig_nums("catchbyspecies2")`_

\newpage

**Total revenue by division and year**

Total revenue (kEuro) by division and expressed as the percentage by division for each year. 

```{r revenue1, echo=FALSE, fig.asp=1.1, message=FALSE, warning=FALSE, comment=NA}

revenue_byweek %>% 
  drop_na(revenue, lat, lon) %>% 
  group_by(year, division) %>% 
  summarise(revenue = sum(revenue, na.rm=TRUE))  %>% 
  mutate(revenue = revenue/1000) %>% 
  reshape2::dcast(division ~ year, sum, value.var = "revenue", margins=TRUE) %>% 
  pander::pandoc.table(
    style = "simple",
    split.tables=400, 
    justify = "right",
    missing=".",
    round=c(0))

revenue_byweek %>% 
  drop_na(revenue, lat, lon) %>% 
  group_by(year, division) %>% 
  summarise(revenue = sum(revenue, na.rm=TRUE))  %>% 
  group_by(year) %>% 
  mutate(perc = revenue/sum(revenue) ) %>% 
  mutate(perc = paste0(round(100*perc, digits=0),"%") ) %>% 
  dplyr::select(-revenue) %>% 
  tidyr::pivot_wider(names_from = year, values_from = perc) %>% 
  pander::pandoc.table(
    style = "simple",
    split.tables=400, 
    justify = "right",
    missing=".",
    round=c(0))

```


```{r revenue2, echo=FALSE, fig.asp=1.1, message=FALSE, warning=FALSE, comment=NA}

fig_nums(
  name    = "revenue2", 
  level = 1, display = FALSE,
  caption = "Revenue by ICES rectangle and year")

t <-
  revenue_byweek %>% 
  drop_na(revenue, lat, lon) %>% 
  group_by(rect, lat, lon, year) %>% 
  summarise(revenue = sum(revenue, na.rm=TRUE)) %>% 
  mutate(revenue = revenue/1000) %>% 
  ungroup() %>% 
  left_join(rect_lr_sf, by=c("rect"= "ICESNAME")) %>% 
  dplyr::select(-ID, -SOUTH, -NORTH, -WEST, -EAST) %>% 
  
  # mutate(catch_interval = cut(as.integer(catch), breaks=c(1 %o% 10^(0:12)), dig.lab=10 ) ) %>% 
  mutate(., revenue_interval = cut(revenue, scales::trans_breaks("sqrt", function(x) x ^ 2)(c(0, max(revenue, na.rm=TRUE))), 
                               dig.lab=10 ) ) %>% 
  
  sf::st_as_sf()

tmax <- 100*ceiling(max(t$revenue, na.rm=TRUE)/100)

# t %>% ungroup() %>% distinct(englishspecies, regulated) %>% View()
# catch_byweek %>% ungroup() %>% distinct(species, regulated) %>% View()

ttt <-
  t %>% 
  sf::st_drop_geometry() %>% 
  group_by(year) %>% 
  summarise(revenue = as.integer(sum(revenue, na.rm=TRUE))) %>% 
  arrange(desc(revenue)) 

bb <- sf::st_bbox(t)

# p1 <-
  t %>% 
  # filter(regulated == "NR") %>% 
  
  ggplot() +
  theme_publication() +
  theme(plot.margin = margin(1,1,1,1, "mm")) +
  theme(plot.title = element_text(hjust = 0.0)) +
  # theme(legend.position = "none") +
  
  geom_sf(data=world_mr_sf, 
          font = "Arial") +
  geom_sf(aes(fill=revenue_interval), 
          font = "Arial") +
  geom_text(data=ttt, 
            aes(x=Inf, y=Inf, label=paste(revenue,"kEuro")), 
            hjust=1, vjust=1) +
  coord_sf(xlim=c(bb$xmin,bb$xmax), ylim=c(bb$ymin, bb$ymax)) + 
  scale_fill_viridis(option = "plasma", direction = -1, discrete=TRUE) +
  guides(fill=guide_legend(nrow = 1)) + 
  labs(x="",y="", title="Revenue by rectangle (kEuro)") +
  facet_wrap(~year, ncol=4)
  

```

_`r fig_nums("revenue2")`_


\newpage

**Total revenue by species and year**

The total revenue by species and year was calculated from the landed catch multiplied by the average price per species and year. The value of the top `r n` species in the landings (and an OTHER category), are shown below, both in kEuro and in proportions. From 2018 onwards, 75% of the value is generated from three species (SQR, MUR, CTC). 
 
```{r catch3b, echo=FALSE, message=FALSE, warning=FALSE, comment=NA, fig.asp=0.6}

fig_nums(
  name    = "catch3b", 
  level = 1, display = FALSE,
  caption = paste0("Total revenue per species and year (top ",n," species)"))

t <-
  revenue_byweek %>% 
  # catch_byweek %>% 
  mutate(englishspecies = paste(englishname, species)) %>%
  mutate(englishspecies = ifelse(species %notin% top$species, "Other", englishspecies)) %>%
  mutate(englishspecies = factor(englishspecies,
                                  levels=c("Other", rev(top$englishspecies)))) %>%
  
  # mutate(revenue = catch * avgprice) %>% 
  group_by(englishspecies, year) %>% 
  summarise(revenue = sum(revenue, na.rm=TRUE)) %>% 
  mutate(revenue = revenue/1000) 
  
# colourCount = n+1
# getPalette = colorRampPalette(rev(brewer.pal(12, "Paired")))

p1 <-
  t %>% 
  # filter(regulated == "NR") %>% 
  ggplot(aes(x=year, y=revenue)) +
  theme_publication() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  theme(plot.margin = margin(1,1,1,1, "mm")) +
  theme(plot.title = element_text(hjust = 0.0)) +
  geom_bar(aes(fill=englishspecies), stat="identity") + 
  
  scale_fill_manual(values = myTopColors) +
  # scale_fill_manual(values = getPalette(colourCount)) +
  guides(fill = guide_legend(order = 2)) +
  scale_x_continuous(breaks=seq(min(catch_byweek$year), max(catch_byweek$year),1)) +
  labs(y="Revenue (kEuro)", title="Revenue by species", x="",fill="") 

p2 <-
  t %>% 
  # filter(regulated == "NR") %>% 
  ggplot(aes(x=year, y=revenue)) +
  theme_publication() +
  theme(legend.position = "right", legend.direction="vertical") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  theme(plot.margin = margin(1,1,1,1, "mm")) +
  theme(plot.title = element_text(hjust = 0.0)) +
  # geom_bar(aes(fill=englishspecies), stat="identity") + 
  geom_bar(aes(fill=englishspecies), stat="identity", position=position_fill()) + 
  
  scale_fill_manual(values = myTopColors) +
  # scale_fill_manual(values = getPalette(colourCount)) +
  guides(fill = guide_legend(order = 2)) +
  scale_x_continuous(breaks=seq(min(catch_byweek$year), max(catch_byweek$year),1)) +
  scale_y_continuous(labels=scales::percent) +
  labs(y="", title="Proportions of revenue by species", x="",fill="") 

print( p1 +  p2   + plot_layout(widths = c(10, 11) ))

png(filename=file.path(figuresdir, "revenue by species.png"),
     width=12.5, height=5.5, units="in", res=300, bg="transparent")
print( p1 +  p2   + 
         plot_layout(widths = c(11, 11) ) + 
         theme(plot.background = element_blank()) +
         theme(panel.background = element_blank())) 
invisible(dev.off())

```

_`r fig_nums("catch3b")`_

\newpage

**Percentage of weeks targeting certain species**

For each year, the proportion of weeks targeting a certain species was calculated. The target species of a vessel-year-week combination was derived by determining the species with the highest revenue for each vessel-year-week combination. Then the number of vessel-year-week-target combinations were counted and expressed as percentages per year and species.  


```{r catch5, echo=FALSE, message=FALSE, warning=FALSE, comment=NA, fig.asp=0.6}

fig_nums(
  name    = "catch5", 
  level = 1, display = FALSE,
  caption = "Number of weeks targeting certain species (highest value in the catch)")


t <-
  catch_byweek %>% 
  ungroup() %>% 
  distinct(vessel, year, week, target) %>%
  group_by(year, target) %>% 
  summarise(n=n()) %>% 
  group_by(year) %>%
  mutate(prop = n/sum(n, na.rm=TRUE)) %>% 
  left_join(bind_rows(top, rest), by=c("target"= "species")) %>% 
  drop_na(englishspecies) %>% 
  # mutate(englishspecies = factor(englishspecies, levels=levels(all$englishspecies)))
  mutate(englishspecies = factor(englishspecies, 
                                  levels=rev(all$englishspecies))) 

# colourCount = levels(t$englishspecies)
# getPalette = colorRampPalette(rev(brewer.pal(12, "Paired")))

pp <-
  t %>% 
  ggplot(aes(x=year, y=prop)) +
  theme_publication() +
  theme(plot.margin = margin(2,2,2,5, "mm")) +
  theme(legend.position = "right", legend.direction="vertical") +
  geom_bar(aes(fill=englishspecies), stat="identity") + 
  scale_fill_manual(values = myTargetColors) +
  guides(fill = guide_legend(order = 2)) +
  scale_x_continuous(breaks=seq(min(t$year),max(t$year),1)) +
  scale_y_continuous(labels=scales::percent) +
  labs(y="proportion of targeted weeks", x="", fill="Target species") 

print(pp)

png(filename=file.path(figuresdir, "proportion of targeted weeks.png"),
     width=12.5, height=5.5, units="in", res=300, bg="transparent")
print( pp   + 
         theme(plot.background = element_blank()) +
         theme(panel.background = element_blank())) 
invisible(dev.off())

```

_`r fig_nums("catch5")`_

\newpage

**Observed catch rate (landings / week)**

```{r cpue1, echo=FALSE, message=FALSE, warning=FALSE, comment=NA, fig.asp=1.0}

fig_nums(
  name    = "cpue1", 
  level = 1, display = FALSE,
  caption = "CPUE (landings/day, kg) on log-scale. Outliers not shown on the figures. Red dot indicates medians. Blue line is the linear slope through the medians. The slope refers to the slope of the regression line. ")

# catch %>% 
t <-
  e %>% 
  filter(species %in% top$species) %>%
  mutate(englishspecies = paste(englishname, species)) %>% 
  mutate(englishspecies = factor(englishspecies, levels=top$englishspecies)) %>% 
  drop_na(weight) %>% 
  group_by(vessel, englishspecies, year, date) %>% 
  summarise(catch_day = sum(weight, na.rm=TRUE)) %>% 
  ungroup() 

# t %>% distinct(englishspecies, regulated) %>% View()

# remove outliers for display
t2 <-
  t %>% 
  group_by(englishspecies) %>% 
  mutate(catch_day =   DescTools::Winsorize(catch_day, probs=c(0, 0.9)))  
  # mutate(cutoff = quantile(catch_day, na.rm=TRUE, c(0.9))) %>% 
  # mutate(catch_day   = ifelse(catch_day > cutoff, NA, catch_day))

# t2 %>% group_by(test) %>% summarise(n=n())

# median
m <-
  t %>% 
  group_by(englishspecies, year) %>% 
  summarise(median = median(catch_day, na.rm=TRUE))

# slope
s <-
  m %>%
  group_by(englishspecies) %>%
  summarise(slope = scales::percent(lm(year ~ median)$coefficients[2], accuracy=1)) 

pp <-
  t2 %>%   
  # filter(regulated =="NR") %>% 
  
  ggplot(aes(x=year, y=catch_day, group=year)) +
  theme_publication() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  theme(plot.margin = margin(1,1,1,1, "mm")) +
  theme(plot.title = element_text(hjust = 0.0)) +
  
  stat_summary(fun.data = calc_boxplot_stat, geom="boxplot") +  
  geom_point(data=m, 
             aes(x=year, y=median), 
             colour="red", inherit.aes = FALSE) +
  geom_smooth(data=m, 
              aes(x=year, y=median), 
              method="lm", colour="blue", inherit.aes = FALSE, se=FALSE) +
  geom_text(data=s, 
            aes(x=Inf, y=1, label=paste("slope:", slope)), 
            inherit.aes = FALSE, hjust="left", vjust="bottom", colour="blue") +
  
  expand_limits(y=0) +
  scale_x_continuous(breaks=seq(min(e$year), max(e$year),1)) +
  scale_y_log10() +
  labs(x="", y="landings/day (kg)", title="Average landings per day") +
  facet_wrap(~englishspecies, ncol=4)

print(pp)

png(filename=file.path(figuresdir, "average landings per day.png"),
     width=12.5, height=5.5, units="in", res=300, bg="transparent")
print( pp   + 
         facet_wrap(~englishspecies, ncol=5) +
         theme(plot.background = element_blank()) +
         theme(panel.background = element_blank())) 
invisible(dev.off())


```

_`r fig_nums("cpue1")`_

\newpage

# Overview by species

<!-- Prepare the detailed results --> 

```{r detailed, echo=FALSE, fig.asp=1.4, message=FALSE, warning=FALSE, comment=NA}

sp <- top$englishspecies[1]

# run by species
for (sp in top$englishspecies[1:5]) {

  sp2 <- filter(top, englishspecies==sp) %>% dplyr::select(species) %>% as.character()
  reg <- filter(regulated, species==sp2) %>% dplyr::select(regulated) %>% as.character()

  # ----------------------------------------------------------------------------
  # landings map
  # ----------------------------------------------------------------------------
  
  tmap <-
    catch_byweek %>% 
    mutate(englishspecies = paste(englishname, species)) %>% 
    filter(englishspecies == sp) %>%
    group_by(regulated, englishspecies, rect, lat, lon, year) %>% 
    summarise(catch = sum(catch, na.rm=TRUE)/1000) %>% 
    ungroup() %>%
    # mutate(
    #   cpue = catch/effort
    # ) %>% 
    left_join(rect_lr_sf, by=c("rect"= "ICESNAME")) %>% 
    dplyr::select(-ID, -SOUTH, -NORTH, -WEST, -EAST) %>% 
    
    tidyr::complete(year, nesting(englishspecies), fill=list(catch=0.1)) %>% 
    
    # mutate(catch_interval = cut(as.integer(catch), breaks=c(1 %o% 10^(0:12)), dig.lab=10 ) ) %>% 
    mutate(., catch_interval = 
                   cut(catch, 
                       scales::trans_breaks("sqrt", function(x) x ^ 2)(c(0, max(catch, na.rm=TRUE))), 
                       dig.lab=10 ) ) %>% 
    sf::st_as_sf()
  
  # levels / breaks
  lvl <- sort(unique(tmap$catch_interval))

  # bounding box
  bb <- sf::st_bbox(tmap)
  
  tt <-
    tmap %>%
    group_by(regulated, englishspecies, year) %>% 
    summarise(catch = as.integer(sum(catch, na.rm=TRUE))) %>% 
    sf::st_drop_geometry()
  
  p0 <- 
    tmap %>% 
    drop_na() %>% 

    ggplot() +
    theme_publication() +
    theme(plot.margin = margin(1,1,1,1, "mm")) +
    geom_sf(data=world_mr_sf, font = "Arial") +
    geom_sf(aes(fill=catch_interval), font = "Arial", alpha=1.0) +
    # geom_point(aes(size = catch, geometry = geometry), stat = "sf_coordinates", shape=1, font = "Arial") + 
    geom_text(data=tt, 
              aes(x=Inf, y=Inf, label=paste(catch,"ton")), 
              hjust=1, vjust=1) +
    coord_sf(xlim=as.integer(c(bb$xmin,bb$xmax)), ylim=as.integer(c(bb$ymin, bb$ymax))) + 
    scale_fill_viridis(option = "plasma", direction = -1, discrete=TRUE, breaks=lvl, limits=lvl) +
    guides(fill=guide_legend(nrow = 1), size = "none") + 
    labs(x="", y="", 
         title=paste0("Landings (ton): ", sp), 
         fill="landings (ton)") +
    facet_wrap(~year, ncol=3)
    
  jpeg(filename=file.path(figuresdir, paste(sp, "landingsmap.jpg", sep="_")),
       width=10, height=12, units="in", res=300, type = "cairo")
  print(p0)
  invisible(dev.off())
  
  # ----------------------------------------------------------------------------
  # cpue map
  # ----------------------------------------------------------------------------
  
  tmap <-
    catch_byweek %>% 
    mutate(englishspecies = paste(englishname, species)) %>% 
    filter(englishspecies == sp) %>%
    group_by(regulated, englishspecies, rect, lat, lon, year) %>% 
    summarise(
      catch = sum(catch, na.rm=TRUE),
      effort = sum(effort, na.rm=TRUE)
    ) %>% 
    ungroup() %>%
    mutate(
      cpue = catch/effort
    ) %>% 
    left_join(rect_lr_sf, by=c("rect"= "ICESNAME")) %>% 
    dplyr::select(-ID, -SOUTH, -NORTH, -WEST, -EAST) %>% 
    
    tidyr::complete(year, nesting(englishspecies), fill=list(cpue=0.1)) %>% 
    
    # mutate(catch_interval = cut(as.integer(catch), breaks=c(1 %o% 10^(0:12)), dig.lab=10 ) ) %>% 
    mutate(., cpue_interval = 
                   cut(cpue, 
                       scales::trans_breaks("sqrt", function(x) x ^ 2)(c(0, max(cpue, na.rm=TRUE))), 
                       dig.lab=10 ) ) %>% 
    sf::st_as_sf()
  
  # levels / breaks
  lvl <- sort(unique(tmap$cpue_interval))

  # bounding box
  bb <- sf::st_bbox(tmap)
  
  tt <-
    tmap %>%
    group_by(regulated, englishspecies, year) %>% 
    summarise(cpue = as.integer(mean(cpue, na.rm=TRUE))) %>% 
    sf::st_drop_geometry()
  
  p1 <- 
    tmap %>% 
    drop_na() %>% 

    ggplot() +
    theme_publication() +
    theme(plot.margin = margin(1,1,1,1, "mm")) +
    geom_sf(data=world_mr_sf, font = "Arial") +
    geom_sf(aes(fill=cpue_interval), font = "Arial", alpha=0.6) +
    geom_point(aes(size = cpue, geometry = geometry), stat = "sf_coordinates", shape=1, font = "Arial") +
    geom_text(data=tt, 
              aes(x=Inf, y=Inf, label=paste(cpue,"kg/day")), 
              hjust=1, vjust=1) +
    coord_sf(xlim=as.integer(c(bb$xmin,bb$xmax)), ylim=as.integer(c(bb$ymin, bb$ymax))) + 
    scale_fill_viridis(option = "plasma", direction = -1, discrete=TRUE, breaks=lvl, limits=lvl) +
    guides(fill=guide_legend(nrow = 1), size = "none") + 
    labs(x="", y="", 
         title=paste0("Average catch/day (kg): ", sp), 
         fill="CPUE (kg/day)") +
    facet_wrap(~year, ncol=3)
    
  jpeg(filename=file.path(figuresdir, paste(sp, "cpuemap.jpg", sep="_")),
       width=10, height=12, units="in", res=300, type = "cairo")
  print(p1)
  invisible(dev.off())
 

} # end of loop over species

```

<!-- Squid (SQR) --> 

\newpage

```{r echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}
i   <- 1
sp  <- top$englishspecies[i] 
sp2 <- filter(top, englishspecies==sp) %>% dplyr::select(species) %>% as.character()
sp3 <- paste(top$englishname[i], top$dutchname[i], top$species[i], sep=" / ")

knitr::include_graphics(path=file.path(figuresdir, paste(top$englishspecies[[i]], "landingsmap.jpg", sep="_")))

knitr::include_graphics(path=file.path(figuresdir, paste(top$englishspecies[[i]], "cpuemap.jpg", sep="_")))

```

\newpage

```{r echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}
i   <- 2
sp  <- top$englishspecies[i] 
sp2 <- filter(top, englishspecies==sp) %>% dplyr::select(species) %>% as.character()
sp3 <- paste(top$englishname[i], top$dutchname[i], top$species[i], sep=" / ")

knitr::include_graphics(path=file.path(figuresdir, paste(top$englishspecies[[i]], "landingsmap.jpg", sep="_")))

knitr::include_graphics(path=file.path(figuresdir, paste(top$englishspecies[[i]], "cpuemap.jpg", sep="_")))

```

\newpage

```{r echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}
i   <- 3
sp  <- top$englishspecies[i] 
sp2 <- filter(top, englishspecies==sp) %>% dplyr::select(species) %>% as.character()
sp3 <- paste(top$englishname[i], top$dutchname[i], top$species[i], sep=" / ")

knitr::include_graphics(path=file.path(figuresdir, paste(top$englishspecies[[i]], "landingsmap.jpg", sep="_")))

knitr::include_graphics(path=file.path(figuresdir, paste(top$englishspecies[[i]], "cpuemap.jpg", sep="_")))

```

\newpage

```{r echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}
i   <- 4
sp  <- top$englishspecies[i] 
sp2 <- filter(top, englishspecies==sp) %>% dplyr::select(species) %>% as.character()
sp3 <- paste(top$englishname[i], top$dutchname[i], top$species[i], sep=" / ")

knitr::include_graphics(path=file.path(figuresdir, paste(top$englishspecies[[i]], "landingsmap.jpg", sep="_")))

knitr::include_graphics(path=file.path(figuresdir, paste(top$englishspecies[[i]], "cpuemap.jpg", sep="_")))

```

\newpage

```{r echo=FALSE, fig.asp=1.0, message=FALSE, warning=FALSE, comment=NA}
i   <- 5
sp  <- top$englishspecies[i] 
sp2 <- filter(top, englishspecies==sp) %>% dplyr::select(species) %>% as.character()
sp3 <- paste(top$englishname[i], top$dutchname[i], top$species[i], sep=" / ")

knitr::include_graphics(path=file.path(figuresdir, paste(top$englishspecies[[i]], "landingsmap.jpg", sep="_")))

knitr::include_graphics(path=file.path(figuresdir, paste(top$englishspecies[[i]], "cpuemap.jpg", sep="_")))

```
